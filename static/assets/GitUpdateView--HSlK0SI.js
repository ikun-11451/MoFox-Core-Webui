import{ab as O,a as Q,r,G as Y,p as ts,c as t,g as i,m as ls,e as s,t as n,n as T,F,h as z,x as ns,O as os,o as a,_ as ss,P as Cs,N as ks,aI as Gs,aJ as Ts,am as is,aK as xs,aL as Us,aM as Ss,aN as Ds,aO as Is,aP as Bs,Y as as,Z as Rs,f as q,T as gs,w as hs,al as Vs,a1 as us,k as Ms}from"./index-seK3UZHU.js";import{s as H,a as Z,b as S}from"./dialog-CJxjYzKp.js";import"./ConfirmDialog-CcsY9AOv.js";import"./iconify-CkHa40tq.js";function Ls(){return O.get("ui_update/status")}function Ws(){return O.post("ui_update/update")}function Ps(){return O.get("ui_update/backups")}function Ns(B){return O.post("ui_update/rollback",{commit_hash:B})}function Es(B){return O.get(`ui_update/commit/${B}`)}const Fs={class:"ui-update-tab"},zs={key:0,class:"m3-card disabled-card"},Os={class:"disabled-content"},Xs={class:"disabled-text"},As={key:1,class:"m3-card version-card"},Js={key:0,class:"version-info"},Ks={class:"info-row"},Ys={class:"info-value version"},Zs={key:0,class:"info-row"},js={class:"info-value"},qs={key:1,class:"info-row"},Hs={class:"info-value branch"},Qs={key:2,class:"info-row"},se={class:"info-value commit"},ee={key:1,class:"version-info"},ae={key:2,class:"m3-card update-check-card"},te={class:"card-header"},le=["disabled"],ne={key:0,class:"update-result"},oe={key:0,class:"has-update"},ie={class:"update-badge"},ue={key:0,class:"changelog"},de={class:"update-actions"},re=["disabled"],ce={key:1,class:"up-to-date"},ve={key:1,class:"error-message"},me={key:3,class:"m3-card backup-card"},pe={class:"card-header"},_e=["disabled"],fe={key:0,class:"backup-list"},be={class:"backup-info"},ye={class:"backup-header"},ge={class:"backup-commit"},he={key:0,class:"backup-version"},ke={key:1,class:"current-badge"},$e={class:"backup-message"},we={class:"backup-meta"},Ce={class:"backup-actions"},Ge=["onClick","disabled"],Te=["onClick","disabled"],xe={key:1,class:"no-backups"},Ue={class:"detail-dialog"},Se={class:"detail-header"},De={key:0,class:"detail-content"},Ie={class:"detail-section"},Be={class:"detail-row"},Re={class:"detail-value"},Ve={key:0,class:"detail-row"},Me={class:"detail-value version-tag"},Le={class:"detail-row"},We={class:"detail-value"},Pe={key:1,class:"detail-row"},Ne={class:"detail-value"},Ee={key:0,class:"detail-section"},Fe={class:"commit-message"},ze={key:1,class:"detail-section"},Oe={class:"commit-body"},Xe={key:2,class:"detail-section"},Ae={class:"files-list"},Je={class:"file-path"},Ke={key:0,class:"files-more"},Ye={key:1,class:"detail-content loading"},Ze=Q({__name:"UIUpdateTab",emits:["update-complete"],setup(B,{expose:X,emit:v}){const x=v,m=r(null),h=r([]),_=r(!1),k=r(!1),b=r(!1),$=r(!1),C=r(""),D=r(!1),G=r(!1),c=r(null),y=Y(()=>m.value?{version:m.value.current_version||"未安装",build_time:null,branch:m.value.current_branch,commit:m.value.current_commit}:null),U=Y(()=>m.value?m.value.update_enabled===!1:!1),P=Y(()=>m.value?m.value.message?m.value.message:m.value.update_enabled===!1?`当前分支为 "${m.value.current_branch||"未知"}"，更新功能已禁用。仅 webui-dist 分支支持自动更新。`:"":"");function N(f){if(!f)return"-";try{return new Date(f).toLocaleString("zh-CN")}catch{return f}}async function p(){_.value=!0,C.value="";try{const f=await Ls();f.success&&f.data?(m.value=f.data,f.data.success||(C.value=f.data.error||"获取状态失败")):C.value=f.error||"获取状态失败"}catch(f){C.value=f.message||"获取状态失败"}finally{_.value=!1}}async function o(){await p()}async function u(){var l,K;if(await H({title:"确认更新",message:"更新 UI 将刷新页面，是否继续？",confirmText:"更新"})){k.value=!0,C.value="";try{const I=await Ws();I.success&&((l=I.data)!=null&&l.success)?(Z(`更新成功！已更新到 ${I.data.version||"最新版本"}`),x("update-complete",!0)):S(((K=I.data)==null?void 0:K.error)||I.error||"更新失败")}catch(I){S(I.message||"更新失败")}finally{k.value=!1}}}async function L(){var f;$.value=!0;try{const l=await Ps();l.success&&((f=l.data)!=null&&f.data)&&(h.value=l.data.data)}catch(l){console.error("加载备份列表失败:",l)}finally{$.value=!1}}async function R(f){var I,g;const l=f.substring(0,7);if(await H({title:"确认回滚",message:`确定要回滚到版本 "${l}" 吗？此操作将重置到该版本。`,confirmText:"回滚"})){b.value=!0;try{const M=await Ns(f);M.success&&((I=M.data)!=null&&I.success)?(Z(M.data.message||"回滚成功"),x("update-complete",!0)):S(((g=M.data)==null?void 0:g.error)||M.error||"回滚失败")}catch(M){S(M.message||"回滚失败")}finally{b.value=!1}}}async function A(f){D.value=!0,G.value=!0,c.value=null;try{const l=await Es(f);l.success&&l.data?c.value=l.data:(S(l.error||"获取详情失败"),D.value=!1)}catch(l){S(l.message||"获取详情失败"),D.value=!1}finally{G.value=!1}}function es(f){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[f]||""}return ts(()=>{p(),L()}),X({refresh:()=>{p(),L()}}),(f,l)=>{var K,I;return a(),t("div",Fs,[U.value?(a(),t("div",zs,[s("div",Os,[l[3]||(l[3]=s("span",{class:"material-symbols-rounded icon-warning"},"info",-1)),s("div",Xs,[l[2]||(l[2]=s("h4",null,"更新功能已禁用",-1)),s("p",null,n(P.value),1)])])])):i("",!0),U.value?i("",!0):(a(),t("div",As,[l[9]||(l[9]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"web"),s("h3",null,"当前版本")],-1)),y.value?(a(),t("div",Js,[s("div",Ks,[l[4]||(l[4]=s("span",{class:"info-label"},"版本号:",-1)),s("span",Ys,"v"+n(y.value.version),1)]),y.value.build_time?(a(),t("div",Zs,[l[5]||(l[5]=s("span",{class:"info-label"},"构建时间:",-1)),s("span",js,n(N(y.value.build_time)),1)])):i("",!0),y.value.branch?(a(),t("div",qs,[l[6]||(l[6]=s("span",{class:"info-label"},"分支:",-1)),s("span",Hs,n(y.value.branch),1)])):i("",!0),y.value.commit?(a(),t("div",Qs,[l[7]||(l[7]=s("span",{class:"info-label"},"Commit:",-1)),s("code",se,n(y.value.commit.substring(0,8)),1)])):i("",!0)])):(a(),t("div",ee,[...l[8]||(l[8]=[s("p",{class:"no-version"},"未检测到版本信息",-1)])]))])),U.value?i("",!0):(a(),t("div",ae,[s("div",te,[l[10]||(l[10]=s("span",{class:"material-symbols-rounded"},"sync",-1)),l[11]||(l[11]=s("h3",null,"检查更新",-1)),s("button",{class:"m3-button tonal",onClick:o,disabled:_.value||U.value},[s("span",{class:T(["material-symbols-rounded",{spinning:_.value}])},n(_.value?"progress_activity":"refresh"),3),s("span",null,n(_.value?"检查中...":"检查更新"),1)],8,le)]),m.value&&!U.value?(a(),t("div",ne,[m.value.has_update?(a(),t("div",oe,[s("div",ie,[l[12]||(l[12]=s("span",{class:"material-symbols-rounded"},"auto_awesome",-1)),s("span",null,"发现新版本 v"+n(m.value.latest_version),1)]),(K=m.value.changelog)!=null&&K.length?(a(),t("div",ue,[l[13]||(l[13]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),t(F,null,z(m.value.changelog.slice(0,10),(g,M)=>(a(),t("li",{key:M},n(g),1))),128))])])):i("",!0),s("div",de,[s("button",{class:"m3-button filled",onClick:u,disabled:k.value},[s("span",{class:T(["material-symbols-rounded",{spinning:k.value}])},n(k.value?"progress_activity":"download"),3),s("span",null,n(k.value?"更新中...":"立即更新"),1)],8,re)])])):(a(),t("div",ce,[...l[14]||(l[14]=[s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1),s("span",null,"已是最新版本",-1)])]))])):i("",!0),C.value?(a(),t("div",ve,[l[15]||(l[15]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,n(C.value),1)])):i("",!0)])),U.value?i("",!0):(a(),t("div",me,[s("div",pe,[l[16]||(l[16]=s("span",{class:"material-symbols-rounded"},"history",-1)),l[17]||(l[17]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:L,disabled:$.value},[s("span",{class:T(["material-symbols-rounded",{spinning:$.value}])},"refresh",2)],8,_e)]),h.value.length?(a(),t("div",fe,[(a(!0),t(F,null,z(h.value,g=>(a(),t("div",{key:g.commit,class:T(["backup-item",{"is-current":g.is_current}])},[s("div",be,[s("div",ye,[s("code",ge,n(g.commit_short),1),g.version?(a(),t("span",he,"v"+n(g.version),1)):i("",!0),g.is_current?(a(),t("span",ke,"当前")):i("",!0)]),s("span",$e,n(g.message),1),s("span",we,n(N(g.timestamp)),1)]),s("div",Ce,[s("button",{class:"m3-button text",onClick:M=>A(g.commit),disabled:G.value},[...l[18]||(l[18]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,Ge),s("button",{class:"m3-button text",onClick:M=>R(g.commit),disabled:b.value||g.is_current},[...l[19]||(l[19]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,Te)])],2))),128))])):(a(),t("div",xe,[...l[20]||(l[20]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))])),(a(),ls(os,{to:"body"},[D.value?(a(),t("div",{key:0,class:"detail-dialog-overlay",onClick:l[1]||(l[1]=ns(g=>D.value=!1,["self"]))},[s("div",Ue,[s("div",Se,[l[22]||(l[22]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:l[0]||(l[0]=g=>D.value=!1)},[...l[21]||(l[21]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),c.value?(a(),t("div",De,[s("div",Ie,[s("div",Be,[l[23]||(l[23]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",Re,n(c.value.commit_short),1)]),c.value.version?(a(),t("div",Ve,[l[24]||(l[24]=s("span",{class:"detail-label"},"版本:",-1)),s("span",Me,"v"+n(c.value.version),1)])):i("",!0),s("div",Le,[l[25]||(l[25]=s("span",{class:"detail-label"},"时间:",-1)),s("span",We,n(N(c.value.timestamp)),1)]),c.value.author?(a(),t("div",Pe,[l[26]||(l[26]=s("span",{class:"detail-label"},"作者:",-1)),s("span",Ne,n(c.value.author),1)])):i("",!0)]),c.value.message?(a(),t("div",Ee,[l[27]||(l[27]=s("h4",null,"提交消息",-1)),s("p",Fe,n(c.value.message),1)])):i("",!0),c.value.body?(a(),t("div",ze,[l[28]||(l[28]=s("h4",null,"更新内容",-1)),s("pre",Oe,n(c.value.body),1)])):i("",!0),(I=c.value.files_changed)!=null&&I.length?(a(),t("div",Xe,[s("h4",null,"修改文件 ("+n(c.value.files_changed.length)+")",1),s("div",Ae,[(a(!0),t(F,null,z(c.value.files_changed.slice(0,20),(g,M)=>(a(),t("div",{key:M,class:"file-item"},[s("span",{class:T(["file-status",es(g.status)])},n(g.status),3),s("span",Je,n(g.path),1)]))),128)),c.value.files_changed.length>20?(a(),t("div",Ke," ... 及其他 "+n(c.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):G.value?(a(),t("div",Ye,[...l[29]||(l[29]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),je=ss(Ze,[["__scopeId","data-v-da3800a9"]]);function $s(){return O.get("git_env/status")}function qe(){return O.post("git_env/install")}function He(B){return O.post("git_env/set-path",{path:B})}function Qe(){return O.post("git_env/auto-detect")}function sa(){return O.get("git_env/install-guide")}const ea={class:"main-update-tab"},aa={class:"m3-card branch-card"},ta={key:0,class:"loading-placeholder"},la={key:1,class:"card-disabled-hint"},na={key:2,class:"branch-selector"},oa={class:"selected-value"},ia={key:0,class:"m3-select-dropdown m3-card"},ua=["onClick"],da={key:0,class:"material-symbols-rounded check-icon"},ra={key:0,class:"switching-indicator"},ca=["disabled","title"],va={class:"m3-card update-card"},ma={class:"card-header"},pa=["disabled"],_a={key:0,class:"loading-placeholder"},fa={key:1,class:"alert alert-warning"},ba={key:2,class:"alert alert-warning"},ya={key:3,class:"update-result"},ga={key:0,class:"has-update"},ha={class:"update-header"},ka={class:"update-title"},$a={class:"version-compare"},wa={class:"version-box version-current"},Ca={class:"version-box version-latest"},Ga={key:0,class:"changelog"},Ta={class:"update-actions"},xa=["disabled"],Ua={key:1,class:"up-to-date"},Sa={class:"up-to-date-info"},Da={key:0},Ia={key:4,class:"error-message"},Ba={class:"m3-card backup-card"},Ra={class:"card-header"},Va=["disabled"],Ma={key:0,class:"loading-placeholder"},La={key:1,class:"card-disabled-hint"},Wa={key:2,class:"backup-list"},Pa={class:"backup-info"},Na={class:"backup-header"},Ea={class:"backup-commit"},Fa={key:0,class:"current-badge"},za={class:"backup-message"},Oa={class:"backup-meta"},Xa={class:"backup-actions"},Aa=["onClick","disabled"],Ja=["onClick","disabled"],Ka={key:3,class:"no-backups"},Ya={class:"detail-dialog"},Za={class:"detail-header"},ja={key:0,class:"detail-content"},qa={class:"detail-section"},Ha={class:"detail-row"},Qa={class:"detail-value"},st={class:"detail-row"},et={class:"detail-value"},at={key:0,class:"detail-row"},tt={class:"detail-value"},lt={key:0,class:"detail-section"},nt={class:"commit-message"},ot={key:1,class:"detail-section"},it={class:"commit-body"},ut={key:2,class:"detail-section"},dt={class:"files-list"},rt={class:"file-path"},ct={key:0,class:"files-more"},vt={key:1,class:"detail-content loading"},mt=Q({__name:"MainUpdateTab",emits:["update-complete"],setup(B,{expose:X,emit:v}){const x=v,m=r(null),h=r(null),_=r(null),k=r([]),b=r(""),$=r(!1),C=r(!0),D=r(!1),G=r(!1),c=r(!1),y=r(!1),U=r(!1),P=r(!1),N=r(!1),p=r(""),o=r(!1),u=r(null),L=r(null);async function R(){try{const[d,e]=await Promise.all([$s(),Gs()]);d.success&&d.data&&(m.value=d.data),e.success&&e.data&&(h.value=e.data,e.data.current_branch&&(b.value=e.data.current_branch))}catch(d){console.error("加载状态失败:",d)}}function A(){c.value||($.value=!$.value)}async function es(){var d;if(!y.value){y.value=!0;try{const e=await Ts();e.success&&e.data?(h.value=e.data,e.data.current_branch&&(b.value=e.data.current_branch),is("分支列表已刷新","success")):is(((d=e.data)==null?void 0:d.error)||e.error||"刷新分支列表失败","error")}catch(e){is(e.message||"刷新分支列表失败（网络可能不可用）","error")}finally{y.value=!1}}}async function f(d){var J,V;if($.value=!1,!(d===b.value||!await H({title:"切换分支",message:`确定要切换到分支 "${d}" 吗？`,confirmText:"切换"}))){c.value=!0;try{const W=await Ds(d);W.success&&((J=W.data)!=null&&J.success)?(b.value=d,Z(W.data.message||"分支切换成功"),x("update-complete",!0)):S(((V=W.data)==null?void 0:V.error)||W.error||"切换分支失败")}catch(W){S(W.message||"切换分支失败")}finally{c.value=!1}}}async function l(){D.value=!0,p.value="",_.value=null;try{const d=await xs();d.success&&d.data?(_.value=d.data,d.data.success||(p.value=d.data.error||"检查更新失败")):p.value=d.error||"检查更新失败"}catch(d){p.value=d.message||"检查更新失败"}finally{D.value=!1}}async function K(){var e,J;if(await H({title:"确认更新",message:"更新主程序后需要重启才能生效，是否继续？",confirmText:"更新"})){G.value=!0,p.value="";try{const V=await Us(!0,!0,!0);V.success&&((e=V.data)!=null&&e.success)?(Z(V.data.message||"更新成功"),x("update-complete",!0),I()):S(((J=V.data)==null?void 0:J.error)||V.error||"更新失败")}catch(V){S(V.message||"更新失败")}finally{G.value=!1}}}async function I(){var d;P.value=!0;try{const e=await Ss();e.success&&((d=e.data)!=null&&d.data)&&(k.value=e.data.data)}catch(e){console.error("加载历史版本列表失败:",e)}finally{P.value=!1}}async function g(d){var V,W;const e=d.substring(0,7);if(await H({title:"确认回滚",message:`确定要回滚到版本 "${e}" 吗？此操作将重置到该版本，回滚后需要重启程序。`,confirmText:"回滚"})){U.value=!0;try{const E=await Is(d);E.success&&((V=E.data)!=null&&V.success)?(Z(E.data.message||"回滚成功"),x("update-complete",!0),I()):S(((W=E.data)==null?void 0:W.error)||E.error||"回滚失败")}catch(E){S(E.message||"回滚失败")}finally{U.value=!1}}}async function M(d){o.value=!0,N.value=!0,u.value=null;try{const e=await Bs(d);e.success&&e.data?u.value=e.data:(S(e.error||"获取详情失败"),o.value=!1)}catch(e){S(e.message||"获取详情失败"),o.value=!1}finally{N.value=!1}}function ds(d){if(!d)return"-";try{return new Date(d).toLocaleString("zh-CN")}catch{return d}}function ws(d){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[d]||""}function rs(d){L.value&&!L.value.contains(d.target)&&($.value=!1)}return ts(async()=>{var d,e;document.addEventListener("click",rs);try{await R(),I(),(d=m.value)!=null&&d.git_available&&((e=h.value)!=null&&e.is_git_repo)&&l()}finally{C.value=!1}}),Cs(()=>{document.removeEventListener("click",rs)}),X({refresh:()=>{R(),I(),_.value=null}}),(d,e)=>{var J,V,W,E,cs,vs,ms,ps,_s,fs,bs,ys;return a(),t("div",ea,[s("div",aa,[e[6]||(e[6]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"fork_right"),s("h3",null,"分支管理")],-1)),C.value?(a(),t("div",ta,[...e[2]||(e[2]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((J=m.value)!=null&&J.git_available)||(((W=(V=h.value)==null?void 0:V.available_branches)==null?void 0:W.length)??0)===0?(a(),t("div",la,[e[3]||(e[3]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n((E=m.value)!=null&&E.git_available?"无可用分支":"Git 环境不可用"),1)])):(a(),t("div",na,[e[5]||(e[5]=s("label",{class:"m3-label"},"当前分支:",-1)),s("div",{class:"select-wrapper",ref_key:"branchSelectWrapper",ref:L},[s("div",{class:T(["m3-select-trigger",{disabled:c.value,active:$.value}]),onClick:A},[s("span",oa,n(b.value),1),s("span",{class:T(["material-symbols-rounded select-arrow",{rotated:$.value}])}," arrow_drop_down ",2)],2),$.value?(a(),t("div",ia,[(a(!0),t(F,null,z(((cs=h.value)==null?void 0:cs.available_branches)??[],w=>(a(),t("div",{key:w,class:T(["m3-select-option",{selected:w===b.value}]),onClick:j=>f(w)},[s("span",null,n(w),1),w===b.value?(a(),t("span",da,"check")):i("",!0)],10,ua))),128))])):i("",!0)],512),c.value?(a(),t("span",ra,[...e[4]||(e[4]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),ks(" 切换中... ",-1)])])):(a(),t("button",{key:1,class:"m3-icon-button",onClick:es,disabled:y.value,title:y.value?"刷新中...":"刷新远程分支列表"},[s("span",{class:T(["material-symbols-rounded",{spinning:y.value}])},"sync",2)],8,ca))]))]),s("div",va,[s("div",ma,[e[7]||(e[7]=s("span",{class:"material-symbols-rounded"},"sync",-1)),e[8]||(e[8]=s("h3",null,"更新检测",-1)),s("button",{class:"m3-button tonal",onClick:l,disabled:C.value||D.value||!((vs=m.value)!=null&&vs.git_available)},[s("span",{class:T(["material-symbols-rounded",{spinning:D.value}])},n(D.value?"progress_activity":"refresh"),3),s("span",null,n(D.value?"检查中...":"检查更新"),1)],8,pa)]),C.value||D.value?(a(),t("div",_a,[e[9]||(e[9]=s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1)),s("span",null,n(C.value?"加载中...":"检查更新中..."),1)])):m.value&&!m.value.git_available?(a(),t("div",fa,[...e[10]||(e[10]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,'Git 不可用，请先在"Git 设置"中配置 Git 环境',-1)])])):h.value&&!h.value.is_git_repo?(a(),t("div",ba,[...e[11]||(e[11]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,"主程序目录不是 Git 仓库，无法使用自动更新功能",-1)])])):_.value?(a(),t("div",ya,[_.value.has_update?(a(),t("div",ga,[s("div",ha,[e[13]||(e[13]=s("div",{class:"update-icon"},[s("span",{class:"material-symbols-rounded"},"auto_awesome")],-1)),s("div",ka,[e[12]||(e[12]=s("h4",null,"发现新版本",-1)),s("p",null,"有 "+n(_.value.commits_behind)+" 个新提交等待更新",1)])]),s("div",$a,[s("div",wa,[e[14]||(e[14]=s("span",{class:"version-tag"},"当前",-1)),s("code",null,n(_.value.current_commit||"未知"),1)]),e[16]||(e[16]=s("span",{class:"material-symbols-rounded arrow-icon"},"arrow_forward",-1)),s("div",Ca,[e[15]||(e[15]=s("span",{class:"version-tag"},"最新",-1)),s("code",null,n(_.value.remote_commit||"未知"),1)])]),(ms=_.value.update_logs)!=null&&ms.length?(a(),t("div",Ga,[e[17]||(e[17]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),t(F,null,z(_.value.update_logs.slice(0,5),(w,j)=>(a(),t("li",{key:j},n(w),1))),128))])])):i("",!0),s("div",Ta,[s("button",{class:"m3-button filled",onClick:K,disabled:G.value},[s("span",{class:T(["material-symbols-rounded",{spinning:G.value}])},n(G.value?"progress_activity":"download"),3),s("span",null,n(G.value?"更新中...":"立即更新"),1)],8,xa)])])):(a(),t("div",Ua,[e[19]||(e[19]=s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1)),s("div",Sa,[e[18]||(e[18]=s("span",null,"已是最新版本",-1)),_.value.current_commit?(a(),t("code",Da,n(_.value.current_commit),1)):i("",!0)])]))])):i("",!0),p.value?(a(),t("div",Ia,[e[20]||(e[20]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,n(p.value),1)])):i("",!0)]),s("div",Ba,[s("div",Ra,[e[21]||(e[21]=s("span",{class:"material-symbols-rounded"},"history",-1)),e[22]||(e[22]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:I,disabled:C.value||P.value||!((ps=m.value)!=null&&ps.git_available)},[s("span",{class:T(["material-symbols-rounded",{spinning:P.value}])},"refresh",2)],8,Va)]),C.value||P.value?(a(),t("div",Ma,[...e[23]||(e[23]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((_s=m.value)!=null&&_s.git_available)||!((fs=h.value)!=null&&fs.is_git_repo)?(a(),t("div",La,[e[24]||(e[24]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n((bs=m.value)!=null&&bs.git_available?"当前目录非 Git 仓库":"Git 环境不可用"),1)])):k.value.length?(a(),t("div",Wa,[(a(!0),t(F,null,z(k.value,w=>(a(),t("div",{key:w.commit,class:T(["backup-item",{"is-current":w.is_current}])},[s("div",Pa,[s("div",Na,[s("code",Ea,n(w.commit_short),1),w.is_current?(a(),t("span",Fa,"当前")):i("",!0)]),s("span",za,n(w.message),1),s("span",Oa,n(ds(w.timestamp)),1)]),s("div",Xa,[s("button",{class:"m3-button text",onClick:j=>M(w.commit),disabled:N.value},[...e[25]||(e[25]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,Aa),s("button",{class:"m3-button text",onClick:j=>g(w.commit),disabled:U.value||w.is_current},[...e[26]||(e[26]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,Ja)])],2))),128))])):(a(),t("div",Ka,[...e[27]||(e[27]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))]),(a(),ls(os,{to:"body"},[o.value?(a(),t("div",{key:0,class:"detail-dialog-overlay",onClick:e[1]||(e[1]=ns(w=>o.value=!1,["self"]))},[s("div",Ya,[s("div",Za,[e[29]||(e[29]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:e[0]||(e[0]=w=>o.value=!1)},[...e[28]||(e[28]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),u.value?(a(),t("div",ja,[s("div",qa,[s("div",Ha,[e[30]||(e[30]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",Qa,n(u.value.commit_short),1)]),s("div",st,[e[31]||(e[31]=s("span",{class:"detail-label"},"时间:",-1)),s("span",et,n(ds(u.value.timestamp)),1)]),u.value.author?(a(),t("div",at,[e[32]||(e[32]=s("span",{class:"detail-label"},"作者:",-1)),s("span",tt,n(u.value.author),1)])):i("",!0)]),u.value.message?(a(),t("div",lt,[e[33]||(e[33]=s("h4",null,"提交消息",-1)),s("p",nt,n(u.value.message),1)])):i("",!0),u.value.body?(a(),t("div",ot,[e[34]||(e[34]=s("h4",null,"更新内容",-1)),s("pre",it,n(u.value.body),1)])):i("",!0),(ys=u.value.files_changed)!=null&&ys.length?(a(),t("div",ut,[s("h4",null,"修改文件 ("+n(u.value.files_changed.length)+")",1),s("div",dt,[(a(!0),t(F,null,z(u.value.files_changed.slice(0,20),(w,j)=>(a(),t("div",{key:j,class:"file-item"},[s("span",{class:T(["file-status",ws(w.status)])},n(w.status),3),s("span",rt,n(w.path),1)]))),128)),u.value.files_changed.length>20?(a(),t("div",ct," ... 及其他 "+n(u.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):N.value?(a(),t("div",vt,[...e[35]||(e[35]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),pt=ss(mt,[["__scopeId","data-v-b3f12534"]]),_t={class:"git-settings-tab"},ft={class:"m3-card status-card"},bt={class:"card-header"},yt=["disabled"],gt={key:0,class:"status-grid"},ht={class:"status-item"},kt={class:"material-symbols-rounded"},$t={key:0,class:"status-item"},wt={class:"status-value"},Ct={class:"status-item"},Gt={class:"status-value"},Tt={class:"status-item"},xt={class:"status-value"},Ut={key:0,class:"m3-card path-card"},St={class:"path-content"},Dt={class:"path-display"},It={class:"path-value"},Bt={class:"path-actions"},Rt=["disabled"],Vt=["disabled"],Mt={key:0,class:"portable-tip"},Lt={key:2,class:"m3-card guide-card"},Wt={key:0,class:"guide-content"},Pt={key:0,class:"guide-commands"},Nt={class:"command-name"},Et={class:"command-value"},Ft=["href"],zt={class:"modal-content m3-card"},Ot={class:"modal-header"},Xt={class:"modal-body"},At={class:"input-wrapper"},Jt={class:"modal-footer"},Kt=["disabled"],Yt=Q({__name:"GitSettingsTab",setup(B,{expose:X}){const v=r(null),x=r(null),m=r(!1),h=r(!1),_=r(!1),k=r(!1),b=r(!1),$=r("");function C(p){return{custom:"自定义",portable:"便携版",system:"系统",unknown:"未知"}[p]||p}function D(){var o;switch((o=v.value)==null?void 0:o.system_os){case"Windows":return"下载便携版";case"Linux":return"安装 Git";case"Darwin":return"安装 Git";default:return"安装 Git"}}function G(){var o;switch((o=v.value)==null?void 0:o.system_os){case"Windows":return'未检测到 Git，可以点击上方"下载便携版"按钮安装';case"Linux":return'未检测到 Git，点击"安装 Git"将使用系统包管理器安装';case"Darwin":return'未检测到 Git，点击"安装 Git"将使用 Homebrew 或 Xcode 安装';default:return"未检测到 Git，请手动安装"}}async function c(){m.value=!0;try{const p=await $s();p.success&&p.data&&(v.value=p.data,!p.data.git_available&&p.data.system_os!=="Windows"&&y())}catch(p){console.error("加载 Git 状态失败:",p)}finally{m.value=!1}}async function y(){var p;try{const o=await sa();o.success&&((p=o.data)!=null&&p.data)&&(x.value=o.data.data)}catch(o){console.error("加载安装指南失败:",o)}}async function U(){var p,o;k.value=!0;try{const u=await Qe();u.success&&((p=u.data)!=null&&p.success)?(Z(u.data.message||"已检测到 Git"),await c()):S(((o=u.data)==null?void 0:o.error)||u.error||"未检测到 Git")}catch(u){S(u.message||"检测失败")}finally{k.value=!1}}async function P(){var p,o,u,L;if((p=v.value)!=null&&p.git_available){const R=(o=v.value)==null?void 0:o.system_os;let A=`检测到您的电脑已经安装了 Git。

`;if(R==="Windows"?A+="便携版 Git 适用于没有安装 Git 的用户，如果您已经有 Git，通常不需要再下载。":R==="Linux"?A+="系统将尝试使用包管理器重新安装 Git，这可能会覆盖现有版本。":R==="Darwin"&&(A+="系统将尝试使用 Homebrew 或 Xcode 安装 Git，这可能会覆盖现有版本。"),A+=`

确定要继续吗？`,!await H({title:"确认安装",message:A,type:"warning",confirmText:"继续安装",cancelText:"取消"}))return}h.value=!0;try{const R=await qe();R.success&&((u=R.data)!=null&&u.success)?(Z(R.data.message||"Git 安装成功"),await U()):S(((L=R.data)==null?void 0:L.error)||R.error||"安装失败")}catch(R){S(R.message||"安装失败")}finally{h.value=!1}}async function N(){var p,o;if($.value){_.value=!0;try{const u=await He($.value);u.success&&((p=u.data)!=null&&p.success)?(Z(u.data.message||"路径设置成功"),b.value=!1,$.value="",await c()):S(((o=u.data)==null?void 0:o.error)||u.error||"设置失败")}catch(u){S(u.message||"设置失败")}finally{_.value=!1}}}return ts(()=>{c()}),X({refresh:c}),(p,o)=>(a(),t("div",_t,[s("div",ft,[s("div",bt,[o[5]||(o[5]=s("span",{class:"material-symbols-rounded"},"terminal",-1)),o[6]||(o[6]=s("h3",null,"Git 环境状态",-1)),s("button",{class:"m3-icon-button",onClick:c,disabled:m.value},[s("span",{class:T(["material-symbols-rounded",{spinning:m.value}])},"refresh",2)],8,yt)]),v.value?(a(),t("div",gt,[s("div",ht,[o[7]||(o[7]=s("span",{class:"status-label"},"状态",-1)),s("span",{class:T(["status-value",v.value.git_available?"success":"error"])},[s("span",kt,n(v.value.git_available?"check_circle":"cancel"),1),ks(" "+n(v.value.git_available?"可用":"不可用"),1)],2)]),v.value.git_version?(a(),t("div",$t,[o[8]||(o[8]=s("span",{class:"status-label"},"版本",-1)),s("span",wt,n(v.value.git_version),1)])):i("",!0),s("div",Ct,[o[9]||(o[9]=s("span",{class:"status-label"},"来源",-1)),s("span",Gt,[s("span",{class:T(["m3-badge",`source-${v.value.git_source}`])},n(C(v.value.git_source)),3)])]),s("div",Tt,[o[10]||(o[10]=s("span",{class:"status-label"},"操作系统",-1)),s("span",xt,n(v.value.system_os),1)])])):i("",!0)]),v.value?(a(),t("div",Ut,[o[14]||(o[14]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"folder"),s("h3",null,"Git 路径")],-1)),s("div",St,[s("div",Dt,[o[11]||(o[11]=s("span",{class:"path-label"},"当前路径:",-1)),s("code",It,n(v.value.git_path||"未检测到"),1)]),s("div",Bt,[s("button",{class:"m3-button tonal",onClick:U,disabled:k.value},[s("span",{class:T(["material-symbols-rounded",{spinning:k.value}])},n(k.value?"progress_activity":"search"),3),s("span",null,n(k.value?"检测中...":"自动寻找"),1)],8,Rt),s("button",{class:"m3-button tonal",onClick:o[0]||(o[0]=u=>b.value=!0)},[...o[12]||(o[12]=[s("span",{class:"material-symbols-rounded"},"edit",-1),s("span",null,"设置路径",-1)])]),s("button",{class:T(["m3-button",v.value.git_available?"tonal":"filled"]),onClick:P,disabled:h.value},[s("span",{class:T(["material-symbols-rounded",{spinning:h.value}])},n(h.value?"progress_activity":"download"),3),s("span",null,n(h.value?"安装中...":D()),1)],10,Vt)]),v.value.git_available?i("",!0):(a(),t("div",Mt,[o[13]||(o[13]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n(G()),1)]))])])):i("",!0),i("",!0),v.value&&!v.value.git_available&&v.value.system_os!=="Windows"?(a(),t("div",Lt,[o[18]||(o[18]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"help"),s("h3",null,"安装指南")],-1)),x.value?(a(),t("div",Wt,[s("p",null,n(x.value.description),1),x.value.manual_commands?(a(),t("div",Pt,[(a(!0),t(F,null,z(x.value.manual_commands,(u,L)=>(a(),t("div",{key:L,class:"command-item"},[s("span",Nt,n(L)+":",1),s("code",Et,n(u),1)]))),128))])):i("",!0),x.value.manual_url?(a(),t("a",{key:1,href:x.value.manual_url,target:"_blank",class:"m3-button tonal"},[...o[17]||(o[17]=[s("span",{class:"material-symbols-rounded"},"open_in_new",-1),s("span",null,"官方下载",-1)])],8,Ft)):i("",!0)])):i("",!0)])):i("",!0),(a(),ls(os,{to:"body"},[b.value?(a(),t("div",{key:0,class:"modal-overlay",onClick:o[4]||(o[4]=ns(u=>b.value=!1,["self"]))},[s("div",zt,[s("div",Ot,[o[20]||(o[20]=s("h3",null,"设置 Git 路径",-1)),s("button",{class:"m3-icon-button",onClick:o[1]||(o[1]=u=>b.value=!1)},[...o[19]||(o[19]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),s("div",Xt,[o[21]||(o[21]=s("p",null,"请输入 Git 可执行文件的完整路径",-1)),s("div",At,[as(s("input",{type:"text","onUpdate:modelValue":o[2]||(o[2]=u=>$.value=u),placeholder:"例如: C:\\Program Files\\Git\\bin\\git.exe",class:"m3-input"},null,512),[[Rs,$.value]])])]),s("div",Jt,[s("button",{class:"m3-button text",onClick:o[3]||(o[3]=u=>b.value=!1)},"取消"),s("button",{class:"m3-button filled",onClick:N,disabled:!$.value||_.value},n(_.value?"设置中...":"确定"),9,Kt)])])])):i("",!0)]))]))}}),Zt=ss(Yt,[["__scopeId","data-v-f68aa1d1"]]),jt={key:0,class:"dialog-content m3-card"},qt={class:"dialog-header"},Ht={class:"material-symbols-rounded"},Qt={class:"dialog-body"},sl={class:"dialog-message"},el={key:0,class:"changelog-section"},al={class:"changelog-list"},tl={class:"tip-section"},ll=Q({__name:"RestartDialog",props:{modelValue:{type:Boolean},updateType:{default:"main"},changelog:{default:()=>[]}},emits:["update:modelValue","restart","later"],setup(B,{emit:X}){const v=B,x=X,m=Y(()=>({main:"type-main",ui:"type-ui",both:"type-both"})[v.updateType]),h=Y(()=>({main:"smart_toy",ui:"web",both:"system_update"})[v.updateType]),_=Y(()=>({main:"主程序更新完成",ui:"UI 更新完成",both:"全部更新完成"})[v.updateType]),k=Y(()=>({main:"主程序已更新成功，需要重启才能生效。",ui:"WebUI 已更新成功，需要刷新页面才能生效。",both:"主程序和 WebUI 都已更新成功，需要重启才能生效。"})[v.updateType]),b=Y(()=>v.updateType==="ui"?"刷新页面后将加载新版本的 WebUI":"重启后新功能将生效，当前的连接会暂时中断");function $(){x("restart"),x("update:modelValue",!1)}function C(){x("later"),x("update:modelValue",!1)}return(D,G)=>(a(),ls(os,{to:"body"},[q(gs,{name:"fade"},{default:hs(()=>[B.modelValue?(a(),t("div",{key:0,class:"dialog-overlay",onClick:ns(C,["self"])},[q(gs,{name:"scale"},{default:hs(()=>[B.modelValue?(a(),t("div",jt,[s("div",qt,[s("div",{class:T(["dialog-icon",m.value])},[s("span",Ht,n(h.value),1)],2),s("h2",null,n(_.value),1)]),s("div",Qt,[s("p",sl,n(k.value),1),B.changelog&&B.changelog.length>0?(a(),t("div",el,[G[0]||(G[0]=s("h4",null,"更新内容:",-1)),s("ul",al,[(a(!0),t(F,null,z(B.changelog.slice(0,5),(c,y)=>(a(),t("li",{key:y},n(c),1))),128))])])):i("",!0),s("div",tl,[G[1]||(G[1]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n(b.value),1)])]),s("div",{class:"dialog-footer"},[s("button",{class:"m3-button text",onClick:C}," 稍后重启 "),s("button",{class:"m3-button filled",onClick:$},[...G[2]||(G[2]=[s("span",{class:"material-symbols-rounded"},"restart_alt",-1),s("span",null,"立即重启",-1)])])])])):i("",!0)]),_:1})])):i("",!0)]),_:1})]))}}),nl=ss(ll,[["__scopeId","data-v-8bea0f4d"]]),ol={class:"update-view"},il={class:"tabs-nav"},ul=["onClick"],dl={class:"material-symbols-rounded"},rl={class:"tab-label"},cl={class:"tab-content"},vl=Q({__name:"GitUpdateView",setup(B){const X=[{id:"ui",label:"UI 更新",icon:"web"},{id:"main",label:"主程序",icon:"terminal"},{id:"git",label:"Git 设置",icon:"settings"}],v=r("ui"),x=r(null),m=r(null),h=r(null),_=r(!1),k=r("main"),b=r([]);function $(c){c&&(k.value="ui",b.value=[],_.value=!0)}function C(c){c&&(k.value="main",b.value=[],_.value=!0)}async function D(){_.value=!1;try{await Ms()}catch(c){console.error("重启失败:",c)}}function G(){_.value=!1}return ts(()=>{}),(c,y)=>(a(),t("div",ol,[y[1]||(y[1]=Vs('<div class="page-header" data-v-175b5b3e><div class="header-content" data-v-175b5b3e><div class="header-icon" data-v-175b5b3e><span class="material-symbols-rounded" data-v-175b5b3e>system_update</span></div><div class="header-text" data-v-175b5b3e><h1 data-v-175b5b3e>更新管理</h1><p data-v-175b5b3e>管理 MoFox-Bot 和 WebUI 的更新</p></div></div></div>',1)),s("div",il,[(a(),t(F,null,z(X,U=>s("button",{key:U.id,class:T(["tab-item",{active:v.value===U.id}]),onClick:P=>v.value=U.id},[s("span",dl,n(U.icon),1),s("span",rl,n(U.label),1)],10,ul)),64))]),s("div",cl,[as(q(je,{ref_key:"uiUpdateTabRef",ref:x,onUpdateComplete:$},null,512),[[us,v.value==="ui"]]),as(q(pt,{ref_key:"mainUpdateTabRef",ref:m,onUpdateComplete:C},null,512),[[us,v.value==="main"]]),as(q(Zt,{ref_key:"gitSettingsTabRef",ref:h},null,512),[[us,v.value==="git"]])]),q(nl,{modelValue:_.value,"onUpdate:modelValue":y[0]||(y[0]=U=>_.value=U),"update-type":k.value,changelog:b.value,onRestart:D,onLater:G},null,8,["modelValue","update-type","changelog"])]))}}),bl=ss(vl,[["__scopeId","data-v-175b5b3e"]]);export{bl as default};
