import{a2 as D,aH as de,d as me,z as d,c as U,w as R,o as _e,A as ve,l as a,q as n,O as J,P as K,F as E,D as L,m as p,v as m,B as $,R as F,p as Y,n as x,y as r,u as Q,_ as fe}from"./index-Dp6KJFJl.js";async function pe(i=100){try{const l=await D.get(`live_chat/streams?limit=${i}`);if(l.success&&l.data){const o=l.data;if(o.success&&o.streams)return o.streams}return[]}catch(l){return console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",l),[]}}async function ge(i,l=24,o=200){try{const _=await D.get(`live_chat/messages/${i}?hours=${l}&limit=${o}`);if(_.success&&_.data){const v=_.data;if(v.success&&v.messages)return v.messages}return[]}catch(_){return console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",_),[]}}async function ye(i){try{const l=await D.post("live_chat/send",{stream_id:i.stream_id,content:i.content,message_type:i.message_type||"text",reply_to_id:i.reply_to_id});if(l.success&&l.data){const o=l.data;return o.success?{success:!0,messageId:o.message_id}:{success:!1,error:o.error||"å‘é€å¤±è´¥"}}return{success:!1,error:l.error||"è¯·æ±‚å¤±è´¥"}}catch(l){return console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",l),{success:!1,error:String(l)}}}function he(i){return i?`/plugins/webui_backend/live_chat/image/${i}`:""}function be(i){return i?`/plugins/webui_backend/live_chat/emoji/${i}`:""}async function ke(){const i=await de(),l=localStorage.getItem("mofox_token")||"";return`ws://${i.host}:${i.port}/plugins/webui_backend/live_chat/realtime?token=${encodeURIComponent(l)}`}function we(i){return i.replace(/token=[^&]+/,"token=***")}const Se={class:"live-chat-view"},Ce={class:"stream-panel m3-card"},$e={class:"search-box"},xe={class:"platform-filter"},Te=["onClick"],Me={class:"stream-list"},We=["onClick"],Ne={class:"stream-icon"},Ie={class:"material-symbols-rounded"},Ue={class:"stream-info"},Ee={class:"stream-header-row"},Le={class:"stream-name"},De={key:0,class:"last-active"},Pe={class:"stream-meta"},Oe={class:"platform-badge"},He={key:0,class:"unread-badge"},je={key:0,class:"empty-state"},ze={class:"chat-panel"},Be={class:"chat-header m3-card"},Ve={key:0,class:"header-content"},Ae={class:"stream-icon large"},Re={class:"material-symbols-rounded"},Je={class:"stream-info"},Ke={class:"stream-id"},Fe={key:1,class:"header-placeholder"},Ye={class:"header-actions"},Qe={class:"material-symbols-rounded"},Xe={key:0,class:"welcome-state"},Ge={key:1,class:"loading-state"},Ze={key:2,class:"messages-list"},qe=["onClick"],es={class:"reply-text"},ss={class:"message-header"},ts={class:"user-name"},ns={key:0,class:"sender-badge bot"},os={key:1,class:"sender-badge webui"},as={class:"message-time"},rs={class:"message-content"},ls=["src","onClick"],is=["src"],cs={key:2,class:"text-content"},us={key:0,class:"empty-messages"},ds={key:0,class:"input-area m3-card"},ms={class:"input-toolbar"},_s={class:"input-wrapper"},vs=["onKeydown"],fs=["disabled"],X=10,ps=me({__name:"LiveChatView",setup(i){const l=d([]),o=d(null),_=d(""),v=d(""),P=d(!1),y=d(new Map),T=d(!1),h=d({}),f=d(""),w=d(!1),G=d(!1),Z=d(!1),b=d(!1);let c=null,M=null,k=0,S=null;const C=d(null),O=d(null),q=d(new Map),ee=U(()=>{const s=new Set([""]);return l.value.forEach(e=>{e.platform&&s.add(e.platform)}),Array.from(s)}),H=U(()=>l.value.filter(s=>{if(v.value&&s.platform!==v.value)return!1;if(_.value){const e=_.value.toLowerCase(),t=(s.group_name||s.user_nickname||"").toLowerCase(),u=s.stream_id.toLowerCase();if(!t.includes(e)&&!u.includes(e))return!1}return!0})),W=U(()=>o.value?y.value.get(o.value.stream_id)||[]:[]);async function j(){P.value=!0;try{l.value=await pe(100)}catch(s){console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",s)}finally{P.value=!1}}function se(s){o.value=s,h.value[s.stream_id]=0,N(),ne(s.stream_id)}async function N(){if(o.value){T.value=!0;try{const s=o.value.stream_id,e=await ge(s,24,200);console.log(`åŠ è½½èŠå¤©æµ ${s} çš„åŽ†å²æ¶ˆæ¯ï¼Œå…± ${e.length} æ¡`),y.value.set(s,e),await x(),V()}catch(s){console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",s)}finally{T.value=!1}}}async function z(){if(!(!f.value.trim()||!o.value||w.value)){w.value=!0;try{const s=await ye({stream_id:o.value.stream_id,content:f.value.trim(),message_type:"text"});s.success?(f.value="",x(A)):console.error("å‘é€å¤±è´¥:",s.error)}catch(s){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",s)}finally{w.value=!1}}}async function B(){if((c==null?void 0:c.readyState)!==WebSocket.OPEN)try{const s=await ke();console.log("è¿žæŽ¥ WebSocket:",we(s)),c=new WebSocket(s),c.onopen=()=>{var t;console.log("WebSocket å·²è¿žæŽ¥"),b.value=!0,k=0;const e=S||((t=o.value)==null?void 0:t.stream_id);e&&(c.send(JSON.stringify({type:"subscribe",stream_id:e})),S=null)},c.onmessage=e=>{try{const t=JSON.parse(e.data);te(t)}catch(t){e.data!=="pong"&&console.error("è§£æž WebSocket æ¶ˆæ¯å¤±è´¥:",t)}},c.onclose=()=>{console.log("WebSocket å·²æ–­å¼€"),b.value=!1,oe()},c.onerror=e=>{console.error("WebSocket é”™è¯¯:",e)}}catch(s){console.error("è¿žæŽ¥ WebSocket å¤±è´¥:",s)}}function te(s){var e;if(s.type==="message"){const t=s,u=t.stream_id;if(!u)return;y.value.has(u)||y.value.set(u,[]);const g=y.value.get(u);g.some(I=>I.message_id===t.message_id)||(g.push(t),((e=o.value)==null?void 0:e.stream_id)===u?x(()=>V()):h.value[u]=(h.value[u]||0)+1)}else s.type==="subscribed"&&console.log("å·²è®¢é˜…èŠå¤©æµ:",s.stream_id)}function ne(s){(c==null?void 0:c.readyState)===WebSocket.OPEN?(c.send(JSON.stringify({type:"subscribe",stream_id:s})),S=null):(S=s,console.log("å¾…è®¢é˜…èŠå¤©æµ:",s))}function oe(){if(k>=X){console.error("WebSocket é‡è¿žæ¬¡æ•°è¶…è¿‡é™åˆ¶");return}const s=Math.min(1e3*Math.pow(2,k),3e4);k++,console.log(`å°†åœ¨ ${s}ms åŽé‡è¿ž (å°è¯• ${k}/${X})`),M=window.setTimeout(()=>{B()},s)}function ae(){setInterval(()=>{(c==null?void 0:c.readyState)===WebSocket.OPEN&&c.send("ping")},3e4)}function V(){C.value&&(C.value.scrollTop=C.value.scrollHeight)}function re(s){console.log("æ»šåŠ¨åˆ°æ¶ˆæ¯:",s)}function le(s){var u,g;const e=q.value.get(s);if(e)return`${e.user_nickname}: ${(u=e.content)==null?void 0:u.slice(0,30)}...`;const t=W.value.find(I=>I.message_id===s);return t?`${t.user_nickname}: ${(g=t.content)==null?void 0:g.slice(0,30)}...`:"æŸ¥çœ‹åŽŸæ¶ˆæ¯"}function ie(s){console.log("é¢„è§ˆå›¾ç‰‡:",s)}function ce(s){if(!s)return"";const e=new Date(s*1e3),t=new Date;return e.toDateString()===t.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}function ue(s){return s?new Date(s*1e3).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):""}function A(){const s=O.value;if(!s)return;s.style.height="auto";const e=s.scrollHeight;s.style.height=e+"px",e>150?s.style.overflowY="auto":s.style.overflowY="hidden"}return R(f,()=>{x(A)}),_e(()=>{j(),B(),ae()}),ve(()=>{c&&(c.close(),c=null),M&&clearTimeout(M)}),R(o,s=>{s&&N()}),(s,e)=>(r(),a("div",Se,[n("aside",Ce,[n("div",{class:"panel-header"},[e[6]||(e[6]=n("div",{class:"header-content"},[n("span",{class:"material-symbols-rounded"},"forum"),n("h2",null,"èŠå¤©æµ")],-1)),n("button",{class:"m3-button icon-only",onClick:j,title:"åˆ·æ–°åˆ—è¡¨"},[...e[5]||(e[5]=[n("span",{class:"material-symbols-rounded"},"refresh",-1)])])]),n("div",$e,[e[7]||(e[7]=n("span",{class:"material-symbols-rounded"},"search",-1)),J(n("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>_.value=t),type:"text",placeholder:"æœç´¢èŠå¤©æµ..."},null,512),[[K,_.value]])]),n("div",xe,[(r(!0),a(E,null,L(ee.value,t=>(r(),a("button",{key:t,class:$(["filter-chip",{active:v.value===t}]),onClick:u=>v.value=v.value===t?"":t},m(t||"å…¨éƒ¨"),11,Te))),128))]),n("div",Me,[(r(!0),a(E,null,L(H.value,t=>{var u;return r(),a("div",{key:t.stream_id,class:$(["stream-item",{active:((u=o.value)==null?void 0:u.stream_id)===t.stream_id}]),onClick:g=>se(t)},[n("div",Ne,[n("span",Ie,m(t.group_id?"group":"person"),1)]),n("div",Ue,[n("div",Ee,[n("div",Le,m(t.group_name||t.user_nickname||"æœªçŸ¥"),1),t.last_active_time?(r(),a("span",De,m(ce(t.last_active_time)),1)):p("",!0)]),n("div",Pe,[n("span",Oe,m(t.platform),1)])]),h.value[t.stream_id]?(r(),a("div",He,m(h.value[t.stream_id]),1)):p("",!0)],10,We)}),128)),H.value.length===0?(r(),a("div",je,[...e[8]||(e[8]=[n("span",{class:"material-symbols-rounded"},"inbox",-1),n("p",null,"æš‚æ— èŠå¤©æµ",-1)])])):p("",!0)])]),n("main",ze,[n("header",Be,[o.value?(r(),a("div",Ve,[n("div",Ae,[n("span",Re,m(o.value.group_id?"group":"person"),1)]),n("div",Je,[n("h2",null,m(o.value.group_name||o.value.user_nickname||"æœªçŸ¥"),1),n("p",Ke,m(o.value.stream_id),1)])])):(r(),a("div",Fe,[...e[9]||(e[9]=[n("span",{class:"material-symbols-rounded"},"chat",-1),n("span",null,"å³æ—¶é€šè®¯",-1)])])),n("div",Ye,[n("div",{class:$(["connection-status",{connected:b.value}])},[n("span",Qe,m(b.value?"wifi":"wifi_off"),1),n("span",null,m(b.value?"å·²è¿žæŽ¥":"æœªè¿žæŽ¥"),1)],2),n("button",{class:"m3-button icon-only",onClick:N,title:"åŠ è½½åŽ†å²æ¶ˆæ¯"},[...e[10]||(e[10]=[n("span",{class:"material-symbols-rounded"},"history",-1)])])])]),n("div",{class:"messages-container",ref_key:"messagesContainer",ref:C},[o.value?T.value?(r(),a("div",Ge,[...e[12]||(e[12]=[n("div",{class:"spinner"},null,-1),n("p",null,"åŠ è½½æ¶ˆæ¯ä¸­...",-1)])])):(r(),a("div",Ze,[(r(!0),a(E,null,L(W.value,t=>(r(),a("div",{key:t.message_id,class:$(["message",{"is-incoming":t.direction==="incoming","is-outgoing":t.direction==="outgoing","is-bot":t.sender_type==="bot","is-webui":t.sender_type==="webui"}])},[t.reply_to_id?(r(),a("div",{key:0,class:"reply-preview",onClick:u=>re(t.reply_to_id)},[e[13]||(e[13]=n("span",{class:"material-symbols-rounded"},"reply",-1)),n("span",es,m(le(t.reply_to_id)),1)],8,qe)):p("",!0),n("div",ss,[n("span",ts,m(t.user_nickname||"æœªçŸ¥ç”¨æˆ·"),1),t.sender_type==="bot"?(r(),a("span",ns,"ðŸ¤– Bot")):p("",!0),t.sender_type==="webui"?(r(),a("span",os,"ðŸ“± WebUI")):p("",!0),n("span",as,m(ue(t.timestamp)),1)]),n("div",rs,[t.is_picid&&t.content?(r(),a("img",{key:0,src:Q(he)(t.content),class:"message-image",onClick:u=>ie(t.content||""),loading:"lazy"},null,8,ls)):t.is_emoji?(r(),a("img",{key:1,src:Q(be)(t.content),class:"message-emoji"},null,8,is)):(r(),a("span",cs,m(t.content||t.display_message),1))])],2))),128)),W.value.length===0?(r(),a("div",us,[...e[14]||(e[14]=[n("span",{class:"material-symbols-rounded"},"chat_bubble_outline",-1),n("p",null,"æš‚æ— æ¶ˆæ¯",-1)])])):p("",!0)])):(r(),a("div",Xe,[...e[11]||(e[11]=[n("span",{class:"material-symbols-rounded"},"forum",-1),n("h3",null,"å³æ—¶é€šè®¯",-1),n("p",null,"é€‰æ‹©ä¸€ä¸ªèŠå¤©æµæŸ¥çœ‹å®žæ—¶æ¶ˆæ¯",-1)])]))],512),o.value?(r(),a("div",ds,[n("div",ms,[n("button",{class:"m3-icon-button",onClick:e[1]||(e[1]=t=>G.value=!0),title:"å‘é€å›¾ç‰‡"},[...e[15]||(e[15]=[n("span",{class:"material-symbols-rounded"},"image",-1)])]),n("button",{class:"m3-icon-button",onClick:e[2]||(e[2]=t=>Z.value=!0),title:"å‘é€è¡¨æƒ…"},[...e[16]||(e[16]=[n("span",{class:"material-symbols-rounded"},"mood",-1)])])]),n("div",_s,[J(n("textarea",{"onUpdate:modelValue":e[3]||(e[3]=t=>f.value=t),placeholder:"è¾“å…¥æ¶ˆæ¯...",onKeydown:[F(Y(z,["exact"]),["enter"]),e[4]||(e[4]=F(Y(t=>f.value+=`
`,["shift","exact","prevent"]),["enter"]))],rows:"1",ref_key:"inputTextarea",ref:O},null,40,vs),[[K,f.value]])]),n("button",{class:"m3-button filled send-button",onClick:z,disabled:!f.value.trim()||w.value},[...e[17]||(e[17]=[n("span",{class:"material-symbols-rounded"},"send",-1)])],8,fs)])):p("",!0)])]))}}),ys=fe(ps,[["__scopeId","data-v-45c17d43"]]);export{ys as default};
