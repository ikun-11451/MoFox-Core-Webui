import{a as K,r as b,G as D,I as X,p as ee,P as se,c,e as s,n as C,t as u,Y as O,a7 as G,g as W,F as $,h as F,Z as le,L as H,o as d,v as te,_ as oe}from"./index-Dz5dMUCJ.js";const ae={class:"live-log-view"},ne={class:"page-header"},ie={class:"header-content"},re={class:"title-group"},ce={class:"status-text"},ue={class:"content-wrapper"},de={class:"log-container"},fe={class:"toolbar"},ve={class:"toolbar-left"},pe=["disabled"],me={class:"material-symbols-rounded"},ge=["disabled"],be={class:"m3-switch-container"},_e={class:"m3-switch"},he={class:"toolbar-right"},we={class:"filter-group"},ke={class:"level-filter-dropdown"},ye={class:"material-symbols-rounded"},Ce={key:0,class:"filter-dropdown-menu m3-card"},Le=["value"],xe={class:"search-box"},Ne={class:"stats-bar"},Ie={class:"stat-item"},Re={class:"stat-value"},Se={key:0,class:"stat-item"},Te={class:"stat-value"},Ee={class:"stat-label"},Oe={key:0,class:"loading-state"},We={key:1,class:"empty-state"},$e={key:2,class:"empty-state"},Fe={key:3,class:"log-entries terminal-style"},Me={class:"terminal-time"},Be=["title"],Ue=["innerHTML"],Ve=K({__name:"LiveLogView",setup(Ae){const m=b(!1),g=b(!1),f=b([]),x=b(!0),_=b(null),N=b(null),M=["DEBUG","INFO","WARNING","ERROR","CRITICAL"],w=b(["INFO","WARNING","ERROR","CRITICAL"]),k=b(!1),I=b(""),J=()=>{k.value=!k.value},B=t=>{t.target.closest(".level-filter-dropdown")||(k.value=!1)},R=D(()=>{let t=f.value;if(w.value.length>0&&w.value.length<M.length&&(t=t.filter(e=>w.value.includes(e.level))),I.value){const e=I.value.toLowerCase();t=t.filter(l=>l.event.toLowerCase().includes(e)||l.logger_name&&l.logger_name.toLowerCase().includes(e)||l.alias&&l.alias.toLowerCase().includes(e))}return t}),z=D(()=>{const t={DEBUG:0,INFO:0,WARNING:0,ERROR:0,CRITICAL:0};return f.value.forEach(e=>{const l=e.level;l&&t[l]!==void 0&&t[l]++}),t}),j=t=>t?t.replace("T"," ").substring(0,19):"",P=t=>{let e=!1,l="",o=!1,a="";for(let v=0;v<t.length;v++){const n=t[v];if(e)o?(n===l?l==="'"?a+=n:a+="\\"+n:n==="\\"?a+="\\\\":n==="n"?a+="\\n":n==="r"?a+="\\r":n==="t"?a+="\\t":n==='"'?a+='\\"':a+="\\"+n,o=!1):n==="\\"?o=!0:n===l?(e=!1,l="",a+='"'):n==='"'?a+='\\"':a+=n;else if((n==="'"||n==='"')&&!o)e=!0,l=n,a+='"';else if(n===":"&&t.substring(v+1).match(/^\s*(True|False|None)\b/)){const p=t.substring(v+1).match(/^\s*(True|False|None)\b/);p&&(p[1]==="True"?a+=": true":p[1]==="False"?a+=": false":p[1]==="None"&&(a+=": null"),v+=p[0].length)}else a+=n}return a},q=t=>{var A;if(!t)return"";const e=t.trim();if(e.startsWith("{")&&e.endsWith("}"))try{let i=null;try{i=JSON.parse(e)}catch{const E=P(e);i=JSON.parse(E)}if(i&&typeof i=="object"&&i.event)return y(i.event)}catch(i){console.warn("解析 Python 字典格式失败，将作为普通文本处理:",i)}const l=/[\x1b\x9b]\[([0-9;]+)m/g,o={30:"#000000",31:"#e74c3c",32:"#2ecc71",33:"#f39c12",34:"#3498db",35:"#9b59b6",36:"#1abc9c",37:"#ecf0f1",90:"#7f8c8d",91:"#ff6b6b",92:"#51cf66",93:"#ffd43b",94:"#74c0fc",95:"#da77f2",96:"#3bc9db",97:"#ffffff",40:"#000000",41:"#e74c3c",42:"#2ecc71",43:"#f39c12",44:"#3498db",45:"#9b59b6",46:"#1abc9c",47:"#ecf0f1",100:"#7f8c8d",101:"#ff6b6b",102:"#51cf66",103:"#ffd43b",104:"#74c0fc",105:"#da77f2",106:"#3bc9db",107:"#ffffff"};let a="",v=0,n="",p="",L=!1,S;for(;(S=l.exec(t))!==null;){const i=t.substring(v,S.index);if(i){let r="";n&&(r+=`color: ${n};`),p&&(r+=` background-color: ${p};`),L&&(r+=" font-weight: bold;"),r?a+=`<span style="${r}">${y(i)}</span>`:a+=y(i)}const E=((A=S[1])==null?void 0:A.split(";"))||[];for(const r of E)if(r==="0"||r==="")n="",p="",L=!1;else if(r==="1")L=!0;else if(r==="22")L=!1;else if(o[r]){const h=parseInt(r);h>=30&&h<=37||h>=90&&h<=97?n=o[r]:(h>=40&&h<=47||h>=100&&h<=107)&&(p=o[r])}v=l.lastIndex}const T=t.substring(v);if(T){let i="";n&&(i+=`color: ${n};`),p&&(i+=` background-color: ${p};`),L&&(i+=" font-weight: bold;"),i?a+=`<span style="${i}">${y(T)}</span>`:a+=y(T)}return a||y(t)},y=t=>{const e=document.createElement("div");return e.textContent=t,e.innerHTML},Q=()=>{m.value?U():Y()},Y=async()=>{if(!(g.value||m.value)){g.value=!0;try{const e=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/plugins/webui_backend/log_viewer/realtime`;console.log("正在连接WebSocket:",e),_.value=new WebSocket(e),_.value.onopen=()=>{console.log("WebSocket已连接"),m.value=!0,g.value=!1},_.value.onmessage=l=>{try{let o=JSON.parse(l.data);if(typeof o=="string")try{o=JSON.parse(o)}catch{o={timestamp:new Date().toISOString(),level:"INFO",logger_name:"unknown",event:String(o),line_number:0,file_name:"realtime"}}o.line_number=f.value.length+1,o.file_name="realtime",f.value.push(o),f.value.length>1e3&&(f.value.shift(),f.value.forEach((a,v)=>{a.line_number=v+1})),x.value&&H(()=>{V()})}catch(o){console.error("解析日志消息失败:",o,l.data)}},_.value.onerror=l=>{console.error("WebSocket错误:",l),g.value=!1},_.value.onclose=()=>{console.log("WebSocket已断开"),m.value=!1,g.value=!1}}catch(t){console.error("连接WebSocket失败:",t),g.value=!1}}},U=()=>{_.value&&(_.value.close(),_.value=null),m.value=!1,g.value=!1},Z=()=>{f.value=[]},V=()=>{N.value&&(N.value.scrollTop=N.value.scrollHeight)};return X(x,t=>{t&&H(()=>{V()})}),ee(()=>{document.addEventListener("click",B)}),se(()=>{U(),document.removeEventListener("click",B)}),(t,e)=>(d(),c("div",ae,[s("div",ne,[s("div",ie,[s("div",re,[e[4]||(e[4]=s("span",{class:"material-symbols-rounded title-icon"},"sensors",-1)),e[5]||(e[5]=s("h1",{class:"page-title"},"实时日志",-1)),s("div",{class:C(["status-badge",{connected:m.value}])},[e[3]||(e[3]=s("span",{class:"status-dot"},null,-1)),s("span",ce,u(m.value?"已连接":"未连接"),1)],2)]),e[6]||(e[6]=s("p",{class:"page-description"},"实时查看系统日志输出",-1))])]),s("div",ue,[s("div",de,[s("div",fe,[s("div",ve,[s("button",{class:"m3-button filled",onClick:Q,disabled:g.value},[s("span",me,u(m.value?"pause":"play_arrow"),1),s("span",null,u(m.value?"断开连接":"开始监听"),1)],8,pe),s("button",{class:"m3-button text error",onClick:Z,disabled:!m.value&&f.value.length===0},[...e[7]||(e[7]=[s("span",{class:"material-symbols-rounded"},"delete",-1),s("span",null,"清空日志",-1)])],8,ge),e[10]||(e[10]=s("div",{class:"separator-line"},null,-1)),s("div",be,[s("label",_e,[O(s("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=l=>x.value=l)},null,512),[[G,x.value]]),e[8]||(e[8]=s("span",{class:"slider"},null,-1))]),e[9]||(e[9]=s("span",{class:"switch-label"},"自动滚动",-1))])]),s("div",he,[s("div",we,[s("div",ke,[s("button",{class:C(["m3-filter-chip",{active:k.value}]),onClick:J},[e[11]||(e[11]=s("span",{class:"material-symbols-rounded"},"filter_list",-1)),s("span",null,"日志级别 ("+u(w.value.length)+")",1),s("span",ye,u(k.value?"expand_less":"expand_more"),1)],2),k.value?(d(),c("div",Ce,[(d(),c($,null,F(M,l=>s("label",{key:l,class:"filter-option"},[O(s("input",{type:"checkbox",value:l,"onUpdate:modelValue":e[1]||(e[1]=o=>w.value=o)},null,8,Le),[[G,w.value]]),s("span",{class:C(["level-badge","level-"+l.toLowerCase()])},u(l),3)])),64))])):W("",!0)]),s("div",xe,[e[12]||(e[12]=s("span",{class:"material-symbols-rounded search-icon"},"search",-1)),O(s("input",{"onUpdate:modelValue":e[2]||(e[2]=l=>I.value=l),type:"text",class:"m3-input",placeholder:"搜索日志内容..."},null,512),[[le,I.value]])])])])]),s("div",Ne,[s("div",Ie,[e[13]||(e[13]=s("span",{class:"stat-label"},"总数:",-1)),s("span",Re,u(f.value.length),1)]),f.value.length!==R.value.length?(d(),c("div",Se,[e[14]||(e[14]=s("span",{class:"stat-label"},"已筛选:",-1)),s("span",Te,u(R.value.length),1)])):W("",!0),(d(!0),c($,null,F(z.value,(l,o)=>(d(),c("div",{class:"stat-item",key:o},[s("span",Ee,u(o)+":",1),s("span",{class:C(["stat-value","level-"+o.toLowerCase()])},u(l),3)]))),128))]),s("div",{class:"log-content",ref_key:"logContentContainer",ref:N},[g.value?(d(),c("div",Oe,[...e[15]||(e[15]=[s("span",{class:"material-symbols-rounded spinning loading-icon"},"progress_activity",-1),s("p",null,"正在连接...",-1)])])):!m.value&&f.value.length===0?(d(),c("div",We,[...e[16]||(e[16]=[s("span",{class:"material-symbols-rounded empty-icon"},"sensors",-1),s("p",null,'点击"开始监听"按钮开始接收实时日志',-1)])])):R.value.length===0?(d(),c("div",$e,[...e[17]||(e[17]=[s("span",{class:"material-symbols-rounded empty-icon"},"filter_list_off",-1),s("p",null,"没有匹配的日志",-1),s("p",{style:{"font-size":"12px","margin-top":"8px"}},"尝试调整筛选条件或搜索关键词",-1)])])):(d(),c("div",Fe,[(d(!0),c($,null,F(R.value,l=>(d(),c("div",{key:l.line_number,class:C(["log-entry terminal-line",`level-${l.level.toLowerCase()}`])},[s("span",Me,u(j(l.timestamp)),1),s("span",{class:C(["terminal-level",`level-${l.level.toLowerCase()}`])}," ["+u(l.level.padEnd(8," "))+"] ",3),l.alias||l.logger_name?(d(),c("span",{key:0,class:"terminal-logger",style:te(l.color?{color:l.color}:{}),title:l.alias?l.logger_name:""}," ["+u(l.alias||l.logger_name)+"] ",13,Be)):W("",!0),s("span",{class:"terminal-message",innerHTML:q(l.event)},null,8,Ue)],2))),128))]))],512)])])]))}}),Ge=oe(Ve,[["__scopeId","data-v-5cb22e1c"]]);export{Ge as default};
