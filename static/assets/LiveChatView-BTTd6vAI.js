import{ab as U,a as ue,r as u,G as E,I as R,p as de,P as me,c as a,e as o,Y as J,Z as K,F as I,h as P,g as f,t as d,n as $,a0 as Y,x as F,L as x,o as l,_ as _e}from"./index-BiU-y4EU.js";async function ve(m=100){try{const r=await U.get(`live_chat/streams?limit=${m}`);if(r.success&&r.data){const n=r.data;if(n.success&&n.streams)return n.streams}return[]}catch(r){return console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",r),[]}}async function pe(m,r=24,n=200){try{const _=await U.get(`live_chat/messages/${m}?hours=${r}&limit=${n}`);if(_.success&&_.data){const v=_.data;if(v.success&&v.messages)return v.messages}return[]}catch(_){return console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",_),[]}}async function fe(m){try{const r=await U.post("live_chat/send",{stream_id:m.stream_id,content:m.content,message_type:m.message_type||"text",reply_to_id:m.reply_to_id});if(r.success&&r.data){const n=r.data;return n.success?{success:!0,messageId:n.message_id}:{success:!1,error:n.error||"å‘é€å¤±è´¥"}}return{success:!1,error:r.error||"è¯·æ±‚å¤±è´¥"}}catch(r){return console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",r),{success:!1,error:String(r)}}}async function ye(){const m=window.location.protocol==="https:"?"wss:":"ws:",r=localStorage.getItem("mofox_token")||"";return`${m}//${window.location.host}/plugins/webui_backend/live_chat/realtime?token=${encodeURIComponent(r)}`}function ge(m){return m.replace(/token=[^&]+/,"token=***")}const he={class:"live-chat-view"},be={class:"stream-panel m3-card"},ke={class:"search-box"},we={class:"platform-filter"},Se=["onClick"],Ce={class:"stream-list"},$e=["onClick"],xe={class:"stream-icon"},Te={class:"material-symbols-rounded"},Me={class:"stream-info"},We={class:"stream-header-row"},Ne={class:"stream-name"},Le={key:0,class:"last-active"},Ee={class:"stream-meta"},Ie={class:"platform-badge"},Pe={key:0,class:"unread-badge"},Ue={key:0,class:"empty-state"},De={class:"chat-panel"},Oe={class:"chat-header m3-card"},je={key:0,class:"header-content"},He={class:"stream-icon large"},Ve={class:"material-symbols-rounded"},ze={class:"stream-info"},Be={class:"stream-id"},Ae={key:1,class:"header-placeholder"},Re={class:"header-actions"},Je={class:"material-symbols-rounded"},Ke={key:0,class:"welcome-state"},Ye={key:1,class:"loading-state"},Fe={key:2,class:"messages-list"},Ge=["onClick"],Qe={class:"reply-text"},Xe={class:"message-header"},Ze={class:"user-name"},qe={key:0,class:"sender-badge bot"},es={key:1,class:"sender-badge webui"},ss={class:"message-time"},ts={class:"message-content"},os=["src","onClick"],ns=["src"],as={key:2,class:"text-content"},ls={key:0,class:"empty-messages"},rs={key:0,class:"input-area m3-card"},is={class:"input-toolbar"},cs={class:"input-wrapper"},us=["onKeydown"],ds=["disabled"],G=10,ms=ue({__name:"LiveChatView",setup(m){const r=u([]),n=u(null),_=u(""),v=u(""),D=u(!1),g=u(new Map),T=u(!1),h=u({}),p=u(""),w=u(!1),Q=u(!1),X=u(!1),b=u(!1);let i=null,M=null,k=0,S=null;const C=u(null),O=u(null),Z=u(new Map),q=E(()=>{const t=new Set([""]);return r.value.forEach(e=>{e.platform&&t.add(e.platform)}),Array.from(t)}),j=E(()=>r.value.filter(t=>{if(v.value&&t.platform!==v.value)return!1;if(_.value){const e=_.value.toLowerCase(),s=(t.group_name||t.user_nickname||"").toLowerCase(),c=t.stream_id.toLowerCase();if(!s.includes(e)&&!c.includes(e))return!1}return!0})),W=E(()=>n.value?g.value.get(n.value.stream_id)||[]:[]);async function H(){D.value=!0;try{r.value=await ve(100)}catch(t){console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",t)}finally{D.value=!1}}function ee(t){n.value=t,h.value[t.stream_id]=0,N(),te(t.stream_id)}async function N(){if(n.value){T.value=!0;try{const t=n.value.stream_id,e=await pe(t,24,200);console.log(`åŠ è½½èŠå¤©æµ ${t} çš„åŽ†å²æ¶ˆæ¯ï¼Œå…± ${e.length} æ¡`),g.value.set(t,e),await x(),B()}catch(t){console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",t)}finally{T.value=!1}}}async function V(){if(!(!p.value.trim()||!n.value||w.value)){w.value=!0;try{const t=await fe({stream_id:n.value.stream_id,content:p.value.trim(),message_type:"text"});t.success?(p.value="",x(A)):console.error("å‘é€å¤±è´¥:",t.error)}catch(t){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",t)}finally{w.value=!1}}}async function z(){if((i==null?void 0:i.readyState)!==WebSocket.OPEN)try{const t=await ye();console.log("è¿žæŽ¥ WebSocket:",ge(t)),i=new WebSocket(t),i.onopen=()=>{var s;console.log("WebSocket å·²è¿žæŽ¥"),b.value=!0,k=0;const e=S||((s=n.value)==null?void 0:s.stream_id);e&&(i.send(JSON.stringify({type:"subscribe",stream_id:e})),S=null)},i.onmessage=e=>{try{const s=JSON.parse(e.data);se(s)}catch(s){e.data!=="pong"&&console.error("è§£æž WebSocket æ¶ˆæ¯å¤±è´¥:",s)}},i.onclose=()=>{console.log("WebSocket å·²æ–­å¼€"),b.value=!1,oe()},i.onerror=e=>{console.error("WebSocket é”™è¯¯:",e)}}catch(t){console.error("è¿žæŽ¥ WebSocket å¤±è´¥:",t)}}function se(t){var e;if(t.type==="message"){const s=t,c=s.stream_id;if(!c)return;g.value.has(c)||g.value.set(c,[]);const y=g.value.get(c);y.some(L=>L.message_id===s.message_id)||(y.push(s),((e=n.value)==null?void 0:e.stream_id)===c?x(()=>B()):h.value[c]=(h.value[c]||0)+1)}else t.type==="subscribed"&&console.log("å·²è®¢é˜…èŠå¤©æµ:",t.stream_id)}function te(t){(i==null?void 0:i.readyState)===WebSocket.OPEN?(i.send(JSON.stringify({type:"subscribe",stream_id:t})),S=null):(S=t,console.log("å¾…è®¢é˜…èŠå¤©æµ:",t))}function oe(){if(k>=G){console.error("WebSocket é‡è¿žæ¬¡æ•°è¶…è¿‡é™åˆ¶");return}const t=Math.min(1e3*Math.pow(2,k),3e4);k++,console.log(`å°†åœ¨ ${t}ms åŽé‡è¿ž (å°è¯• ${k}/${G})`),M=window.setTimeout(()=>{z()},t)}function ne(){setInterval(()=>{(i==null?void 0:i.readyState)===WebSocket.OPEN&&i.send("ping")},3e4)}function B(){C.value&&(C.value.scrollTop=C.value.scrollHeight)}function ae(t){console.log("æ»šåŠ¨åˆ°æ¶ˆæ¯:",t)}function le(t){var c,y;const e=Z.value.get(t);if(e)return`${e.user_nickname}: ${(c=e.content)==null?void 0:c.slice(0,30)}...`;const s=W.value.find(L=>L.message_id===t);return s?`${s.user_nickname}: ${(y=s.content)==null?void 0:y.slice(0,30)}...`:"æŸ¥çœ‹åŽŸæ¶ˆæ¯"}function re(t){console.log("é¢„è§ˆå›¾ç‰‡:",t)}function ie(t){if(!t)return"";const e=new Date(t*1e3),s=new Date;return e.toDateString()===s.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}function ce(t){return t?new Date(t*1e3).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):""}function A(){const t=O.value;if(!t)return;t.style.height="auto";const e=t.scrollHeight;t.style.height=e+"px",e>150?t.style.overflowY="auto":t.style.overflowY="hidden"}return R(p,()=>{x(A)}),de(()=>{H(),z(),ne()}),me(()=>{i&&(i.close(),i=null),M&&clearTimeout(M)}),R(n,t=>{t&&N()}),(t,e)=>(l(),a("div",he,[o("aside",be,[o("div",{class:"panel-header"},[e[6]||(e[6]=o("div",{class:"header-content"},[o("span",{class:"material-symbols-rounded"},"forum"),o("h2",null,"èŠå¤©æµ")],-1)),o("button",{class:"m3-button icon-only",onClick:H,title:"åˆ·æ–°åˆ—è¡¨"},[...e[5]||(e[5]=[o("span",{class:"material-symbols-rounded"},"refresh",-1)])])]),o("div",ke,[e[7]||(e[7]=o("span",{class:"material-symbols-rounded"},"search",-1)),J(o("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>_.value=s),type:"text",placeholder:"æœç´¢èŠå¤©æµ..."},null,512),[[K,_.value]])]),o("div",we,[(l(!0),a(I,null,P(q.value,s=>(l(),a("button",{key:s,class:$(["filter-chip",{active:v.value===s}]),onClick:c=>v.value=v.value===s?"":s},d(s||"å…¨éƒ¨"),11,Se))),128))]),o("div",Ce,[(l(!0),a(I,null,P(j.value,s=>{var c;return l(),a("div",{key:s.stream_id,class:$(["stream-item",{active:((c=n.value)==null?void 0:c.stream_id)===s.stream_id}]),onClick:y=>ee(s)},[o("div",xe,[o("span",Te,d(s.group_id?"group":"person"),1)]),o("div",Me,[o("div",We,[o("div",Ne,d(s.group_name||s.user_nickname||"æœªçŸ¥"),1),s.last_active_time?(l(),a("span",Le,d(ie(s.last_active_time)),1)):f("",!0)]),o("div",Ee,[o("span",Ie,d(s.platform),1)])]),h.value[s.stream_id]?(l(),a("div",Pe,d(h.value[s.stream_id]),1)):f("",!0)],10,$e)}),128)),j.value.length===0?(l(),a("div",Ue,[...e[8]||(e[8]=[o("span",{class:"material-symbols-rounded"},"inbox",-1),o("p",null,"æš‚æ— èŠå¤©æµ",-1)])])):f("",!0)])]),o("main",De,[o("header",Oe,[n.value?(l(),a("div",je,[o("div",He,[o("span",Ve,d(n.value.group_id?"group":"person"),1)]),o("div",ze,[o("h2",null,d(n.value.group_name||n.value.user_nickname||"æœªçŸ¥"),1),o("p",Be,d(n.value.stream_id),1)])])):(l(),a("div",Ae,[...e[9]||(e[9]=[o("span",{class:"material-symbols-rounded"},"chat",-1),o("span",null,"å³æ—¶é€šè®¯",-1)])])),o("div",Re,[o("div",{class:$(["connection-status",{connected:b.value}])},[o("span",Je,d(b.value?"wifi":"wifi_off"),1),o("span",null,d(b.value?"å·²è¿žæŽ¥":"æœªè¿žæŽ¥"),1)],2),o("button",{class:"m3-button icon-only",onClick:N,title:"åŠ è½½åŽ†å²æ¶ˆæ¯"},[...e[10]||(e[10]=[o("span",{class:"material-symbols-rounded"},"history",-1)])])])]),o("div",{class:"messages-container",ref_key:"messagesContainer",ref:C},[n.value?T.value?(l(),a("div",Ye,[...e[12]||(e[12]=[o("div",{class:"spinner"},null,-1),o("p",null,"åŠ è½½æ¶ˆæ¯ä¸­...",-1)])])):(l(),a("div",Fe,[(l(!0),a(I,null,P(W.value,s=>(l(),a("div",{key:s.message_id,class:$(["message",{"is-incoming":s.direction==="incoming","is-outgoing":s.direction==="outgoing","is-bot":s.sender_type==="bot","is-webui":s.sender_type==="webui"}])},[s.reply_to_id?(l(),a("div",{key:0,class:"reply-preview",onClick:c=>ae(s.reply_to_id)},[e[13]||(e[13]=o("span",{class:"material-symbols-rounded"},"reply",-1)),o("span",Qe,d(le(s.reply_to_id)),1)],8,Ge)):f("",!0),o("div",Xe,[o("span",Ze,d(s.user_nickname||"æœªçŸ¥ç”¨æˆ·"),1),s.sender_type==="bot"?(l(),a("span",qe,"ðŸ¤– Bot")):f("",!0),s.sender_type==="webui"?(l(),a("span",es,"ðŸ“± WebUI")):f("",!0),o("span",ss,d(ce(s.timestamp)),1)]),o("div",ts,[s.is_picid&&s.image_data?(l(),a("img",{key:0,src:s.image_data,class:"message-image",onClick:c=>re(s.content||""),loading:"lazy"},null,8,os)):s.is_emoji&&s.emoji_data?(l(),a("img",{key:1,src:s.emoji_data,class:"message-emoji"},null,8,ns)):(l(),a("span",as,d(s.content||s.display_message),1))])],2))),128)),W.value.length===0?(l(),a("div",ls,[...e[14]||(e[14]=[o("span",{class:"material-symbols-rounded"},"chat_bubble_outline",-1),o("p",null,"æš‚æ— æ¶ˆæ¯",-1)])])):f("",!0)])):(l(),a("div",Ke,[...e[11]||(e[11]=[o("span",{class:"material-symbols-rounded"},"forum",-1),o("h3",null,"å³æ—¶é€šè®¯",-1),o("p",null,"é€‰æ‹©ä¸€ä¸ªèŠå¤©æµæŸ¥çœ‹å®žæ—¶æ¶ˆæ¯",-1)])]))],512),n.value?(l(),a("div",rs,[o("div",is,[o("button",{class:"m3-icon-button",onClick:e[1]||(e[1]=s=>Q.value=!0),title:"å‘é€å›¾ç‰‡"},[...e[15]||(e[15]=[o("span",{class:"material-symbols-rounded"},"image",-1)])]),o("button",{class:"m3-icon-button",onClick:e[2]||(e[2]=s=>X.value=!0),title:"å‘é€è¡¨æƒ…"},[...e[16]||(e[16]=[o("span",{class:"material-symbols-rounded"},"mood",-1)])])]),o("div",cs,[J(o("textarea",{"onUpdate:modelValue":e[3]||(e[3]=s=>p.value=s),placeholder:"è¾“å…¥æ¶ˆæ¯...",onKeydown:[Y(F(V,["exact"]),["enter"]),e[4]||(e[4]=Y(F(s=>p.value+=`
`,["shift","exact","prevent"]),["enter"]))],rows:"1",ref_key:"inputTextarea",ref:O},null,40,us),[[K,p.value]])]),o("button",{class:"m3-button filled send-button",onClick:V,disabled:!p.value.trim()||w.value},[...e[17]||(e[17]=[o("span",{class:"material-symbols-rounded"},"send",-1)])],8,ds)])):f("",!0)])]))}}),vs=_e(ms,[["__scopeId","data-v-9141a1e7"]]);export{vs as default};
