import{a2 as P,aI as ue,d as de,z as u,c as L,w as R,o as me,A as _e,l as n,q as o,O as J,P as K,F as D,D as E,m as f,v as d,B as $,R as F,p as Y,n as x,y as r,_ as ve}from"./index-CY7F1OJz.js";async function pe(m=100){try{const l=await P.get(`live_chat/streams?limit=${m}`);if(l.success&&l.data){const a=l.data;if(a.success&&a.streams)return a.streams}return[]}catch(l){return console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",l),[]}}async function fe(m,l=24,a=200){try{const _=await P.get(`live_chat/messages/${m}?hours=${l}&limit=${a}`);if(_.success&&_.data){const v=_.data;if(v.success&&v.messages)return v.messages}return[]}catch(_){return console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",_),[]}}async function ye(m){try{const l=await P.post("live_chat/send",{stream_id:m.stream_id,content:m.content,message_type:m.message_type||"text",reply_to_id:m.reply_to_id});if(l.success&&l.data){const a=l.data;return a.success?{success:!0,messageId:a.message_id}:{success:!1,error:a.error||"å‘é€å¤±è´¥"}}return{success:!1,error:l.error||"è¯·æ±‚å¤±è´¥"}}catch(l){return console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",l),{success:!1,error:String(l)}}}async function ge(){const m=await ue(),l=localStorage.getItem("mofox_token")||"";return`ws://${m.host}:${m.port}/plugins/webui_backend/live_chat/realtime?token=${encodeURIComponent(l)}`}function he(m){return m.replace(/token=[^&]+/,"token=***")}const be={class:"live-chat-view"},ke={class:"stream-panel m3-card"},we={class:"search-box"},Se={class:"platform-filter"},Ce=["onClick"],$e={class:"stream-list"},xe=["onClick"],Te={class:"stream-icon"},Me={class:"material-symbols-rounded"},We={class:"stream-info"},Ne={class:"stream-header-row"},Ie={class:"stream-name"},Le={key:0,class:"last-active"},De={class:"stream-meta"},Ee={class:"platform-badge"},Pe={key:0,class:"unread-badge"},Ue={key:0,class:"empty-state"},Oe={class:"chat-panel"},je={class:"chat-header m3-card"},ze={key:0,class:"header-content"},Be={class:"stream-icon large"},He={class:"material-symbols-rounded"},Ve={class:"stream-info"},Ae={class:"stream-id"},Re={key:1,class:"header-placeholder"},Je={class:"header-actions"},Ke={class:"material-symbols-rounded"},Fe={key:0,class:"welcome-state"},Ye={key:1,class:"loading-state"},Qe={key:2,class:"messages-list"},Xe=["onClick"],Ge={class:"reply-text"},Ze={class:"message-header"},qe={class:"user-name"},es={key:0,class:"sender-badge bot"},ss={key:1,class:"sender-badge webui"},ts={class:"message-time"},os={class:"message-content"},as=["src","onClick"],ns=["src"],rs={key:2,class:"text-content"},ls={key:0,class:"empty-messages"},is={key:0,class:"input-area m3-card"},cs={class:"input-toolbar"},us={class:"input-wrapper"},ds=["onKeydown"],ms=["disabled"],Q=10,_s=de({__name:"LiveChatView",setup(m){const l=u([]),a=u(null),_=u(""),v=u(""),U=u(!1),g=u(new Map),T=u(!1),h=u({}),p=u(""),w=u(!1),X=u(!1),G=u(!1),b=u(!1);let i=null,M=null,k=0,S=null;const C=u(null),O=u(null),Z=u(new Map),q=L(()=>{const t=new Set([""]);return l.value.forEach(e=>{e.platform&&t.add(e.platform)}),Array.from(t)}),j=L(()=>l.value.filter(t=>{if(v.value&&t.platform!==v.value)return!1;if(_.value){const e=_.value.toLowerCase(),s=(t.group_name||t.user_nickname||"").toLowerCase(),c=t.stream_id.toLowerCase();if(!s.includes(e)&&!c.includes(e))return!1}return!0})),W=L(()=>a.value?g.value.get(a.value.stream_id)||[]:[]);async function z(){U.value=!0;try{l.value=await pe(100)}catch(t){console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",t)}finally{U.value=!1}}function ee(t){a.value=t,h.value[t.stream_id]=0,N(),te(t.stream_id)}async function N(){if(a.value){T.value=!0;try{const t=a.value.stream_id,e=await fe(t,24,200);console.log(`åŠ è½½èŠå¤©æµ ${t} çš„åŽ†å²æ¶ˆæ¯ï¼Œå…± ${e.length} æ¡`),g.value.set(t,e),await x(),V()}catch(t){console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",t)}finally{T.value=!1}}}async function B(){if(!(!p.value.trim()||!a.value||w.value)){w.value=!0;try{const t=await ye({stream_id:a.value.stream_id,content:p.value.trim(),message_type:"text"});t.success?(p.value="",x(A)):console.error("å‘é€å¤±è´¥:",t.error)}catch(t){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",t)}finally{w.value=!1}}}async function H(){if((i==null?void 0:i.readyState)!==WebSocket.OPEN)try{const t=await ge();console.log("è¿žæŽ¥ WebSocket:",he(t)),i=new WebSocket(t),i.onopen=()=>{var s;console.log("WebSocket å·²è¿žæŽ¥"),b.value=!0,k=0;const e=S||((s=a.value)==null?void 0:s.stream_id);e&&(i.send(JSON.stringify({type:"subscribe",stream_id:e})),S=null)},i.onmessage=e=>{try{const s=JSON.parse(e.data);se(s)}catch(s){e.data!=="pong"&&console.error("è§£æž WebSocket æ¶ˆæ¯å¤±è´¥:",s)}},i.onclose=()=>{console.log("WebSocket å·²æ–­å¼€"),b.value=!1,oe()},i.onerror=e=>{console.error("WebSocket é”™è¯¯:",e)}}catch(t){console.error("è¿žæŽ¥ WebSocket å¤±è´¥:",t)}}function se(t){var e;if(t.type==="message"){const s=t,c=s.stream_id;if(!c)return;g.value.has(c)||g.value.set(c,[]);const y=g.value.get(c);y.some(I=>I.message_id===s.message_id)||(y.push(s),((e=a.value)==null?void 0:e.stream_id)===c?x(()=>V()):h.value[c]=(h.value[c]||0)+1)}else t.type==="subscribed"&&console.log("å·²è®¢é˜…èŠå¤©æµ:",t.stream_id)}function te(t){(i==null?void 0:i.readyState)===WebSocket.OPEN?(i.send(JSON.stringify({type:"subscribe",stream_id:t})),S=null):(S=t,console.log("å¾…è®¢é˜…èŠå¤©æµ:",t))}function oe(){if(k>=Q){console.error("WebSocket é‡è¿žæ¬¡æ•°è¶…è¿‡é™åˆ¶");return}const t=Math.min(1e3*Math.pow(2,k),3e4);k++,console.log(`å°†åœ¨ ${t}ms åŽé‡è¿ž (å°è¯• ${k}/${Q})`),M=window.setTimeout(()=>{H()},t)}function ae(){setInterval(()=>{(i==null?void 0:i.readyState)===WebSocket.OPEN&&i.send("ping")},3e4)}function V(){C.value&&(C.value.scrollTop=C.value.scrollHeight)}function ne(t){console.log("æ»šåŠ¨åˆ°æ¶ˆæ¯:",t)}function re(t){var c,y;const e=Z.value.get(t);if(e)return`${e.user_nickname}: ${(c=e.content)==null?void 0:c.slice(0,30)}...`;const s=W.value.find(I=>I.message_id===t);return s?`${s.user_nickname}: ${(y=s.content)==null?void 0:y.slice(0,30)}...`:"æŸ¥çœ‹åŽŸæ¶ˆæ¯"}function le(t){console.log("é¢„è§ˆå›¾ç‰‡:",t)}function ie(t){if(!t)return"";const e=new Date(t*1e3),s=new Date;return e.toDateString()===s.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}function ce(t){return t?new Date(t*1e3).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):""}function A(){const t=O.value;if(!t)return;t.style.height="auto";const e=t.scrollHeight;t.style.height=e+"px",e>150?t.style.overflowY="auto":t.style.overflowY="hidden"}return R(p,()=>{x(A)}),me(()=>{z(),H(),ae()}),_e(()=>{i&&(i.close(),i=null),M&&clearTimeout(M)}),R(a,t=>{t&&N()}),(t,e)=>(r(),n("div",be,[o("aside",ke,[o("div",{class:"panel-header"},[e[6]||(e[6]=o("div",{class:"header-content"},[o("span",{class:"material-symbols-rounded"},"forum"),o("h2",null,"èŠå¤©æµ")],-1)),o("button",{class:"m3-button icon-only",onClick:z,title:"åˆ·æ–°åˆ—è¡¨"},[...e[5]||(e[5]=[o("span",{class:"material-symbols-rounded"},"refresh",-1)])])]),o("div",we,[e[7]||(e[7]=o("span",{class:"material-symbols-rounded"},"search",-1)),J(o("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>_.value=s),type:"text",placeholder:"æœç´¢èŠå¤©æµ..."},null,512),[[K,_.value]])]),o("div",Se,[(r(!0),n(D,null,E(q.value,s=>(r(),n("button",{key:s,class:$(["filter-chip",{active:v.value===s}]),onClick:c=>v.value=v.value===s?"":s},d(s||"å…¨éƒ¨"),11,Ce))),128))]),o("div",$e,[(r(!0),n(D,null,E(j.value,s=>{var c;return r(),n("div",{key:s.stream_id,class:$(["stream-item",{active:((c=a.value)==null?void 0:c.stream_id)===s.stream_id}]),onClick:y=>ee(s)},[o("div",Te,[o("span",Me,d(s.group_id?"group":"person"),1)]),o("div",We,[o("div",Ne,[o("div",Ie,d(s.group_name||s.user_nickname||"æœªçŸ¥"),1),s.last_active_time?(r(),n("span",Le,d(ie(s.last_active_time)),1)):f("",!0)]),o("div",De,[o("span",Ee,d(s.platform),1)])]),h.value[s.stream_id]?(r(),n("div",Pe,d(h.value[s.stream_id]),1)):f("",!0)],10,xe)}),128)),j.value.length===0?(r(),n("div",Ue,[...e[8]||(e[8]=[o("span",{class:"material-symbols-rounded"},"inbox",-1),o("p",null,"æš‚æ— èŠå¤©æµ",-1)])])):f("",!0)])]),o("main",Oe,[o("header",je,[a.value?(r(),n("div",ze,[o("div",Be,[o("span",He,d(a.value.group_id?"group":"person"),1)]),o("div",Ve,[o("h2",null,d(a.value.group_name||a.value.user_nickname||"æœªçŸ¥"),1),o("p",Ae,d(a.value.stream_id),1)])])):(r(),n("div",Re,[...e[9]||(e[9]=[o("span",{class:"material-symbols-rounded"},"chat",-1),o("span",null,"å³æ—¶é€šè®¯",-1)])])),o("div",Je,[o("div",{class:$(["connection-status",{connected:b.value}])},[o("span",Ke,d(b.value?"wifi":"wifi_off"),1),o("span",null,d(b.value?"å·²è¿žæŽ¥":"æœªè¿žæŽ¥"),1)],2),o("button",{class:"m3-button icon-only",onClick:N,title:"åŠ è½½åŽ†å²æ¶ˆæ¯"},[...e[10]||(e[10]=[o("span",{class:"material-symbols-rounded"},"history",-1)])])])]),o("div",{class:"messages-container",ref_key:"messagesContainer",ref:C},[a.value?T.value?(r(),n("div",Ye,[...e[12]||(e[12]=[o("div",{class:"spinner"},null,-1),o("p",null,"åŠ è½½æ¶ˆæ¯ä¸­...",-1)])])):(r(),n("div",Qe,[(r(!0),n(D,null,E(W.value,s=>(r(),n("div",{key:s.message_id,class:$(["message",{"is-incoming":s.direction==="incoming","is-outgoing":s.direction==="outgoing","is-bot":s.sender_type==="bot","is-webui":s.sender_type==="webui"}])},[s.reply_to_id?(r(),n("div",{key:0,class:"reply-preview",onClick:c=>ne(s.reply_to_id)},[e[13]||(e[13]=o("span",{class:"material-symbols-rounded"},"reply",-1)),o("span",Ge,d(re(s.reply_to_id)),1)],8,Xe)):f("",!0),o("div",Ze,[o("span",qe,d(s.user_nickname||"æœªçŸ¥ç”¨æˆ·"),1),s.sender_type==="bot"?(r(),n("span",es,"ðŸ¤– Bot")):f("",!0),s.sender_type==="webui"?(r(),n("span",ss,"ðŸ“± WebUI")):f("",!0),o("span",ts,d(ce(s.timestamp)),1)]),o("div",os,[s.is_picid&&s.image_data?(r(),n("img",{key:0,src:s.image_data,class:"message-image",onClick:c=>le(s.content||""),loading:"lazy"},null,8,as)):s.is_emoji&&s.emoji_data?(r(),n("img",{key:1,src:s.emoji_data,class:"message-emoji"},null,8,ns)):(r(),n("span",rs,d(s.content||s.display_message),1))])],2))),128)),W.value.length===0?(r(),n("div",ls,[...e[14]||(e[14]=[o("span",{class:"material-symbols-rounded"},"chat_bubble_outline",-1),o("p",null,"æš‚æ— æ¶ˆæ¯",-1)])])):f("",!0)])):(r(),n("div",Fe,[...e[11]||(e[11]=[o("span",{class:"material-symbols-rounded"},"forum",-1),o("h3",null,"å³æ—¶é€šè®¯",-1),o("p",null,"é€‰æ‹©ä¸€ä¸ªèŠå¤©æµæŸ¥çœ‹å®žæ—¶æ¶ˆæ¯",-1)])]))],512),a.value?(r(),n("div",is,[o("div",cs,[o("button",{class:"m3-icon-button",onClick:e[1]||(e[1]=s=>X.value=!0),title:"å‘é€å›¾ç‰‡"},[...e[15]||(e[15]=[o("span",{class:"material-symbols-rounded"},"image",-1)])]),o("button",{class:"m3-icon-button",onClick:e[2]||(e[2]=s=>G.value=!0),title:"å‘é€è¡¨æƒ…"},[...e[16]||(e[16]=[o("span",{class:"material-symbols-rounded"},"mood",-1)])])]),o("div",us,[J(o("textarea",{"onUpdate:modelValue":e[3]||(e[3]=s=>p.value=s),placeholder:"è¾“å…¥æ¶ˆæ¯...",onKeydown:[F(Y(B,["exact"]),["enter"]),e[4]||(e[4]=F(Y(s=>p.value+=`
`,["shift","exact","prevent"]),["enter"]))],rows:"1",ref_key:"inputTextarea",ref:O},null,40,ds),[[K,p.value]])]),o("button",{class:"m3-button filled send-button",onClick:B,disabled:!p.value.trim()||w.value},[...e[17]||(e[17]=[o("span",{class:"material-symbols-rounded"},"send",-1)])],8,ms)])):f("",!0)])]))}}),ps=ve(_s,[["__scopeId","data-v-9141a1e7"]]);export{ps as default};
