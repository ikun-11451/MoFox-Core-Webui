import{a2 as z,d as ss,z as u,c as J,o as ts,l as t,m as i,f as ls,q as s,v as o,B as U,F as E,D as F,p as ns,x as os,aF as Y,aE as K,a3 as S,y as a,_ as es,A as ks,r as gs,aI as $s,aJ as ws,aK as Cs,aL as Gs,aM as xs,aN as Ts,aO as Us,O as as,P as Ss,j as Q,T as bs,k as ys,ae as Ds,S as is,aP as Is}from"./index-2cLGT6AP.js";function Bs(){return z.get("ui_update/status")}function Rs(){return z.post("ui_update/update")}function Vs(){return z.get("ui_update/backups")}function Ms(I){return z.post("ui_update/rollback",{commit_hash:I})}function Ls(I){return z.get(`ui_update/commit/${I}`)}const Ws={class:"ui-update-tab"},Ps={key:0,class:"m3-card disabled-card"},Ns={class:"disabled-content"},Es={class:"disabled-text"},Fs={key:1,class:"m3-card version-card"},zs={key:0,class:"version-info"},Os={class:"info-row"},As={class:"info-value version"},Xs={key:0,class:"info-row"},js={class:"info-value"},qs={key:1,class:"info-row"},Js={class:"info-value branch"},Ks={key:2,class:"info-row"},Hs={class:"info-value commit"},Qs={key:1,class:"version-info"},Ys={key:2,class:"m3-card update-check-card"},Zs={class:"card-header"},se=["disabled"],ee={key:0,class:"update-result"},ae={key:0,class:"has-update"},te={class:"update-badge"},le={key:0,class:"changelog"},ne={class:"update-actions"},oe=["disabled"],ie={key:1,class:"up-to-date"},ue={key:1,class:"error-message"},de={key:3,class:"m3-card backup-card"},re={class:"card-header"},ce=["disabled"],ve={key:0,class:"backup-list"},me={class:"backup-info"},pe={class:"backup-header"},_e={class:"backup-commit"},fe={key:0,class:"backup-version"},be={key:1,class:"current-badge"},ye={class:"backup-message"},ge={class:"backup-meta"},he={class:"backup-actions"},ke=["onClick","disabled"],$e=["onClick","disabled"],we={key:1,class:"no-backups"},Ce={class:"detail-dialog"},Ge={class:"detail-header"},xe={key:0,class:"detail-content"},Te={class:"detail-section"},Ue={class:"detail-row"},Se={class:"detail-value"},De={key:0,class:"detail-row"},Ie={class:"detail-value version-tag"},Be={class:"detail-row"},Re={class:"detail-value"},Ve={key:1,class:"detail-row"},Me={class:"detail-value"},Le={key:0,class:"detail-section"},We={class:"commit-message"},Pe={key:1,class:"detail-section"},Ne={class:"commit-body"},Ee={key:2,class:"detail-section"},Fe={class:"files-list"},ze={class:"file-path"},Oe={key:0,class:"files-more"},Ae={key:1,class:"detail-content loading"},Xe=ss({__name:"UIUpdateTab",emits:["update-complete"],setup(I,{expose:O,emit:c}){const x=c,v=u(null),w=u([]),p=u(!1),y=u(!1),g=u(!1),h=u(!1),C=u(""),D=u(!1),G=u(!1),r=u(null),T=J(()=>v.value?{version:v.value.current_version||"未安装",build_time:null,branch:v.value.current_branch,commit:v.value.current_commit}:null),k=J(()=>v.value?v.value.update_enabled===!1:!1),A=J(()=>v.value?v.value.message?v.value.message:v.value.update_enabled===!1?`当前分支为 "${v.value.current_branch||"未知"}"，更新功能已禁用。仅 webui-dist 分支支持自动更新。`:"":"");function L(f){if(!f)return"-";try{return new Date(f).toLocaleString("zh-CN")}catch{return f}}async function m(){p.value=!0,C.value="";try{const f=await Bs();f.success&&f.data?(v.value=f.data,f.data.success||(C.value=f.data.error||"获取状态失败")):C.value=f.error||"获取状态失败"}catch(f){C.value=f.message||"获取状态失败"}finally{p.value=!1}}async function n(){await m()}async function _(){var l,q;if(await Y({title:"确认更新",message:"更新 UI 将刷新页面，是否继续？",confirmText:"更新"})){y.value=!0,C.value="";try{const V=await Rs();V.success&&((l=V.data)!=null&&l.success)?(K(`更新成功！已更新到 ${V.data.version||"最新版本"}`),x("update-complete",!0)):S(((q=V.data)==null?void 0:q.error)||V.error||"更新失败")}catch(V){S(V.message||"更新失败")}finally{y.value=!1}}}async function P(){var f;h.value=!0;try{const l=await Vs();l.success&&((f=l.data)!=null&&f.data)&&(w.value=l.data.data)}catch(l){console.error("加载备份列表失败:",l)}finally{h.value=!1}}async function R(f){var V,b;const l=f.substring(0,7);if(await Y({title:"确认回滚",message:`确定要回滚到版本 "${l}" 吗？此操作将重置到该版本。`,confirmText:"回滚"})){g.value=!0;try{const M=await Ms(f);M.success&&((V=M.data)!=null&&V.success)?(K(M.data.message||"回滚成功"),x("update-complete",!0)):S(((b=M.data)==null?void 0:b.error)||M.error||"回滚失败")}catch(M){S(M.message||"回滚失败")}finally{g.value=!1}}}async function X(f){D.value=!0,G.value=!0,r.value=null;try{const l=await Ls(f);l.success&&l.data?r.value=l.data:(S(l.error||"获取详情失败"),D.value=!1)}catch(l){S(l.message||"获取详情失败"),D.value=!1}finally{G.value=!1}}function Z(f){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[f]||""}return ts(()=>{m(),P()}),O({refresh:()=>{m(),P()}}),(f,l)=>{var q,V;return a(),t("div",Ws,[k.value?(a(),t("div",Ps,[s("div",Ns,[l[3]||(l[3]=s("span",{class:"material-symbols-rounded icon-warning"},"info",-1)),s("div",Es,[l[2]||(l[2]=s("h4",null,"更新功能已禁用",-1)),s("p",null,o(A.value),1)])])])):i("",!0),k.value?i("",!0):(a(),t("div",Fs,[l[9]||(l[9]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"web"),s("h3",null,"当前版本")],-1)),T.value?(a(),t("div",zs,[s("div",Os,[l[4]||(l[4]=s("span",{class:"info-label"},"版本号:",-1)),s("span",As,"v"+o(T.value.version),1)]),T.value.build_time?(a(),t("div",Xs,[l[5]||(l[5]=s("span",{class:"info-label"},"构建时间:",-1)),s("span",js,o(L(T.value.build_time)),1)])):i("",!0),T.value.branch?(a(),t("div",qs,[l[6]||(l[6]=s("span",{class:"info-label"},"分支:",-1)),s("span",Js,o(T.value.branch),1)])):i("",!0),T.value.commit?(a(),t("div",Ks,[l[7]||(l[7]=s("span",{class:"info-label"},"Commit:",-1)),s("code",Hs,o(T.value.commit.substring(0,8)),1)])):i("",!0)])):(a(),t("div",Qs,[...l[8]||(l[8]=[s("p",{class:"no-version"},"未检测到版本信息",-1)])]))])),k.value?i("",!0):(a(),t("div",Ys,[s("div",Zs,[l[10]||(l[10]=s("span",{class:"material-symbols-rounded"},"sync",-1)),l[11]||(l[11]=s("h3",null,"检查更新",-1)),s("button",{class:"m3-button tonal",onClick:n,disabled:p.value||k.value},[s("span",{class:U(["material-symbols-rounded",{spinning:p.value}])},o(p.value?"progress_activity":"refresh"),3),s("span",null,o(p.value?"检查中...":"检查更新"),1)],8,se)]),v.value&&!k.value?(a(),t("div",ee,[v.value.has_update?(a(),t("div",ae,[s("div",te,[l[12]||(l[12]=s("span",{class:"material-symbols-rounded"},"auto_awesome",-1)),s("span",null,"发现新版本 v"+o(v.value.latest_version),1)]),(q=v.value.changelog)!=null&&q.length?(a(),t("div",le,[l[13]||(l[13]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),t(E,null,F(v.value.changelog.slice(0,10),(b,M)=>(a(),t("li",{key:M},o(b),1))),128))])])):i("",!0),s("div",ne,[s("button",{class:"m3-button filled",onClick:_,disabled:y.value},[s("span",{class:U(["material-symbols-rounded",{spinning:y.value}])},o(y.value?"progress_activity":"download"),3),s("span",null,o(y.value?"更新中...":"立即更新"),1)],8,oe)])])):(a(),t("div",ie,[...l[14]||(l[14]=[s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1),s("span",null,"已是最新版本",-1)])]))])):i("",!0),C.value?(a(),t("div",ue,[l[15]||(l[15]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,o(C.value),1)])):i("",!0)])),k.value?i("",!0):(a(),t("div",de,[s("div",re,[l[16]||(l[16]=s("span",{class:"material-symbols-rounded"},"history",-1)),l[17]||(l[17]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:P,disabled:h.value},[s("span",{class:U(["material-symbols-rounded",{spinning:h.value}])},"refresh",2)],8,ce)]),w.value.length?(a(),t("div",ve,[(a(!0),t(E,null,F(w.value,b=>(a(),t("div",{key:b.commit,class:U(["backup-item",{"is-current":b.is_current}])},[s("div",me,[s("div",pe,[s("code",_e,o(b.commit_short),1),b.version?(a(),t("span",fe,"v"+o(b.version),1)):i("",!0),b.is_current?(a(),t("span",be,"当前")):i("",!0)]),s("span",ye,o(b.message),1),s("span",ge,o(L(b.timestamp)),1)]),s("div",he,[s("button",{class:"m3-button text",onClick:M=>X(b.commit),disabled:G.value},[...l[18]||(l[18]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,ke),s("button",{class:"m3-button text",onClick:M=>R(b.commit),disabled:g.value||b.is_current},[...l[19]||(l[19]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,$e)])],2))),128))])):(a(),t("div",we,[...l[20]||(l[20]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))])),(a(),ls(os,{to:"body"},[D.value?(a(),t("div",{key:0,class:"detail-dialog-overlay",onClick:l[1]||(l[1]=ns(b=>D.value=!1,["self"]))},[s("div",Ce,[s("div",Ge,[l[22]||(l[22]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:l[0]||(l[0]=b=>D.value=!1)},[...l[21]||(l[21]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),r.value?(a(),t("div",xe,[s("div",Te,[s("div",Ue,[l[23]||(l[23]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",Se,o(r.value.commit_short),1)]),r.value.version?(a(),t("div",De,[l[24]||(l[24]=s("span",{class:"detail-label"},"版本:",-1)),s("span",Ie,"v"+o(r.value.version),1)])):i("",!0),s("div",Be,[l[25]||(l[25]=s("span",{class:"detail-label"},"时间:",-1)),s("span",Re,o(L(r.value.timestamp)),1)]),r.value.author?(a(),t("div",Ve,[l[26]||(l[26]=s("span",{class:"detail-label"},"作者:",-1)),s("span",Me,o(r.value.author),1)])):i("",!0)]),r.value.message?(a(),t("div",Le,[l[27]||(l[27]=s("h4",null,"提交消息",-1)),s("p",We,o(r.value.message),1)])):i("",!0),r.value.body?(a(),t("div",Pe,[l[28]||(l[28]=s("h4",null,"更新内容",-1)),s("pre",Ne,o(r.value.body),1)])):i("",!0),(V=r.value.files_changed)!=null&&V.length?(a(),t("div",Ee,[s("h4",null,"修改文件 ("+o(r.value.files_changed.length)+")",1),s("div",Fe,[(a(!0),t(E,null,F(r.value.files_changed.slice(0,20),(b,M)=>(a(),t("div",{key:M,class:"file-item"},[s("span",{class:U(["file-status",Z(b.status)])},o(b.status),3),s("span",ze,o(b.path),1)]))),128)),r.value.files_changed.length>20?(a(),t("div",Oe," ... 及其他 "+o(r.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):G.value?(a(),t("div",Ae,[...l[29]||(l[29]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),je=es(Xe,[["__scopeId","data-v-da3800a9"]]);function hs(){return z.get("git_env/status")}function qe(){return z.post("git_env/install")}function Je(I){return z.post("git_env/set-path",{path:I})}function Ke(){return z.post("git_env/auto-detect")}function He(){return z.get("git_env/install-guide")}const Qe={class:"main-update-tab"},Ye={class:"m3-card branch-card"},Ze={key:0,class:"loading-placeholder"},sa={key:1,class:"card-disabled-hint"},ea={key:2,class:"branch-selector"},aa={class:"selected-value"},ta={key:0,class:"m3-select-dropdown m3-card"},la=["onClick"],na={key:0,class:"material-symbols-rounded check-icon"},oa={key:0,class:"switching-indicator"},ia={class:"m3-card update-card"},ua={class:"card-header"},da=["disabled"],ra={key:0,class:"loading-placeholder"},ca={key:1,class:"alert alert-warning"},va={key:2,class:"alert alert-warning"},ma={key:3,class:"update-result"},pa={key:0,class:"has-update"},_a={class:"update-header"},fa={class:"update-title"},ba={class:"version-compare"},ya={class:"version-box version-current"},ga={class:"version-box version-latest"},ha={key:0,class:"changelog"},ka={class:"update-actions"},$a=["disabled"],wa={key:1,class:"up-to-date"},Ca={class:"up-to-date-info"},Ga={key:0},xa={key:4,class:"error-message"},Ta={class:"m3-card backup-card"},Ua={class:"card-header"},Sa=["disabled"],Da={key:0,class:"loading-placeholder"},Ia={key:1,class:"card-disabled-hint"},Ba={key:2,class:"backup-list"},Ra={class:"backup-info"},Va={class:"backup-header"},Ma={class:"backup-commit"},La={key:0,class:"current-badge"},Wa={class:"backup-message"},Pa={class:"backup-meta"},Na={class:"backup-actions"},Ea=["onClick","disabled"],Fa=["onClick","disabled"],za={key:3,class:"no-backups"},Oa={class:"detail-dialog"},Aa={class:"detail-header"},Xa={key:0,class:"detail-content"},ja={class:"detail-section"},qa={class:"detail-row"},Ja={class:"detail-value"},Ka={class:"detail-row"},Ha={class:"detail-value"},Qa={key:0,class:"detail-row"},Ya={class:"detail-value"},Za={key:0,class:"detail-section"},st={class:"commit-message"},et={key:1,class:"detail-section"},at={class:"commit-body"},tt={key:2,class:"detail-section"},lt={class:"files-list"},nt={class:"file-path"},ot={key:0,class:"files-more"},it={key:1,class:"detail-content loading"},ut=ss({__name:"MainUpdateTab",emits:["update-complete"],setup(I,{expose:O,emit:c}){const x=c,v=u(null),w=u(null),p=u(null),y=u([]),g=u(""),h=u(!1),C=u(!0),D=u(!1),G=u(!1),r=u(!1),T=u(!1),k=u(!1),A=u(!1),L=u(""),m=u(!1),n=u(null),_=u(null);async function P(){try{const[d,e]=await Promise.all([hs(),$s()]);d.success&&d.data&&(v.value=d.data),e.success&&e.data&&(w.value=e.data,e.data.current_branch&&(g.value=e.data.current_branch))}catch(d){console.error("加载状态失败:",d)}}function R(){r.value||(h.value=!h.value)}async function X(d){var j,B;if(h.value=!1,!(d===g.value||!await Y({title:"切换分支",message:`确定要切换到分支 "${d}" 吗？`,confirmText:"切换"}))){r.value=!0;try{const W=await xs(d);W.success&&((j=W.data)!=null&&j.success)?(g.value=d,K(W.data.message||"分支切换成功"),x("update-complete",!0)):S(((B=W.data)==null?void 0:B.error)||W.error||"切换分支失败")}catch(W){S(W.message||"切换分支失败")}finally{r.value=!1}}}async function Z(){D.value=!0,L.value="",p.value=null;try{const d=await ws();d.success&&d.data?(p.value=d.data,d.data.success||(L.value=d.data.error||"检查更新失败")):L.value=d.error||"检查更新失败"}catch(d){L.value=d.message||"检查更新失败"}finally{D.value=!1}}async function f(){var e,j;if(await Y({title:"确认更新",message:"更新主程序后需要重启才能生效，是否继续？",confirmText:"更新"})){G.value=!0,L.value="";try{const B=await Cs(!0,!0,!0);B.success&&((e=B.data)!=null&&e.success)?(K(B.data.message||"更新成功"),x("update-complete",!0),l()):S(((j=B.data)==null?void 0:j.error)||B.error||"更新失败")}catch(B){S(B.message||"更新失败")}finally{G.value=!1}}}async function l(){var d;k.value=!0;try{const e=await Gs();e.success&&((d=e.data)!=null&&d.data)&&(y.value=e.data.data)}catch(e){console.error("加载历史版本列表失败:",e)}finally{k.value=!1}}async function q(d){var B,W;const e=d.substring(0,7);if(await Y({title:"确认回滚",message:`确定要回滚到版本 "${e}" 吗？此操作将重置到该版本，回滚后需要重启程序。`,confirmText:"回滚"})){T.value=!0;try{const N=await Ts(d);N.success&&((B=N.data)!=null&&B.success)?(K(N.data.message||"回滚成功"),x("update-complete",!0),l()):S(((W=N.data)==null?void 0:W.error)||N.error||"回滚失败")}catch(N){S(N.message||"回滚失败")}finally{T.value=!1}}}async function V(d){m.value=!0,A.value=!0,n.value=null;try{const e=await Us(d);e.success&&e.data?n.value=e.data:(S(e.error||"获取详情失败"),m.value=!1)}catch(e){S(e.message||"获取详情失败"),m.value=!1}finally{A.value=!1}}function b(d){if(!d)return"-";try{return new Date(d).toLocaleString("zh-CN")}catch{return d}}function M(d){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[d]||""}function us(d){_.value&&!_.value.contains(d.target)&&(h.value=!1)}return ts(async()=>{var d,e;document.addEventListener("click",us);try{await P(),l(),(d=v.value)!=null&&d.git_available&&((e=w.value)!=null&&e.is_git_repo)&&Z()}finally{C.value=!1}}),ks(()=>{document.removeEventListener("click",us)}),O({refresh:()=>{P(),l(),p.value=null}}),(d,e)=>{var j,B,W,N,ds,rs,cs,vs,ms,ps,_s,fs;return a(),t("div",Qe,[s("div",Ye,[e[6]||(e[6]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"fork_right"),s("h3",null,"分支管理")],-1)),C.value?(a(),t("div",Ze,[...e[2]||(e[2]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((j=v.value)!=null&&j.git_available)||(((W=(B=w.value)==null?void 0:B.available_branches)==null?void 0:W.length)??0)===0?(a(),t("div",sa,[e[3]||(e[3]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o((N=v.value)!=null&&N.git_available?"无可用分支":"Git 环境不可用"),1)])):(a(),t("div",ea,[e[5]||(e[5]=s("label",{class:"m3-label"},"当前分支:",-1)),s("div",{class:"select-wrapper",ref_key:"branchSelectWrapper",ref:_},[s("div",{class:U(["m3-select-trigger",{disabled:r.value,active:h.value}]),onClick:R},[s("span",aa,o(g.value),1),s("span",{class:U(["material-symbols-rounded select-arrow",{rotated:h.value}])}," arrow_drop_down ",2)],2),h.value?(a(),t("div",ta,[(a(!0),t(E,null,F(((ds=w.value)==null?void 0:ds.available_branches)??[],$=>(a(),t("div",{key:$,class:U(["m3-select-option",{selected:$===g.value}]),onClick:H=>X($)},[s("span",null,o($),1),$===g.value?(a(),t("span",na,"check")):i("",!0)],10,la))),128))])):i("",!0)],512),r.value?(a(),t("span",oa,[...e[4]||(e[4]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),gs(" 切换中... ",-1)])])):i("",!0)]))]),s("div",ia,[s("div",ua,[e[7]||(e[7]=s("span",{class:"material-symbols-rounded"},"sync",-1)),e[8]||(e[8]=s("h3",null,"更新检测",-1)),s("button",{class:"m3-button tonal",onClick:Z,disabled:C.value||D.value||!((rs=v.value)!=null&&rs.git_available)},[s("span",{class:U(["material-symbols-rounded",{spinning:D.value}])},o(D.value?"progress_activity":"refresh"),3),s("span",null,o(D.value?"检查中...":"检查更新"),1)],8,da)]),C.value||D.value?(a(),t("div",ra,[e[9]||(e[9]=s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1)),s("span",null,o(C.value?"加载中...":"检查更新中..."),1)])):v.value&&!v.value.git_available?(a(),t("div",ca,[...e[10]||(e[10]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,'Git 不可用，请先在"Git 设置"中配置 Git 环境',-1)])])):w.value&&!w.value.is_git_repo?(a(),t("div",va,[...e[11]||(e[11]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,"主程序目录不是 Git 仓库，无法使用自动更新功能",-1)])])):p.value?(a(),t("div",ma,[p.value.has_update?(a(),t("div",pa,[s("div",_a,[e[13]||(e[13]=s("div",{class:"update-icon"},[s("span",{class:"material-symbols-rounded"},"auto_awesome")],-1)),s("div",fa,[e[12]||(e[12]=s("h4",null,"发现新版本",-1)),s("p",null,"有 "+o(p.value.commits_behind)+" 个新提交等待更新",1)])]),s("div",ba,[s("div",ya,[e[14]||(e[14]=s("span",{class:"version-tag"},"当前",-1)),s("code",null,o(p.value.current_commit||"未知"),1)]),e[16]||(e[16]=s("span",{class:"material-symbols-rounded arrow-icon"},"arrow_forward",-1)),s("div",ga,[e[15]||(e[15]=s("span",{class:"version-tag"},"最新",-1)),s("code",null,o(p.value.remote_commit||"未知"),1)])]),(cs=p.value.update_logs)!=null&&cs.length?(a(),t("div",ha,[e[17]||(e[17]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),t(E,null,F(p.value.update_logs.slice(0,5),($,H)=>(a(),t("li",{key:H},o($),1))),128))])])):i("",!0),s("div",ka,[s("button",{class:"m3-button filled",onClick:f,disabled:G.value},[s("span",{class:U(["material-symbols-rounded",{spinning:G.value}])},o(G.value?"progress_activity":"download"),3),s("span",null,o(G.value?"更新中...":"立即更新"),1)],8,$a)])])):(a(),t("div",wa,[e[19]||(e[19]=s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1)),s("div",Ca,[e[18]||(e[18]=s("span",null,"已是最新版本",-1)),p.value.current_commit?(a(),t("code",Ga,o(p.value.current_commit),1)):i("",!0)])]))])):i("",!0),L.value?(a(),t("div",xa,[e[20]||(e[20]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,o(L.value),1)])):i("",!0)]),s("div",Ta,[s("div",Ua,[e[21]||(e[21]=s("span",{class:"material-symbols-rounded"},"history",-1)),e[22]||(e[22]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:l,disabled:C.value||k.value||!((vs=v.value)!=null&&vs.git_available)},[s("span",{class:U(["material-symbols-rounded",{spinning:k.value}])},"refresh",2)],8,Sa)]),C.value||k.value?(a(),t("div",Da,[...e[23]||(e[23]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((ms=v.value)!=null&&ms.git_available)||!((ps=w.value)!=null&&ps.is_git_repo)?(a(),t("div",Ia,[e[24]||(e[24]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o((_s=v.value)!=null&&_s.git_available?"当前目录非 Git 仓库":"Git 环境不可用"),1)])):y.value.length?(a(),t("div",Ba,[(a(!0),t(E,null,F(y.value,$=>(a(),t("div",{key:$.commit,class:U(["backup-item",{"is-current":$.is_current}])},[s("div",Ra,[s("div",Va,[s("code",Ma,o($.commit_short),1),$.is_current?(a(),t("span",La,"当前")):i("",!0)]),s("span",Wa,o($.message),1),s("span",Pa,o(b($.timestamp)),1)]),s("div",Na,[s("button",{class:"m3-button text",onClick:H=>V($.commit),disabled:A.value},[...e[25]||(e[25]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,Ea),s("button",{class:"m3-button text",onClick:H=>q($.commit),disabled:T.value||$.is_current},[...e[26]||(e[26]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,Fa)])],2))),128))])):(a(),t("div",za,[...e[27]||(e[27]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))]),(a(),ls(os,{to:"body"},[m.value?(a(),t("div",{key:0,class:"detail-dialog-overlay",onClick:e[1]||(e[1]=ns($=>m.value=!1,["self"]))},[s("div",Oa,[s("div",Aa,[e[29]||(e[29]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:e[0]||(e[0]=$=>m.value=!1)},[...e[28]||(e[28]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),n.value?(a(),t("div",Xa,[s("div",ja,[s("div",qa,[e[30]||(e[30]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",Ja,o(n.value.commit_short),1)]),s("div",Ka,[e[31]||(e[31]=s("span",{class:"detail-label"},"时间:",-1)),s("span",Ha,o(b(n.value.timestamp)),1)]),n.value.author?(a(),t("div",Qa,[e[32]||(e[32]=s("span",{class:"detail-label"},"作者:",-1)),s("span",Ya,o(n.value.author),1)])):i("",!0)]),n.value.message?(a(),t("div",Za,[e[33]||(e[33]=s("h4",null,"提交消息",-1)),s("p",st,o(n.value.message),1)])):i("",!0),n.value.body?(a(),t("div",et,[e[34]||(e[34]=s("h4",null,"更新内容",-1)),s("pre",at,o(n.value.body),1)])):i("",!0),(fs=n.value.files_changed)!=null&&fs.length?(a(),t("div",tt,[s("h4",null,"修改文件 ("+o(n.value.files_changed.length)+")",1),s("div",lt,[(a(!0),t(E,null,F(n.value.files_changed.slice(0,20),($,H)=>(a(),t("div",{key:H,class:"file-item"},[s("span",{class:U(["file-status",M($.status)])},o($.status),3),s("span",nt,o($.path),1)]))),128)),n.value.files_changed.length>20?(a(),t("div",ot," ... 及其他 "+o(n.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):A.value?(a(),t("div",it,[...e[35]||(e[35]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),dt=es(ut,[["__scopeId","data-v-3b534a2a"]]),rt={class:"git-settings-tab"},ct={class:"m3-card status-card"},vt={class:"card-header"},mt=["disabled"],pt={key:0,class:"status-grid"},_t={class:"status-item"},ft={class:"material-symbols-rounded"},bt={key:0,class:"status-item"},yt={class:"status-value"},gt={class:"status-item"},ht={class:"status-value"},kt={class:"status-item"},$t={class:"status-value"},wt={key:0,class:"m3-card path-card"},Ct={class:"path-content"},Gt={class:"path-display"},xt={class:"path-value"},Tt={class:"path-actions"},Ut=["disabled"],St=["disabled"],Dt={key:0,class:"portable-tip"},It={key:2,class:"m3-card guide-card"},Bt={key:0,class:"guide-content"},Rt={key:0,class:"guide-commands"},Vt={class:"command-name"},Mt={class:"command-value"},Lt=["href"],Wt={class:"modal-content m3-card"},Pt={class:"modal-header"},Nt={class:"modal-body"},Et={class:"input-wrapper"},Ft={class:"modal-footer"},zt=["disabled"],Ot=ss({__name:"GitSettingsTab",setup(I,{expose:O}){const c=u(null),x=u(null),v=u(!1),w=u(!1),p=u(!1),y=u(!1),g=u(!1),h=u("");function C(m){return{custom:"自定义",portable:"便携版",system:"系统",unknown:"未知"}[m]||m}function D(){var n;switch((n=c.value)==null?void 0:n.system_os){case"Windows":return"下载便携版";case"Linux":return"安装 Git";case"Darwin":return"安装 Git";default:return"安装 Git"}}function G(){var n;switch((n=c.value)==null?void 0:n.system_os){case"Windows":return'未检测到 Git，可以点击上方"下载便携版"按钮安装';case"Linux":return'未检测到 Git，点击"安装 Git"将使用系统包管理器安装';case"Darwin":return'未检测到 Git，点击"安装 Git"将使用 Homebrew 或 Xcode 安装';default:return"未检测到 Git，请手动安装"}}async function r(){v.value=!0;try{const m=await hs();m.success&&m.data&&(c.value=m.data,!m.data.git_available&&m.data.system_os!=="Windows"&&T())}catch(m){console.error("加载 Git 状态失败:",m)}finally{v.value=!1}}async function T(){var m;try{const n=await He();n.success&&((m=n.data)!=null&&m.data)&&(x.value=n.data.data)}catch(n){console.error("加载安装指南失败:",n)}}async function k(){var m,n;y.value=!0;try{const _=await Ke();_.success&&((m=_.data)!=null&&m.success)?(K(_.data.message||"已检测到 Git"),await r()):S(((n=_.data)==null?void 0:n.error)||_.error||"未检测到 Git")}catch(_){S(_.message||"检测失败")}finally{y.value=!1}}async function A(){var m,n,_,P;if((m=c.value)!=null&&m.git_available){const R=(n=c.value)==null?void 0:n.system_os;let X=`检测到您的电脑已经安装了 Git。

`;if(R==="Windows"?X+="便携版 Git 适用于没有安装 Git 的用户，如果您已经有 Git，通常不需要再下载。":R==="Linux"?X+="系统将尝试使用包管理器重新安装 Git，这可能会覆盖现有版本。":R==="Darwin"&&(X+="系统将尝试使用 Homebrew 或 Xcode 安装 Git，这可能会覆盖现有版本。"),X+=`

确定要继续吗？`,!await Y({title:"确认安装",message:X,type:"warning",confirmText:"继续安装",cancelText:"取消"}))return}w.value=!0;try{const R=await qe();R.success&&((_=R.data)!=null&&_.success)?(K(R.data.message||"Git 安装成功"),await k()):S(((P=R.data)==null?void 0:P.error)||R.error||"安装失败")}catch(R){S(R.message||"安装失败")}finally{w.value=!1}}async function L(){var m,n;if(h.value){p.value=!0;try{const _=await Je(h.value);_.success&&((m=_.data)!=null&&m.success)?(K(_.data.message||"路径设置成功"),g.value=!1,h.value="",await r()):S(((n=_.data)==null?void 0:n.error)||_.error||"设置失败")}catch(_){S(_.message||"设置失败")}finally{p.value=!1}}}return ts(()=>{r()}),O({refresh:r}),(m,n)=>(a(),t("div",rt,[s("div",ct,[s("div",vt,[n[5]||(n[5]=s("span",{class:"material-symbols-rounded"},"terminal",-1)),n[6]||(n[6]=s("h3",null,"Git 环境状态",-1)),s("button",{class:"m3-icon-button",onClick:r,disabled:v.value},[s("span",{class:U(["material-symbols-rounded",{spinning:v.value}])},"refresh",2)],8,mt)]),c.value?(a(),t("div",pt,[s("div",_t,[n[7]||(n[7]=s("span",{class:"status-label"},"状态",-1)),s("span",{class:U(["status-value",c.value.git_available?"success":"error"])},[s("span",ft,o(c.value.git_available?"check_circle":"cancel"),1),gs(" "+o(c.value.git_available?"可用":"不可用"),1)],2)]),c.value.git_version?(a(),t("div",bt,[n[8]||(n[8]=s("span",{class:"status-label"},"版本",-1)),s("span",yt,o(c.value.git_version),1)])):i("",!0),s("div",gt,[n[9]||(n[9]=s("span",{class:"status-label"},"来源",-1)),s("span",ht,[s("span",{class:U(["m3-badge",`source-${c.value.git_source}`])},o(C(c.value.git_source)),3)])]),s("div",kt,[n[10]||(n[10]=s("span",{class:"status-label"},"操作系统",-1)),s("span",$t,o(c.value.system_os),1)])])):i("",!0)]),c.value?(a(),t("div",wt,[n[14]||(n[14]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"folder"),s("h3",null,"Git 路径")],-1)),s("div",Ct,[s("div",Gt,[n[11]||(n[11]=s("span",{class:"path-label"},"当前路径:",-1)),s("code",xt,o(c.value.git_path||"未检测到"),1)]),s("div",Tt,[s("button",{class:"m3-button tonal",onClick:k,disabled:y.value},[s("span",{class:U(["material-symbols-rounded",{spinning:y.value}])},o(y.value?"progress_activity":"search"),3),s("span",null,o(y.value?"检测中...":"自动寻找"),1)],8,Ut),s("button",{class:"m3-button tonal",onClick:n[0]||(n[0]=_=>g.value=!0)},[...n[12]||(n[12]=[s("span",{class:"material-symbols-rounded"},"edit",-1),s("span",null,"设置路径",-1)])]),s("button",{class:U(["m3-button",c.value.git_available?"tonal":"filled"]),onClick:A,disabled:w.value},[s("span",{class:U(["material-symbols-rounded",{spinning:w.value}])},o(w.value?"progress_activity":"download"),3),s("span",null,o(w.value?"安装中...":D()),1)],10,St)]),c.value.git_available?i("",!0):(a(),t("div",Dt,[n[13]||(n[13]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o(G()),1)]))])])):i("",!0),i("",!0),c.value&&!c.value.git_available&&c.value.system_os!=="Windows"?(a(),t("div",It,[n[18]||(n[18]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"help"),s("h3",null,"安装指南")],-1)),x.value?(a(),t("div",Bt,[s("p",null,o(x.value.description),1),x.value.manual_commands?(a(),t("div",Rt,[(a(!0),t(E,null,F(x.value.manual_commands,(_,P)=>(a(),t("div",{key:P,class:"command-item"},[s("span",Vt,o(P)+":",1),s("code",Mt,o(_),1)]))),128))])):i("",!0),x.value.manual_url?(a(),t("a",{key:1,href:x.value.manual_url,target:"_blank",class:"m3-button tonal"},[...n[17]||(n[17]=[s("span",{class:"material-symbols-rounded"},"open_in_new",-1),s("span",null,"官方下载",-1)])],8,Lt)):i("",!0)])):i("",!0)])):i("",!0),(a(),ls(os,{to:"body"},[g.value?(a(),t("div",{key:0,class:"modal-overlay",onClick:n[4]||(n[4]=ns(_=>g.value=!1,["self"]))},[s("div",Wt,[s("div",Pt,[n[20]||(n[20]=s("h3",null,"设置 Git 路径",-1)),s("button",{class:"m3-icon-button",onClick:n[1]||(n[1]=_=>g.value=!1)},[...n[19]||(n[19]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),s("div",Nt,[n[21]||(n[21]=s("p",null,"请输入 Git 可执行文件的完整路径",-1)),s("div",Et,[as(s("input",{type:"text","onUpdate:modelValue":n[2]||(n[2]=_=>h.value=_),placeholder:"例如: C:\\Program Files\\Git\\bin\\git.exe",class:"m3-input"},null,512),[[Ss,h.value]])])]),s("div",Ft,[s("button",{class:"m3-button text",onClick:n[3]||(n[3]=_=>g.value=!1)},"取消"),s("button",{class:"m3-button filled",onClick:L,disabled:!h.value||p.value},o(p.value?"设置中...":"确定"),9,zt)])])])):i("",!0)]))]))}}),At=es(Ot,[["__scopeId","data-v-f68aa1d1"]]),Xt={key:0,class:"dialog-content m3-card"},jt={class:"dialog-header"},qt={class:"material-symbols-rounded"},Jt={class:"dialog-body"},Kt={class:"dialog-message"},Ht={key:0,class:"changelog-section"},Qt={class:"changelog-list"},Yt={class:"tip-section"},Zt=ss({__name:"RestartDialog",props:{modelValue:{type:Boolean},updateType:{default:"main"},changelog:{default:()=>[]}},emits:["update:modelValue","restart","later"],setup(I,{emit:O}){const c=I,x=O,v=J(()=>({main:"type-main",ui:"type-ui",both:"type-both"})[c.updateType]),w=J(()=>({main:"smart_toy",ui:"web",both:"system_update"})[c.updateType]),p=J(()=>({main:"主程序更新完成",ui:"UI 更新完成",both:"全部更新完成"})[c.updateType]),y=J(()=>({main:"主程序已更新成功，需要重启才能生效。",ui:"WebUI 已更新成功，需要刷新页面才能生效。",both:"主程序和 WebUI 都已更新成功，需要重启才能生效。"})[c.updateType]),g=J(()=>c.updateType==="ui"?"刷新页面后将加载新版本的 WebUI":"重启后新功能将生效，当前的连接会暂时中断");function h(){x("restart"),x("update:modelValue",!1)}function C(){x("later"),x("update:modelValue",!1)}return(D,G)=>(a(),ls(os,{to:"body"},[Q(bs,{name:"fade"},{default:ys(()=>[I.modelValue?(a(),t("div",{key:0,class:"dialog-overlay",onClick:ns(C,["self"])},[Q(bs,{name:"scale"},{default:ys(()=>[I.modelValue?(a(),t("div",Xt,[s("div",jt,[s("div",{class:U(["dialog-icon",v.value])},[s("span",qt,o(w.value),1)],2),s("h2",null,o(p.value),1)]),s("div",Jt,[s("p",Kt,o(y.value),1),I.changelog&&I.changelog.length>0?(a(),t("div",Ht,[G[0]||(G[0]=s("h4",null,"更新内容:",-1)),s("ul",Qt,[(a(!0),t(E,null,F(I.changelog.slice(0,5),(r,T)=>(a(),t("li",{key:T},o(r),1))),128))])])):i("",!0),s("div",Yt,[G[1]||(G[1]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o(g.value),1)])]),s("div",{class:"dialog-footer"},[s("button",{class:"m3-button text",onClick:C}," 稍后重启 "),s("button",{class:"m3-button filled",onClick:h},[...G[2]||(G[2]=[s("span",{class:"material-symbols-rounded"},"restart_alt",-1),s("span",null,"立即重启",-1)])])])])):i("",!0)]),_:1})])):i("",!0)]),_:1})]))}}),sl=es(Zt,[["__scopeId","data-v-8bea0f4d"]]),el={class:"update-view"},al={class:"tabs-nav"},tl=["onClick"],ll={class:"material-symbols-rounded"},nl={class:"tab-label"},ol={class:"tab-content"},il=ss({__name:"GitUpdateView",setup(I){const O=[{id:"ui",label:"UI 更新",icon:"web"},{id:"main",label:"主程序",icon:"terminal"},{id:"git",label:"Git 设置",icon:"settings"}],c=u("ui"),x=u(null),v=u(null),w=u(null),p=u(!1),y=u("main"),g=u([]);function h(r){r&&(y.value="ui",g.value=[],p.value=!0)}function C(r){r&&(y.value="main",g.value=[],p.value=!0)}async function D(){p.value=!1;try{await Is()}catch(r){console.error("重启失败:",r)}}function G(){p.value=!1}return ts(()=>{}),(r,T)=>(a(),t("div",el,[T[1]||(T[1]=Ds('<div class="page-header" data-v-175b5b3e><div class="header-content" data-v-175b5b3e><div class="header-icon" data-v-175b5b3e><span class="material-symbols-rounded" data-v-175b5b3e>system_update</span></div><div class="header-text" data-v-175b5b3e><h1 data-v-175b5b3e>更新管理</h1><p data-v-175b5b3e>管理 MoFox-Bot 和 WebUI 的更新</p></div></div></div>',1)),s("div",al,[(a(),t(E,null,F(O,k=>s("button",{key:k.id,class:U(["tab-item",{active:c.value===k.id}]),onClick:A=>c.value=k.id},[s("span",ll,o(k.icon),1),s("span",nl,o(k.label),1)],10,tl)),64))]),s("div",ol,[as(Q(je,{ref_key:"uiUpdateTabRef",ref:x,onUpdateComplete:h},null,512),[[is,c.value==="ui"]]),as(Q(dt,{ref_key:"mainUpdateTabRef",ref:v,onUpdateComplete:C},null,512),[[is,c.value==="main"]]),as(Q(At,{ref_key:"gitSettingsTabRef",ref:w},null,512),[[is,c.value==="git"]])]),Q(sl,{modelValue:p.value,"onUpdate:modelValue":T[0]||(T[0]=k=>p.value=k),"update-type":y.value,changelog:g.value,onRestart:D,onLater:G},null,8,["modelValue","update-type","changelog"])]))}}),dl=es(il,[["__scopeId","data-v-175b5b3e"]]);export{dl as default};
