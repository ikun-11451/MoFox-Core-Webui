import{a2 as L,aH as ie,d as ce,z as d,c as I,o as ue,A as de,w as me,l as a,q as t,O as j,P as A,F as U,D as E,m as p,v as m,B as $,R,p as H,n as J,y as r,u as K,_ as _e}from"./index-2cLGT6AP.js";async function ve(i=100){try{const l=await L.get(`live_chat/streams?limit=${i}`);if(l.success&&l.data){const o=l.data;if(o.success&&o.streams)return o.streams}return[]}catch(l){return console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",l),[]}}async function pe(i,l=24,o=200){try{const _=await L.get(`live_chat/messages/${i}?hours=${l}&limit=${o}`);if(_.success&&_.data){const v=_.data;if(v.success&&v.messages)return v.messages}return[]}catch(_){return console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",_),[]}}async function fe(i){try{const l=await L.post("live_chat/send",{stream_id:i.stream_id,content:i.content,message_type:i.message_type||"text",reply_to_id:i.reply_to_id});if(l.success&&l.data){const o=l.data;return o.success?{success:!0,messageId:o.message_id}:{success:!1,error:o.error||"å‘é€å¤±è´¥"}}return{success:!1,error:l.error||"è¯·æ±‚å¤±è´¥"}}catch(l){return console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",l),{success:!1,error:String(l)}}}function ge(i){return i?`/plugins/webui_backend/live_chat/image/${i}`:""}function ye(i){return i?`/plugins/webui_backend/live_chat/emoji/${i}`:""}async function be(){const i=await ie(),l=localStorage.getItem("mofox_token")||"";return`ws://${i.host}:${i.port}/plugins/webui_backend/live_chat/realtime?token=${encodeURIComponent(l)}`}function he(i){return i.replace(/token=[^&]+/,"token=***")}const ke={class:"live-chat-view"},we={class:"stream-panel m3-card"},Se={class:"search-box"},Ce={class:"platform-filter"},$e=["onClick"],Me={class:"stream-list"},Te=["onClick"],xe={class:"stream-icon"},We={class:"material-symbols-rounded"},Ne={class:"stream-info"},Ie={class:"stream-header-row"},Ue={class:"stream-name"},Ee={key:0,class:"last-active"},Le={class:"stream-meta"},De={class:"platform-badge"},Pe={key:0,class:"unread-badge"},Oe={key:0,class:"empty-state"},ze={class:"chat-panel"},Be={class:"chat-header m3-card"},Ve={key:0,class:"header-content"},je={class:"stream-icon large"},Ae={class:"material-symbols-rounded"},Re={class:"stream-info"},He={class:"stream-id"},Je={key:1,class:"header-placeholder"},Ke={class:"header-actions"},Fe={class:"material-symbols-rounded"},Qe={key:0,class:"welcome-state"},Xe={key:1,class:"loading-state"},Ge={key:2,class:"messages-list"},Ye=["onClick"],Ze={class:"reply-text"},qe={class:"message-header"},es={class:"user-name"},ss={key:0,class:"sender-badge bot"},ts={key:1,class:"sender-badge webui"},ns={class:"message-time"},os={class:"message-content"},as=["src","onClick"],rs=["src"],ls={key:2,class:"text-content"},is={key:0,class:"empty-messages"},cs={key:0,class:"input-area m3-card"},us={class:"input-toolbar"},ds={class:"input-wrapper"},ms=["onKeydown"],_s=["disabled"],F=10,vs=ce({__name:"LiveChatView",setup(i){const l=d([]),o=d(null),_=d(""),v=d(""),D=d(!1),y=d(new Map),M=d(!1),b=d({}),f=d(""),w=d(!1),Q=d(!1),X=d(!1),h=d(!1);let c=null,T=null,k=0,S=null;const C=d(null),G=d(new Map),Y=I(()=>{const n=new Set([""]);return l.value.forEach(e=>{e.platform&&n.add(e.platform)}),Array.from(n)}),P=I(()=>l.value.filter(n=>{if(v.value&&n.platform!==v.value)return!1;if(_.value){const e=_.value.toLowerCase(),s=(n.group_name||n.user_nickname||"").toLowerCase(),u=n.stream_id.toLowerCase();if(!s.includes(e)&&!u.includes(e))return!1}return!0})),x=I(()=>o.value?y.value.get(o.value.stream_id)||[]:[]);async function O(){D.value=!0;try{l.value=await ve(100)}catch(n){console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",n)}finally{D.value=!1}}function Z(n){o.value=n,b.value[n.stream_id]=0,W(),ee(n.stream_id)}async function W(){if(o.value){M.value=!0;try{const n=o.value.stream_id,e=await pe(n,24,200);console.log(`åŠ è½½èŠå¤©æµ ${n} çš„åŽ†å²æ¶ˆæ¯ï¼Œå…± ${e.length} æ¡`),y.value.set(n,e),await J(),V()}catch(n){console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",n)}finally{M.value=!1}}}async function z(){if(!(!f.value.trim()||!o.value||w.value)){w.value=!0;try{const n=await fe({stream_id:o.value.stream_id,content:f.value.trim(),message_type:"text"});n.success?f.value="":console.error("å‘é€å¤±è´¥:",n.error)}catch(n){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",n)}finally{w.value=!1}}}async function B(){if((c==null?void 0:c.readyState)!==WebSocket.OPEN)try{const n=await be();console.log("è¿žæŽ¥ WebSocket:",he(n)),c=new WebSocket(n),c.onopen=()=>{var s;console.log("WebSocket å·²è¿žæŽ¥"),h.value=!0,k=0;const e=S||((s=o.value)==null?void 0:s.stream_id);e&&(c.send(JSON.stringify({type:"subscribe",stream_id:e})),S=null)},c.onmessage=e=>{try{const s=JSON.parse(e.data);q(s)}catch(s){e.data!=="pong"&&console.error("è§£æž WebSocket æ¶ˆæ¯å¤±è´¥:",s)}},c.onclose=()=>{console.log("WebSocket å·²æ–­å¼€"),h.value=!1,se()},c.onerror=e=>{console.error("WebSocket é”™è¯¯:",e)}}catch(n){console.error("è¿žæŽ¥ WebSocket å¤±è´¥:",n)}}function q(n){var e;if(n.type==="message"){const s=n,u=s.stream_id;if(!u)return;y.value.has(u)||y.value.set(u,[]);const g=y.value.get(u);g.some(N=>N.message_id===s.message_id)||(g.push(s),((e=o.value)==null?void 0:e.stream_id)===u?J(()=>V()):b.value[u]=(b.value[u]||0)+1)}else n.type==="subscribed"&&console.log("å·²è®¢é˜…èŠå¤©æµ:",n.stream_id)}function ee(n){(c==null?void 0:c.readyState)===WebSocket.OPEN?(c.send(JSON.stringify({type:"subscribe",stream_id:n})),S=null):(S=n,console.log("å¾…è®¢é˜…èŠå¤©æµ:",n))}function se(){if(k>=F){console.error("WebSocket é‡è¿žæ¬¡æ•°è¶…è¿‡é™åˆ¶");return}const n=Math.min(1e3*Math.pow(2,k),3e4);k++,console.log(`å°†åœ¨ ${n}ms åŽé‡è¿ž (å°è¯• ${k}/${F})`),T=window.setTimeout(()=>{B()},n)}function te(){setInterval(()=>{(c==null?void 0:c.readyState)===WebSocket.OPEN&&c.send("ping")},3e4)}function V(){C.value&&(C.value.scrollTop=C.value.scrollHeight)}function ne(n){console.log("æ»šåŠ¨åˆ°æ¶ˆæ¯:",n)}function oe(n){var u,g;const e=G.value.get(n);if(e)return`${e.user_nickname}: ${(u=e.content)==null?void 0:u.slice(0,30)}...`;const s=x.value.find(N=>N.message_id===n);return s?`${s.user_nickname}: ${(g=s.content)==null?void 0:g.slice(0,30)}...`:"æŸ¥çœ‹åŽŸæ¶ˆæ¯"}function ae(n){console.log("é¢„è§ˆå›¾ç‰‡:",n)}function re(n){if(!n)return"";const e=new Date(n*1e3),s=new Date;return e.toDateString()===s.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}function le(n){return n?new Date(n*1e3).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):""}return ue(()=>{O(),B(),te()}),de(()=>{c&&(c.close(),c=null),T&&clearTimeout(T)}),me(o,n=>{n&&W()}),(n,e)=>(r(),a("div",ke,[t("aside",we,[t("div",{class:"panel-header"},[e[6]||(e[6]=t("div",{class:"header-content"},[t("span",{class:"material-symbols-rounded"},"forum"),t("h2",null,"èŠå¤©æµ")],-1)),t("button",{class:"m3-button icon-only",onClick:O,title:"åˆ·æ–°åˆ—è¡¨"},[...e[5]||(e[5]=[t("span",{class:"material-symbols-rounded"},"refresh",-1)])])]),t("div",Se,[e[7]||(e[7]=t("span",{class:"material-symbols-rounded"},"search",-1)),j(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>_.value=s),type:"text",placeholder:"æœç´¢èŠå¤©æµ..."},null,512),[[A,_.value]])]),t("div",Ce,[(r(!0),a(U,null,E(Y.value,s=>(r(),a("button",{key:s,class:$(["filter-chip",{active:v.value===s}]),onClick:u=>v.value=v.value===s?"":s},m(s||"å…¨éƒ¨"),11,$e))),128))]),t("div",Me,[(r(!0),a(U,null,E(P.value,s=>{var u;return r(),a("div",{key:s.stream_id,class:$(["stream-item",{active:((u=o.value)==null?void 0:u.stream_id)===s.stream_id}]),onClick:g=>Z(s)},[t("div",xe,[t("span",We,m(s.group_id?"group":"person"),1)]),t("div",Ne,[t("div",Ie,[t("div",Ue,m(s.group_name||s.user_nickname||"æœªçŸ¥"),1),s.last_active_time?(r(),a("span",Ee,m(re(s.last_active_time)),1)):p("",!0)]),t("div",Le,[t("span",De,m(s.platform),1)])]),b.value[s.stream_id]?(r(),a("div",Pe,m(b.value[s.stream_id]),1)):p("",!0)],10,Te)}),128)),P.value.length===0?(r(),a("div",Oe,[...e[8]||(e[8]=[t("span",{class:"material-symbols-rounded"},"inbox",-1),t("p",null,"æš‚æ— èŠå¤©æµ",-1)])])):p("",!0)])]),t("main",ze,[t("header",Be,[o.value?(r(),a("div",Ve,[t("div",je,[t("span",Ae,m(o.value.group_id?"group":"person"),1)]),t("div",Re,[t("h2",null,m(o.value.group_name||o.value.user_nickname||"æœªçŸ¥"),1),t("p",He,m(o.value.stream_id),1)])])):(r(),a("div",Je,[...e[9]||(e[9]=[t("span",{class:"material-symbols-rounded"},"chat",-1),t("span",null,"å³æ—¶é€šè®¯",-1)])])),t("div",Ke,[t("div",{class:$(["connection-status",{connected:h.value}])},[t("span",Fe,m(h.value?"wifi":"wifi_off"),1),t("span",null,m(h.value?"å·²è¿žæŽ¥":"æœªè¿žæŽ¥"),1)],2),t("button",{class:"m3-button icon-only",onClick:W,title:"åŠ è½½åŽ†å²æ¶ˆæ¯"},[...e[10]||(e[10]=[t("span",{class:"material-symbols-rounded"},"history",-1)])])])]),t("div",{class:"messages-container",ref_key:"messagesContainer",ref:C},[o.value?M.value?(r(),a("div",Xe,[...e[12]||(e[12]=[t("div",{class:"spinner"},null,-1),t("p",null,"åŠ è½½æ¶ˆæ¯ä¸­...",-1)])])):(r(),a("div",Ge,[(r(!0),a(U,null,E(x.value,s=>(r(),a("div",{key:s.message_id,class:$(["message",{"is-incoming":s.direction==="incoming","is-outgoing":s.direction==="outgoing","is-bot":s.sender_type==="bot","is-webui":s.sender_type==="webui"}])},[s.reply_to_id?(r(),a("div",{key:0,class:"reply-preview",onClick:u=>ne(s.reply_to_id)},[e[13]||(e[13]=t("span",{class:"material-symbols-rounded"},"reply",-1)),t("span",Ze,m(oe(s.reply_to_id)),1)],8,Ye)):p("",!0),t("div",qe,[t("span",es,m(s.user_nickname||"æœªçŸ¥ç”¨æˆ·"),1),s.sender_type==="bot"?(r(),a("span",ss,"ðŸ¤– Bot")):p("",!0),s.sender_type==="webui"?(r(),a("span",ts,"ðŸ“± WebUI")):p("",!0),t("span",ns,m(le(s.timestamp)),1)]),t("div",os,[s.is_picid&&s.content?(r(),a("img",{key:0,src:K(ge)(s.content),class:"message-image",onClick:u=>ae(s.content||""),loading:"lazy"},null,8,as)):s.is_emoji?(r(),a("img",{key:1,src:K(ye)(s.content),class:"message-emoji"},null,8,rs)):(r(),a("span",ls,m(s.content||s.display_message),1))])],2))),128)),x.value.length===0?(r(),a("div",is,[...e[14]||(e[14]=[t("span",{class:"material-symbols-rounded"},"chat_bubble_outline",-1),t("p",null,"æš‚æ— æ¶ˆæ¯",-1)])])):p("",!0)])):(r(),a("div",Qe,[...e[11]||(e[11]=[t("span",{class:"material-symbols-rounded"},"forum",-1),t("h3",null,"å³æ—¶é€šè®¯",-1),t("p",null,"é€‰æ‹©ä¸€ä¸ªèŠå¤©æµæŸ¥çœ‹å®žæ—¶æ¶ˆæ¯",-1)])]))],512),o.value?(r(),a("div",cs,[t("div",us,[t("button",{class:"m3-icon-button",onClick:e[1]||(e[1]=s=>Q.value=!0),title:"å‘é€å›¾ç‰‡"},[...e[15]||(e[15]=[t("span",{class:"material-symbols-rounded"},"image",-1)])]),t("button",{class:"m3-icon-button",onClick:e[2]||(e[2]=s=>X.value=!0),title:"å‘é€è¡¨æƒ…"},[...e[16]||(e[16]=[t("span",{class:"material-symbols-rounded"},"mood",-1)])])]),t("div",ds,[j(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=s=>f.value=s),placeholder:"è¾“å…¥æ¶ˆæ¯...",onKeydown:[R(H(z,["exact"]),["enter"]),e[4]||(e[4]=R(H(s=>f.value+=`
`,["shift","exact","prevent"]),["enter"]))],rows:"1",ref:"inputTextarea"},null,40,ms),[[A,f.value]])]),t("button",{class:"m3-button filled send-button",onClick:z,disabled:!f.value.trim()||w.value},[...e[17]||(e[17]=[t("span",{class:"material-symbols-rounded"},"send",-1)])],8,_s)])):p("",!0)])]))}}),fs=_e(vs,[["__scopeId","data-v-f4c01f01"]]);export{fs as default};
