import{ab as D,a as as,r as p,I as os,p as ls,c as i,e as s,g as E,F as x,h as S,N as M,n as h,t as l,x as is,a9 as ns,a2 as ds,L as z,o as n,_ as rs}from"./index-Dsia8u1P.js";import{b as G}from"./dialog-DsN8jS3O.js";import"./index-B-U4Ta6B.js";import{i as $,L as H}from"./install-C00Tj0d-.js";import"./ConfirmDialog-C-5qpYj8.js";import"./iconify-M55kX5oW.js";const P={MODEL_USAGE:"model_stats/model_usage",PROVIDER_STATS:"model_stats/provider_stats",MODULE_STATS:"model_stats/module_stats",CHART_DATA:"model_stats/chart_data"};async function cs(g="24h"){return D.get(`${P.MODEL_USAGE}?time_range=${g}`)}async function vs(g="24h"){return D.get(`${P.PROVIDER_STATS}?time_range=${g}`)}async function us(g="24h"){return D.get(`${P.MODULE_STATS}?time_range=${g}`)}async function _s(g="24h"){return D.get(`${P.CHART_DATA}?time_range=${g}`)}const ms={class:"model-stats-view"},ps={class:"view-header"},bs={class:"header-actions"},fs={class:"time-range-selector"},ys=["onClick"],gs=["disabled"],hs={key:0,class:"overview-section"},ks={class:"overview-grid"},Ts={class:"overview-card"},Cs={class:"card-content"},ws={class:"value primary"},xs={class:"overview-card"},Ss={class:"card-content"},Ms={class:"value secondary"},Os={class:"overview-card"},As={class:"card-content"},Rs={class:"value tertiary"},Es={class:"overview-card"},$s={class:"card-content"},Ds={class:"value error"},Ps={class:"overview-card"},Ls={class:"card-content"},Bs={class:"value"},js={key:1,class:"tabs-container"},Fs={class:"tabs"},Vs={class:"stats-content"},Ns={key:0,class:"loading-state"},Is={key:1,class:"tab-content"},Us={class:"stats-grid"},qs=["onClick"],zs={class:"card-header"},Gs={class:"model-info"},Hs={class:"model-name"},Ks={class:"card-body"},Xs={class:"stat-row"},Zs={class:"stat-item"},Js={class:"value"},Qs={class:"stat-item"},Ws={class:"value"},Ys={class:"stat-row"},st={class:"stat-item"},tt={class:"value"},et={class:"stat-item"},at={class:"value"},ot={class:"stat-row total-row"},lt={class:"stat-item"},it={class:"value highlight"},nt={key:2,class:"tab-content"},dt={class:"provider-grid"},rt={class:"card-header"},ct={class:"provider-info"},vt={class:"provider-name"},ut={class:"card-body"},_t={class:"stat-grid-2col"},mt={class:"stat-item-card"},pt={class:"value"},bt={class:"stat-item-card"},ft={class:"value"},yt={class:"stat-item-card"},gt={class:"value"},ht={class:"stat-item-card"},kt={class:"value"},Tt={key:3,class:"tab-content"},Ct={class:"module-grid"},wt={class:"card-header"},xt={class:"module-info"},St={class:"module-name"},Mt={class:"card-body"},Ot={class:"stat-grid-2col"},At={class:"stat-item-card"},Rt={class:"value"},Et={class:"stat-item-card"},$t={class:"value"},Dt={class:"stat-item-card"},Pt={class:"value"},Lt={class:"stat-item-card"},Bt={class:"value"},jt={key:4,class:"tab-content"},Ft={class:"charts-container"},Vt={class:"chart-card"},Nt={class:"chart-card"},It={class:"chart-card wide"},Ut={class:"chart-card wide"},qt={key:5,class:"empty-state"},zt={class:"dialog-content"},Gt={class:"detail-body-layout"},Ht={class:"stats-section"},Kt={class:"detail-header"},Xt={class:"detail-title"},Zt={class:"detail-name"},Jt={class:"detail-badges"},Qt={class:"detail-badge"},Wt={class:"detail-grid"},Yt={class:"detail-card filled"},se={class:"detail-value"},te={class:"detail-card"},ee={class:"detail-value"},ae={class:"detail-card"},oe={class:"detail-value"},le={class:"detail-card"},ie={class:"detail-value"},ne={key:0,class:"tasks-section"},de={class:"tasks-grid"},re={class:"task-name"},ce=as({__name:"ModelStatsView",setup(g){const C=p(!1),f=p(null),O=p({}),N=p({}),y=p({}),b=p(null),A=p({}),u=p("models"),k=p("24h"),K=[{value:"1h",label:"1小时"},{value:"24h",label:"24小时"},{value:"7d",label:"7天"},{value:"30d",label:"30天"}],L=p(null),B=p(null),j=p(null),F=p(null),T=p({totalCalls:0,totalTokens:0,totalCost:0,tokenEfficiency:"0.00x",consumeRatio:"0.00",avgTokensPerCall:0}),X=()=>{if(!f.value)return;let e=0,t=0,a=0,o=0,m=0;Object.values(f.value).forEach(v=>{e+=v.total_calls||0,t+=v.total_tokens||0,o+=v.prompt_tokens||0,m+=v.completion_tokens||0}),Object.keys(O.value).length>0&&Object.values(O.value).forEach(v=>{a+=v.total_cost||0});const d=o>0?(m/o).toFixed(3)+"x":"0.000x",r=e>0?(t/e/1e3).toFixed(2):"0.00",c=e>0?Math.round(t/e):0;T.value={totalCalls:e,totalTokens:t,totalCost:a,tokenEfficiency:d,consumeRatio:r,avgTokensPerCall:c}},_=e=>e>=1e6?(e/1e6).toFixed(2)+"M":e>=1e3?(e/1e3).toFixed(2)+"K":e.toString(),I=e=>!e.total_calls||e.total_calls===0?0:Math.round(e.total_tokens/e.total_calls),R=async()=>{C.value=!0;try{const[e,t,a,o,m]=await Promise.all([cs(k.value),ns(),vs(k.value),us(k.value),_s(k.value)]);if(e.success&&e.data?f.value=e.data.stats:G("获取模型数据失败: "+(e.error||"未知错误")),a.success&&a.data&&(O.value=a.data.stats||{}),o.success&&o.data&&(N.value=o.data.stats||{}),m.success&&m.data&&(y.value=m.data.chart_data||{}),X(),t.success&&t.data){const d=t.data.configs.filter(r=>r.path==="mofox_bot_config.yaml"||r.path.includes("model_config"));for(const r of d){const c=await ds(r.path);c.success&&c.data&&Z(c.data.content)}}u.value==="charts"&&(await z(),q())}catch(e){G("网络请求失败: "+e)}finally{C.value=!1}},Z=e=>{const t={...A.value},a={};Array.isArray(e.models)&&e.models.forEach(d=>{d.name&&d.model_identifier&&(a[d.name]=d.model_identifier)});const o=(d,r)=>{const c=a[d]||d;t[c]||(t[c]=[]),t[c].includes(r)||t[c].push(r)};if(e.model_task_config&&typeof e.model_task_config=="object"){const d=e.model_task_config,r={replyer:"主回复 (Replyer)",planner:"规划 (Planner)",emotion:"情感分析 (Emotion)",mood:"心情 (Mood)",maizone:"MaiZone",tool_use:"工具调用 (Tool Use)",anti_injection:"反注入 (Anti-Injection)",vlm:"视觉识别 (VLM)",emoji_vlm:"表情包识别 (Emoji VLM)",utils_video:"视频处理",voice:"语音 (Voice)",embedding:"向量 (Embedding)",memory_short_term_builder:"短时记忆构建",memory_short_term_decider:"短时记忆决策",memory_long_term:"长时记忆",summary:"总结 (Summary)",translate:"翻译 (Translate)"};for(const[c,v]of Object.entries(d))if(v&&typeof v=="object"){const w=v.model;if(w&&typeof w=="string"){const es=r[c]||c;o(w,es)}}}const m=(d,r)=>{if(!(typeof d!="object"||d===null)&&!(r.length===0&&d===e.model_task_config)&&!r.includes("model_task_config")&&!(r.length===0&&d===e.models))for(const[c,v]of Object.entries(d))if(c==="model"&&typeof v=="string"){const w=r.length>0?r[r.length-1]:"Unknown";o(v,w)}else typeof v=="object"&&v!==null&&m(v,[...r,c])};m(e,[]),console.log("[ModelStats] Analyzed tasks:",t),A.value=t},J=(e,t)=>{b.value={name:e,stats:t}},U=()=>{b.value=null},V=e=>A.value?A.value[e]||[]:[],Q=e=>{k.value=e,R()},q=()=>{W(),Y(),ss(),ts()},W=()=>{if(!L.value||!y.value.pie_chart_cost_by_provider)return;const e=$(L.value),t=y.value.pie_chart_cost_by_provider,a={tooltip:{trigger:"item",formatter:"{b}: ${c} ({d}%)"},legend:{orient:"vertical",left:"left"},series:[{name:"成本分布",type:"pie",radius:"60%",data:t.labels?t.labels.map((o,m)=>({name:o,value:t.data[m]})):[],emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};e.setOption(a)},Y=()=>{if(!B.value||!y.value.pie_chart_req_by_provider)return;const e=$(B.value),t=y.value.pie_chart_req_by_provider,a={tooltip:{trigger:"item",formatter:"{b}: {c} 次 ({d}%)"},legend:{orient:"vertical",left:"left"},series:[{name:"请求分布",type:"pie",radius:["40%","70%"],data:t.labels?t.labels.map((o,m)=>({name:o,value:t.data[m]})):[],emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};e.setOption(a)},ss=()=>{if(!j.value||!y.value.bar_chart_cost_by_model)return;const e=$(j.value),t=y.value.bar_chart_cost_by_model,a={tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:"{b}: ${c}"},grid:{containLabel:!0,left:"3%",right:"4%",bottom:"3%"},xAxis:{type:"value",name:"成本 ($)"},yAxis:{type:"category",data:t.labels||[],axisLabel:{interval:0}},series:[{name:"成本",type:"bar",data:t.data||[],itemStyle:{color:new H(1,0,0,0,[{offset:0,color:"#83bff6"},{offset:.5,color:"#188df0"},{offset:1,color:"#188df0"}])}}]};e.setOption(a)},ts=()=>{if(!F.value||!y.value.bar_chart_avg_response_time)return;const e=$(F.value),t=y.value.bar_chart_avg_response_time,a={tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:"{b}: {c}s"},grid:{containLabel:!0,left:"3%",right:"4%",bottom:"3%"},xAxis:{type:"value",name:"响应时间 (秒)"},yAxis:{type:"category",data:t.labels||[],axisLabel:{interval:0}},series:[{name:"平均响应时间",type:"bar",data:t.data||[],itemStyle:{color:new H(1,0,0,0,[{offset:0,color:"#f093fb"},{offset:.5,color:"#f5576c"},{offset:1,color:"#f5576c"}])}}]};e.setOption(a)};return os(u,async e=>{e==="charts"&&(await z(),q())}),ls(()=>{R()}),(e,t)=>(n(),i("div",ms,[s("div",ps,[t[6]||(t[6]=s("div",{class:"header-content"},[s("h2",null,"模型统计"),s("p",{class:"subtitle"},"查看模型使用情况、成本分析和性能指标")],-1)),s("div",bs,[s("div",fs,[(n(),i(x,null,S(K,a=>s("button",{key:a.value,class:h(["time-range-button",{active:k.value===a.value}]),onClick:o=>Q(a.value)},l(a.label),11,ys)),64))]),s("button",{class:"m3-button filled",onClick:R,disabled:C.value},[s("span",{class:h(["material-symbols-rounded",{spinning:C.value}])},"refresh",2),t[5]||(t[5]=M(" 刷新数据 ",-1))],8,gs)])]),f.value&&Object.keys(f.value).length>0?(n(),i("div",hs,[s("div",ks,[s("div",Ts,[t[9]||(t[9]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"}},[s("span",{class:"material-symbols-rounded"},"api")],-1)),s("div",Cs,[t[7]||(t[7]=s("div",{class:"label"},"总调用次数",-1)),s("div",ws,l(_(T.value.totalCalls)),1),t[8]||(t[8]=s("div",{class:"description"},"模型接口总调用",-1))])]),s("div",xs,[t[12]||(t[12]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"}},[s("span",{class:"material-symbols-rounded"},"token")],-1)),s("div",Ss,[t[10]||(t[10]=s("div",{class:"label"},"总Token消耗",-1)),s("div",Ms,l(_(T.value.totalTokens)),1),t[11]||(t[11]=s("div",{class:"description"},"累计处理Token数",-1))])]),s("div",Os,[t[15]||(t[15]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"}},[s("span",{class:"material-symbols-rounded"},"insights")],-1)),s("div",As,[t[13]||(t[13]=s("div",{class:"label"},"Token效率",-1)),s("div",Rs,l(T.value.tokenEfficiency),1),t[14]||(t[14]=s("div",{class:"description"},"输出/输入比率",-1))])]),s("div",Es,[t[18]||(t[18]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #fa709a 0%, #fee140 100%)"}},[s("span",{class:"material-symbols-rounded"},"payments")],-1)),s("div",$s,[t[16]||(t[16]=s("div",{class:"label"},"总成本",-1)),s("div",Ds,"$"+l(T.value.totalCost.toFixed(4)),1),t[17]||(t[17]=s("div",{class:"description"},"累计消费金额",-1))])]),s("div",Ps,[t[21]||(t[21]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)"}},[s("span",{class:"material-symbols-rounded"},"analytics")],-1)),s("div",Ls,[t[19]||(t[19]=s("div",{class:"label"},"平均单次Token",-1)),s("div",Bs,l(T.value.avgTokensPerCall),1),t[20]||(t[20]=s("div",{class:"description"},"每次调用平均消耗",-1))])])])])):E("",!0),f.value&&Object.keys(f.value).length>0?(n(),i("div",js,[s("div",Fs,[s("button",{class:h(["tab",{active:u.value==="models"}]),onClick:t[0]||(t[0]=a=>u.value="models")},[...t[22]||(t[22]=[s("span",{class:"material-symbols-rounded"},"model_training",-1),M(" 模型统计 ",-1)])],2),s("button",{class:h(["tab",{active:u.value==="providers"}]),onClick:t[1]||(t[1]=a=>u.value="providers")},[...t[23]||(t[23]=[s("span",{class:"material-symbols-rounded"},"cloud",-1),M(" 提供商分析 ",-1)])],2),s("button",{class:h(["tab",{active:u.value==="modules"}]),onClick:t[2]||(t[2]=a=>u.value="modules")},[...t[24]||(t[24]=[s("span",{class:"material-symbols-rounded"},"extension",-1),M(" 模块使用 ",-1)])],2),s("button",{class:h(["tab",{active:u.value==="charts"}]),onClick:t[3]||(t[3]=a=>u.value="charts")},[...t[25]||(t[25]=[s("span",{class:"material-symbols-rounded"},"bar_chart",-1),M(" 图表分析 ",-1)])],2)])])):E("",!0),s("div",Vs,[C.value&&!f.value?(n(),i("div",Ns,[...t[26]||(t[26]=[s("span",{class:"material-symbols-rounded spinning",style:{"font-size":"48px"}},"progress_activity",-1),s("p",null,"加载统计数据中...",-1)])])):f.value&&Object.keys(f.value).length>0&&u.value==="models"?(n(),i("div",Is,[s("div",Us,[(n(!0),i(x,null,S(Object.entries(f.value),([a,o])=>(n(),i("div",{key:a,class:"model-card",onClick:m=>J(a,o)},[s("div",zs,[s("div",Gs,[t[27]||(t[27]=s("span",{class:"material-symbols-rounded model-icon"},"smart_toy",-1)),s("h3",Hs,l(a),1)])]),s("div",Ks,[s("div",Xs,[s("div",Zs,[t[28]||(t[28]=s("span",{class:"label"},"调用次数",-1)),s("span",Js,l(_(o.total_calls)),1)]),s("div",Qs,[t[29]||(t[29]=s("span",{class:"label"},"平均Token",-1)),s("span",Ws,l(I(o)),1)])]),t[33]||(t[33]=s("div",{class:"stat-divider"},null,-1)),s("div",Ys,[s("div",st,[t[30]||(t[30]=s("span",{class:"label"},"输入Token",-1)),s("span",tt,l(_(o.prompt_tokens)),1)]),s("div",et,[t[31]||(t[31]=s("span",{class:"label"},"输出Token",-1)),s("span",at,l(_(o.completion_tokens)),1)])]),t[34]||(t[34]=s("div",{class:"stat-divider"},null,-1)),s("div",ot,[s("div",lt,[t[32]||(t[32]=s("span",{class:"label"},"总Token",-1)),s("span",it,l(_(o.total_tokens)),1)])])])],8,qs))),128))])])):u.value==="providers"?(n(),i("div",nt,[s("div",dt,[(n(!0),i(x,null,S(Object.entries(O.value),([a,o])=>(n(),i("div",{key:a,class:"provider-card"},[s("div",rt,[s("div",ct,[t[35]||(t[35]=s("span",{class:"material-symbols-rounded provider-icon"},"cloud_circle",-1)),s("h3",vt,l(a),1)])]),s("div",ut,[s("div",_t,[s("div",mt,[t[36]||(t[36]=s("span",{class:"label"},"总调用",-1)),s("span",pt,l(_(o.total_calls)),1)]),s("div",bt,[t[37]||(t[37]=s("span",{class:"label"},"总Token",-1)),s("span",ft,l(_(o.total_tokens)),1)]),s("div",yt,[t[38]||(t[38]=s("span",{class:"label"},"总成本",-1)),s("span",gt,"$"+l(o.total_cost.toFixed(4)),1)]),s("div",ht,[t[39]||(t[39]=s("span",{class:"label"},"平均响应",-1)),s("span",kt,l(o.avg_time.toFixed(2))+"s",1)])])])]))),128))])])):u.value==="modules"?(n(),i("div",Tt,[s("div",Ct,[(n(!0),i(x,null,S(Object.entries(N.value),([a,o])=>(n(),i("div",{key:a,class:"module-card"},[s("div",wt,[s("div",xt,[t[40]||(t[40]=s("span",{class:"material-symbols-rounded module-icon"},"widgets",-1)),s("h3",St,l(a),1)])]),s("div",Mt,[s("div",Ot,[s("div",At,[t[41]||(t[41]=s("span",{class:"label"},"调用次数",-1)),s("span",Rt,l(_(o.total_calls)),1)]),s("div",Et,[t[42]||(t[42]=s("span",{class:"label"},"Token消耗",-1)),s("span",$t,l(_(o.total_tokens)),1)]),s("div",Dt,[t[43]||(t[43]=s("span",{class:"label"},"总成本",-1)),s("span",Pt,"$"+l(o.total_cost.toFixed(4)),1)]),s("div",Lt,[t[44]||(t[44]=s("span",{class:"label"},"平均时间",-1)),s("span",Bt,l(o.avg_time.toFixed(2))+"s",1)])])])]))),128))])])):u.value==="charts"?(n(),i("div",jt,[s("div",Ft,[s("div",Vt,[t[45]||(t[45]=s("div",{class:"chart-header"},[s("h3",null,"成本分布 (按提供商)"),s("span",{class:"chart-subtitle"},"Pie Chart")],-1)),s("div",{class:"chart-body",ref_key:"costByProviderChart",ref:L},null,512)]),s("div",Nt,[t[46]||(t[46]=s("div",{class:"chart-header"},[s("h3",null,"请求分布 (按提供商)"),s("span",{class:"chart-subtitle"},"Doughnut Chart")],-1)),s("div",{class:"chart-body",ref_key:"reqByProviderChart",ref:B},null,512)]),s("div",It,[t[47]||(t[47]=s("div",{class:"chart-header"},[s("h3",null,"模型成本对比"),s("span",{class:"chart-subtitle"},"Bar Chart")],-1)),s("div",{class:"chart-body",ref_key:"costByModelChart",ref:j},null,512)]),s("div",Ut,[t[48]||(t[48]=s("div",{class:"chart-header"},[s("h3",null,"平均响应时间"),s("span",{class:"chart-subtitle"},"Bar Chart")],-1)),s("div",{class:"chart-body",ref_key:"avgResponseTimeChart",ref:F},null,512)])])])):(n(),i("div",qt,[t[49]||(t[49]=s("span",{class:"material-symbols-rounded empty-icon"},"inbox",-1)),t[50]||(t[50]=s("p",null,"暂无统计数据",-1)),s("button",{class:"m3-button filled",onClick:R},"立即获取")]))]),b.value?(n(),i("div",{key:2,class:"m3-dialog-overlay",onClick:U},[s("div",{class:h(["m3-dialog",{"has-tasks":V(b.value.name).length>0}]),onClick:t[4]||(t[4]=is(()=>{},["stop"]))},[s("div",{class:"dialog-header"},[t[52]||(t[52]=s("h3",null,"模型详情",-1)),s("button",{class:"m3-icon-button",onClick:U},[...t[51]||(t[51]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),s("div",zt,[s("div",Gt,[s("div",Ht,[s("div",Kt,[t[53]||(t[53]=s("span",{class:"material-symbols-rounded detail-icon"},"smart_toy",-1)),s("div",Xt,[s("div",Zt,l(b.value.name),1),s("div",Jt,[s("span",Qt,l(_(b.value.stats.total_calls))+" 次调用",1)])])]),t[58]||(t[58]=s("div",{class:"section-title"},"统计数据",-1)),s("div",Wt,[s("div",Yt,[t[54]||(t[54]=s("span",{class:"detail-label"},"总Token消耗",-1)),s("span",se,l(_(b.value.stats.total_tokens)),1)]),s("div",te,[t[55]||(t[55]=s("span",{class:"detail-label"},"输入Token",-1)),s("span",ee,l(_(b.value.stats.prompt_tokens)),1)]),s("div",ae,[t[56]||(t[56]=s("span",{class:"detail-label"},"输出Token",-1)),s("span",oe,l(_(b.value.stats.completion_tokens)),1)]),s("div",le,[t[57]||(t[57]=s("span",{class:"detail-label"},"平均Token",-1)),s("span",ie,l(I(b.value.stats)),1)])])]),V(b.value.name).length>0?(n(),i("div",ne,[t[60]||(t[60]=s("div",{class:"section-title"},"使用场景",-1)),s("div",de,[(n(!0),i(x,null,S(V(b.value.name),a=>(n(),i("div",{class:"task-card",key:a},[t[59]||(t[59]=s("span",{class:"material-symbols-rounded task-icon"},"check_circle",-1)),s("span",re,l(a),1)]))),128))])])):E("",!0)])])],2)])):E("",!0)]))}}),fe=rs(ce,[["__scopeId","data-v-f63c9d6a"]]);export{fe as default};
