# 05 - 插件开发指南

## 快速开始

所有插件使用统一的导入路径：

```python
from src.plugin_system.base.config_types import ConfigField
```

### 基础用法（现有插件无需修改）

```python
config_schema = {
    "api": {
        "enabled": ConfigField(type=bool, default=True, description="启用 API"),
        "timeout": ConfigField(type=int, default=30, description="超时时间"),
        "model": ConfigField(
            type=str, 
            default="gpt-4", 
            description="模型", 
            choices=["gpt-3.5", "gpt-4", "gpt-4-turbo"]
        ),
    }
}
```

WebUI 自动推断控件类型：
- `bool` → 开关 (Switch)
- `int`/`float` → 数字输入框
- `int`/`float` + `min` + `max` → 滑块 (Slider)
- 有 `choices` → 下拉选择
- `list` → 动态列表
- `dict` → JSON 编辑器
- `str` → 文本输入框

### 增强用法（使用新属性）

```python
config_schema = {
    "api": {
        "key": ConfigField(
            type=str,
            default="",
            description="API 密钥",
            # ↓ 新增的 UI 属性
            input_type="password",
            placeholder="sk-xxxxxxxx",
            hint="从 OpenAI 控制台获取",
            required=True,
            order=1
        ),
        "temperature": ConfigField(
            type=float,
            default=0.7,
            description="生成温度",
            min=0.0,
            max=2.0,
            step=0.1,
            hint="较高的值使输出更随机",
            order=2
        ),
    }
}
```

---

## ConfigField 完整参数

### 基础属性（主程序使用）

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `type` | `type` | ✅ | 字段类型：`str`, `int`, `float`, `bool`, `list`, `dict` |
| `default` | `Any` | ✅ | 默认值 |
| `description` | `str` | ✅ | 字段描述 |
| `example` | `str` | - | 示例值，用于生成配置文件注释 |
| `required` | `bool` | - | 是否必需，默认 `False` |
| `choices` | `list` | - | 可选值列表，用于下拉选择 |

### UI 显示控制

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `input_type` | `str` | `None` | 控件类型，不指定则自动推断 |
| `label` | `str` | `None` | 显示标签，默认用 description |
| `placeholder` | `str` | `None` | 输入框占位符 |
| `hint` | `str` | `None` | 字段下方提示文字 |
| `icon` | `str` | `None` | 图标名称 (Lucide Icons) |
| `hidden` | `bool` | `False` | 是否隐藏 |
| `disabled` | `bool` | `False` | 是否禁用 |
| `order` | `int` | `0` | 排序权重（小的在前） |
| `rows` | `int` | `3` | textarea 行数 |

### 验证规则

| 参数 | 类型 | 说明 |
|------|------|------|
| `min` | `float` | 最小值（数字类型） |
| `max` | `float` | 最大值（数字类型） |
| `step` | `float` | 步进值（数字类型） |
| `pattern` | `str` | 正则验证（字符串类型） |
| `max_length` | `int` | 最大长度（字符串类型） |

### 条件显示

| 参数 | 类型 | 说明 |
|------|------|------|
| `depends_on` | `str` | 依赖字段路径，如 `"section.field"` |
| `depends_value` | `Any` | 依赖字段需要的值 |

### 列表类型专用

| 参数 | 类型 | 说明 |
|------|------|------|
| `item_type` | `str` | 元素类型：`"string"`, `"number"`, `"object"` |
| `item_fields` | `dict` | object 类型时的字段定义 |
| `min_items` | `int` | 最少元素数 |
| `max_items` | `int` | 最多元素数 |

---

## input_type 可选值

| 值 | 说明 | 适用类型 |
|----|------|----------|
| `text` | 单行文本框 | str |
| `password` | 密码框（带显示/隐藏） | str |
| `textarea` | 多行文本框 | str |
| `number` | 数字输入框 | int, float |
| `slider` | 滑块 | int, float (需要 min/max) |
| `switch` | 开关 | bool |
| `select` | 下拉选择 | str (需要 choices) |
| `list` | 动态列表 | list |
| `json` | JSON 编辑器 | dict |
| `color` | 颜色选择器 | str |
| `code` | 代码编辑器 | str |

---

## Section 配置

### 简单描述

```python
config_section_descriptions = {
    "api": "API 配置",
    "model": "模型设置",
}
```

### 使用 ConfigSection

```python
from src.plugin_system.base.config_types import ConfigSection

config_section_descriptions = {
    "api": ConfigSection(
        title="API 配置",
        description="外部 API 的连接参数",
        icon="cloud",
        order=1
    ),
    "debug": ConfigSection(
        title="调试选项",
        icon="bug",
        collapsed=True,  # 默认折叠
        order=99
    ),
}
```

### 使用便捷函数

```python
from src.plugin_system.base.config_types import section_meta

config_section_descriptions = {
    "api": section_meta("API 配置", icon="cloud", order=1),
    "debug": section_meta("调试选项", icon="bug", collapsed=True, order=99),
}
```

---

## 布局配置

### 标签页布局

```python
from src.plugin_system.base.config_types import ConfigLayout, ConfigTab

config_layout = ConfigLayout(
    type="tabs",
    tabs=[
        ConfigTab(
            id="main",
            title="主要设置",
            sections=["api", "model"],
            icon="settings"
        ),
        ConfigTab(
            id="advanced",
            title="高级",
            sections=["cache", "debug"],
            icon="sliders",
            badge="Dev"  # 角标
        ),
    ]
)
```

---

## 完整示例

```python
"""完整的插件配置示例"""

from src.plugin_system import BasePlugin, register_plugin
from src.plugin_system.base.config_types import (
    ConfigField,
    ConfigSection,
    ConfigLayout,
    ConfigTab,
)


@register_plugin
class TTSPlugin(BasePlugin):
    plugin_name = "tts_plugin"
    enable_plugin = True
    dependencies = []
    python_dependencies = ["httpx"]
    config_file_name = "config.toml"
    
    # ===== 配置 Schema =====
    config_schema = {
        "tts": {
            "provider": ConfigField(
                type=str,
                default="azure",
                description="TTS 服务提供商",
                choices=["azure", "google", "local"],
                icon="cloud",
                order=1
            ),
            "api_key": ConfigField(
                type=str,
                default="",
                description="API 密钥",
                input_type="password",
                placeholder="请输入 API 密钥",
                hint="从服务商控制台获取",
                required=True,
                order=2
            ),
            "voice": ConfigField(
                type=str,
                default="zh-CN-XiaoxiaoNeural",
                description="语音角色",
                placeholder="例如: zh-CN-XiaoxiaoNeural",
                order=3
            ),
            "speed": ConfigField(
                type=float,
                default=1.0,
                description="语速",
                min=0.5,
                max=2.0,
                step=0.1,
                hint="0.5 到 2.0 之间",
                order=4
            ),
        },
        "cache": {
            "enabled": ConfigField(
                type=bool,
                default=True,
                description="启用缓存",
                order=1
            ),
            "max_size": ConfigField(
                type=int,
                default=100,
                description="最大缓存数",
                min=10,
                max=1000,
                depends_on="cache.enabled",
                depends_value=True,
                order=2
            ),
            "ttl": ConfigField(
                type=int,
                default=3600,
                description="缓存过期时间（秒）",
                min=60,
                depends_on="cache.enabled",
                depends_value=True,
                order=3
            ),
        },
        "debug": {
            "enabled": ConfigField(
                type=bool,
                default=False,
                description="调试模式",
                order=1
            ),
            "log_level": ConfigField(
                type=str,
                default="INFO",
                description="日志级别",
                choices=["DEBUG", "INFO", "WARNING", "ERROR"],
                depends_on="debug.enabled",
                depends_value=True,
                order=2
            ),
        },
    }
    
    # ===== Section 元数据 =====
    config_section_descriptions = {
        "tts": ConfigSection(
            title="TTS 配置",
            description="语音合成相关设置",
            icon="volume-2",
            order=1
        ),
        "cache": ConfigSection(
            title="缓存设置",
            icon="database",
            order=2
        ),
        "debug": ConfigSection(
            title="调试选项",
            icon="bug",
            collapsed=True,
            order=99
        ),
    }
    
    # ===== 布局配置 =====
    config_layout = ConfigLayout(
        type="tabs",
        tabs=[
            ConfigTab(id="tts", title="语音合成", sections=["tts"]),
            ConfigTab(id="advanced", title="高级", sections=["cache", "debug"]),
        ]
    )
```

---

## 常见问题

### Q: 我不加任何新属性，能正常工作吗？

**A**: 完全可以！所有新属性都有默认值，现有插件无需修改。

### Q: 新属性会影响主程序生成配置文件吗？

**A**: 不会。主程序只读取基础属性 (`type`, `default`, `description` 等)。

### Q: 如何让某个字段只读？

**A**: 设置 `disabled=True`。

### Q: 如何隐藏某个字段？

**A**: 设置 `hidden=True`。

### Q: 如何实现条件显示？

**A**: 使用 `depends_on` 和 `depends_value`：

```python
"advanced_option": ConfigField(
    type=str,
    default="",
    description="高级选项",
    depends_on="debug.enabled",
    depends_value=True  # 只在 debug.enabled=True 时显示
)
```

### Q: 支持哪些图标？

**A**: 使用 [Lucide Icons](https://lucide.dev/icons)，填写图标名称即可。

### Q: 配置修改后如何生效？

**A**: 保存后需要重新加载插件。WebUI 会提供重载按钮。
