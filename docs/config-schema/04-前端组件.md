# 04 - 前端组件设计

## 组件结构

```
frontend/src/components/ConfigEditor/
├── index.tsx              # 主组件
├── types.ts               # TypeScript 类型定义
├── FieldRenderer.tsx      # 字段渲染器（根据 input_type 分发）
├── SectionPanel.tsx       # Section 折叠面板
├── TabsLayout.tsx         # 标签页布局
└── controls/              # 输入控件
    ├── TextInput.tsx
    ├── PasswordInput.tsx
    ├── NumberInput.tsx
    ├── SwitchInput.tsx
    ├── SliderInput.tsx
    ├── SelectInput.tsx
    ├── TextareaInput.tsx
    ├── ListInput.tsx
    └── JsonInput.tsx
```

---

## types.ts

```typescript
/**
 * 配置字段 Schema（来自后端 API）
 */
export interface ConfigFieldSchema {
  key: string;
  section: string;
  type: string;
  default: any;
  description: string;
  required?: boolean;
  choices?: any[];
  example?: string;
  
  // 推断或指定的输入类型
  input_type: 'text' | 'password' | 'number' | 'switch' | 'slider' 
            | 'select' | 'textarea' | 'list' | 'json' | 'color' | 'code';
  
  // UI 控制
  label?: string;
  placeholder?: string;
  hint?: string;
  icon?: string;
  hidden?: boolean;
  disabled?: boolean;
  order?: number;
  rows?: number;
  
  // 验证
  min?: number;
  max?: number;
  step?: number;
  pattern?: string;
  max_length?: number;
  
  // 条件显示
  group?: string;
  depends_on?: string;
  depends_value?: any;
  
  // 列表类型
  item_type?: 'string' | 'number' | 'object';
  item_fields?: Record<string, any>;
  min_items?: number;
  max_items?: number;
}

/**
 * Section 元数据
 */
export interface SectionMeta {
  name: string;
  title: string;
  description?: string;
  icon?: string;
  collapsed?: boolean;
  order?: number;
}

/**
 * 标签页元数据
 */
export interface TabMeta {
  id: string;
  title: string;
  sections: string[];
  icon?: string;
  order?: number;
  badge?: string;
}

/**
 * 布局配置
 */
export interface LayoutConfig {
  type: 'auto' | 'tabs' | 'pages';
  tabs?: TabMeta[];
}

/**
 * 完整的插件配置 Schema
 */
export interface PluginConfigSchema {
  schema: Record<string, ConfigFieldSchema[]>;
  sections: SectionMeta[];
  layout?: LayoutConfig;
}

/**
 * 通用控件 Props
 */
export interface ControlProps {
  field: ConfigFieldSchema;
  value: any;
  onChange: (value: any) => void;
  disabled?: boolean;
}
```

---

## index.tsx (主组件)

```tsx
import React, { useState, useEffect } from 'react';
import { PluginConfigSchema, ConfigFieldSchema } from './types';
import { FieldRenderer } from './FieldRenderer';
import { SectionPanel } from './SectionPanel';
import { TabsLayout } from './TabsLayout';

interface ConfigEditorProps {
  pluginName: string;
  schema: PluginConfigSchema;
  values: Record<string, any>;
  onChange: (values: Record<string, any>) => void;
  onSave?: () => void;
}

export const ConfigEditor: React.FC<ConfigEditorProps> = ({
  pluginName,
  schema,
  values,
  onChange,
  onSave
}) => {
  const [localValues, setLocalValues] = useState(values);
  
  useEffect(() => {
    setLocalValues(values);
  }, [values]);
  
  const handleFieldChange = (section: string, key: string, value: any) => {
    const newValues = {
      ...localValues,
      [section]: {
        ...localValues[section],
        [key]: value
      }
    };
    setLocalValues(newValues);
    onChange(newValues);
  };
  
  // 根据布局类型渲染
  if (schema.layout?.type === 'tabs' && schema.layout.tabs) {
    return (
      <TabsLayout
        tabs={schema.layout.tabs}
        schema={schema}
        values={localValues}
        onChange={handleFieldChange}
      />
    );
  }
  
  // 默认：自动布局（折叠面板）
  return (
    <div className="config-editor">
      {schema.sections.map(section => (
        <SectionPanel
          key={section.name}
          section={section}
          fields={schema.schema[section.name] || []}
          values={localValues[section.name] || {}}
          allValues={localValues}
          onChange={(key, value) => handleFieldChange(section.name, key, value)}
        />
      ))}
    </div>
  );
};
```

---

## FieldRenderer.tsx

```tsx
import React from 'react';
import { ConfigFieldSchema, ControlProps } from './types';
import { 
  TextInput, PasswordInput, NumberInput, 
  SwitchInput, SliderInput, SelectInput,
  TextareaInput, ListInput, JsonInput 
} from './controls';

interface FieldRendererProps {
  field: ConfigFieldSchema;
  value: any;
  onChange: (value: any) => void;
  allValues: Record<string, any>;
}

export const FieldRenderer: React.FC<FieldRendererProps> = ({
  field,
  value,
  onChange,
  allValues
}) => {
  // 条件显示检查
  if (field.depends_on) {
    const dependValue = getNestedValue(allValues, field.depends_on);
    if (dependValue !== field.depends_value) {
      return null;
    }
  }
  
  // 隐藏字段
  if (field.hidden) return null;
  
  const controlProps: ControlProps = {
    field,
    value: value ?? field.default,
    onChange,
    disabled: field.disabled
  };
  
  // 根据 input_type 渲染对应控件
  const renderControl = () => {
    switch (field.input_type) {
      case 'password':
        return <PasswordInput {...controlProps} />;
      case 'number':
        return <NumberInput {...controlProps} />;
      case 'switch':
        return <SwitchInput {...controlProps} />;
      case 'slider':
        return <SliderInput {...controlProps} />;
      case 'select':
        return <SelectInput {...controlProps} />;
      case 'textarea':
        return <TextareaInput {...controlProps} />;
      case 'list':
        return <ListInput {...controlProps} />;
      case 'json':
        return <JsonInput {...controlProps} />;
      case 'text':
      default:
        return <TextInput {...controlProps} />;
    }
  };
  
  return (
    <div className="config-field">
      <label className="config-field-label">
        {field.icon && <span className="field-icon">{field.icon}</span>}
        {field.label || field.description}
        {field.required && <span className="required">*</span>}
      </label>
      
      {renderControl()}
      
      {field.hint && (
        <p className="config-field-hint">{field.hint}</p>
      )}
    </div>
  );
};

function getNestedValue(obj: any, path: string): any {
  return path.split('.').reduce((acc, key) => acc?.[key], obj);
}
```

---

## 控件示例

### TextInput.tsx

```tsx
import React from 'react';
import { ControlProps } from '../types';

export const TextInput: React.FC<ControlProps> = ({
  field,
  value,
  onChange,
  disabled
}) => {
  return (
    <input
      type="text"
      className="config-input"
      value={value || ''}
      onChange={(e) => onChange(e.target.value)}
      placeholder={field.placeholder}
      disabled={disabled}
      maxLength={field.max_length}
      pattern={field.pattern}
    />
  );
};
```

### SwitchInput.tsx

```tsx
import React from 'react';
import { ControlProps } from '../types';

export const SwitchInput: React.FC<ControlProps> = ({
  field,
  value,
  onChange,
  disabled
}) => {
  return (
    <label className="config-switch">
      <input
        type="checkbox"
        checked={!!value}
        onChange={(e) => onChange(e.target.checked)}
        disabled={disabled}
      />
      <span className="switch-slider" />
    </label>
  );
};
```

### SliderInput.tsx

```tsx
import React from 'react';
import { ControlProps } from '../types';

export const SliderInput: React.FC<ControlProps> = ({
  field,
  value,
  onChange,
  disabled
}) => {
  const min = field.min ?? 0;
  const max = field.max ?? 100;
  const step = field.step ?? 1;
  
  return (
    <div className="config-slider">
      <input
        type="range"
        min={min}
        max={max}
        step={step}
        value={value ?? min}
        onChange={(e) => onChange(parseFloat(e.target.value))}
        disabled={disabled}
      />
      <span className="slider-value">{value}</span>
    </div>
  );
};
```

### SelectInput.tsx

```tsx
import React from 'react';
import { ControlProps } from '../types';

export const SelectInput: React.FC<ControlProps> = ({
  field,
  value,
  onChange,
  disabled
}) => {
  return (
    <select
      className="config-select"
      value={value ?? ''}
      onChange={(e) => onChange(e.target.value)}
      disabled={disabled}
    >
      {field.choices?.map((choice) => (
        <option key={String(choice)} value={choice}>
          {String(choice)}
        </option>
      ))}
    </select>
  );
};
```

### ListInput.tsx

```tsx
import React from 'react';
import { ControlProps } from '../types';

export const ListInput: React.FC<ControlProps> = ({
  field,
  value,
  onChange,
  disabled
}) => {
  const items = Array.isArray(value) ? value : [];
  
  const addItem = () => {
    if (field.max_items && items.length >= field.max_items) return;
    const defaultValue = field.item_type === 'number' ? 0 : '';
    onChange([...items, defaultValue]);
  };
  
  const removeItem = (index: number) => {
    if (field.min_items && items.length <= field.min_items) return;
    onChange(items.filter((_, i) => i !== index));
  };
  
  const updateItem = (index: number, newValue: any) => {
    const newItems = [...items];
    newItems[index] = newValue;
    onChange(newItems);
  };
  
  return (
    <div className="config-list">
      {items.map((item, index) => (
        <div key={index} className="list-item">
          <input
            type={field.item_type === 'number' ? 'number' : 'text'}
            value={item}
            onChange={(e) => updateItem(
              index, 
              field.item_type === 'number' 
                ? parseFloat(e.target.value) 
                : e.target.value
            )}
            disabled={disabled}
          />
          <button 
            onClick={() => removeItem(index)}
            disabled={disabled || (field.min_items !== undefined && items.length <= field.min_items)}
          >
            删除
          </button>
        </div>
      ))}
      <button 
        onClick={addItem}
        disabled={disabled || (field.max_items !== undefined && items.length >= field.max_items)}
      >
        添加
      </button>
    </div>
  );
};
```

---

## 使用示例

```tsx
import { ConfigEditor } from '@/components/ConfigEditor';
import { usePluginSchema, usePluginConfig } from '@/hooks/usePlugin';

function PluginSettingsPage({ pluginName }: { pluginName: string }) {
  const { schema, loading: schemaLoading } = usePluginSchema(pluginName);
  const { config, updateConfig, saveConfig } = usePluginConfig(pluginName);
  
  if (schemaLoading || !schema) {
    return <div>加载中...</div>;
  }
  
  return (
    <div className="plugin-settings">
      <h2>{pluginName} 配置</h2>
      <ConfigEditor
        pluginName={pluginName}
        schema={schema}
        values={config}
        onChange={updateConfig}
        onSave={saveConfig}
      />
      <button onClick={saveConfig}>保存</button>
    </div>
  );
}
```
