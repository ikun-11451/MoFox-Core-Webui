# 01 - 架构设计

## 设计原则

1. **向后兼容**：现有插件无需任何修改
2. **统一导入**：所有插件使用相同的导入路径
3. **渐进增强**：新属性都有默认值，可选使用
4. **类型安全**：保持 dataclass 的类型提示优势

## 实现方案

扩展主程序的 `ConfigField`，添加 UI 相关属性：

```python
# mmc/src/plugin_system/base/config_types.py

@dataclass(slots=True)
class ConfigField:
    # ===== 基础属性（主程序使用）=====
    type: type
    default: Any
    description: str
    example: str | None = None
    required: bool = False
    choices: list[Any] | None = field(default_factory=list)
    
    # ===== UI 属性（WebUI 使用，可选）=====
    input_type: str | None = None      # 控件类型
    label: str | None = None           # 显示标签
    placeholder: str | None = None     # 占位符
    hint: str | None = None            # 提示文字
    icon: str | None = None            # 图标
    # ... 更多 UI 属性
```

### 为什么这样设计？

1. **主程序只读取基础属性**：`_generate_and_save_default_config()` 等方法只使用 `type`, `default`, `description` 等
2. **新属性有默认值**：全部设为 `None` 或合理默认值，现有插件无需改动
3. **WebUI 读取全部属性**：生成配置表单时使用 UI 属性

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          插件层                                  │
│                                                                  │
│  统一导入:                                                       │
│  from src.plugin_system.base.config_types import ConfigField    │
│                                                                  │
│  ┌─────────────────────┐     ┌─────────────────────────────────┐│
│  │ 现有插件（不变）      │     │ 新插件（使用增强属性）          ││
│  │                     │     │                                 ││
│  │ ConfigField(        │     │ ConfigField(                    ││
│  │   type=str,         │     │   type=str,                     ││
│  │   default="",       │     │   default="",                   ││
│  │   description="..." │     │   description="...",            ││
│  │ )                   │     │   input_type="password",  # 新  ││
│  │                     │     │   placeholder="sk-xxx",   # 新  ││
│  │                     │     │   hint="从控制台获取"      # 新  ││
│  │                     │     │ )                               ││
│  └─────────────────────┘     └─────────────────────────────────┘│
└─────────────────────────────────────┬───────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    ▼                                   ▼
┌───────────────────────────────────┐   ┌───────────────────────────────┐
│          主程序                    │   │        WebUI Backend          │
│                                   │   │                               │
│  只读取基础属性：                  │   │  读取全部属性：                │
│  - type, default, description     │   │  - 基础属性                   │
│  - example, required, choices     │   │  - input_type, placeholder    │
│                                   │   │  - hint, icon, min, max...   │
│  忽略 UI 属性（有默认值）          │   │                               │
│                                   │   │  自动推断（如果未指定）：      │
│  用途：                           │   │  bool → switch               │
│  - 生成 TOML 配置文件             │   │  int+min+max → slider        │
│  - 同步配置结构                   │   │  有 choices → select         │
└───────────────────────────────────┘   └───────────────────┬───────────┘
                                                            │
                                                            ▼
                                        ┌───────────────────────────────┐
                                        │       WebUI Frontend          │
                                        │                               │
                                        │  根据 input_type 渲染控件      │
                                        │  应用验证规则 (min, max, ...)  │
                                        │  处理条件显示 (depends_on)     │
                                        │  支持分组和标签页布局          │
                                        └───────────────────────────────┘
```

## 控件推断规则

当 `input_type` 未指定时，WebUI 自动推断：

| 条件 | 推断的 input_type |
|------|-------------------|
| `type=bool` | `switch` |
| `type=int/float` + `min` + `max` | `slider` |
| `type=int/float` | `number` |
| 有 `choices` 列表 | `select` |
| `type=list` | `list` |
| `type=dict` | `json` |
| `type=str`（默认） | `text` |

## 文件修改清单

```
mmc/src/plugin_system/base/
├── config_types.py     # 扩展 ConfigField，新增 ConfigSection 等

MoFox-Core-Webui/backend/
├── schema_parser.py    # Schema 解析器（新增）
└── routers/
    └── plugin_router.py # 添加 /schema 端点
```
