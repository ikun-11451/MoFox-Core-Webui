# 02 - 主程序修改

## 修改文件

`mmc/src/plugin_system/base/config_types.py`

## 完整代码

```python
"""
插件系统配置类型定义

提供配置字段、配置节、布局等类型定义。
支持 WebUI 可视化配置编辑。
"""

from dataclasses import dataclass, field
from typing import Any, Literal


# ==================== 输入类型定义 ====================

InputType = Literal[
    "text",       # 单行文本输入框
    "password",   # 密码输入框（带显示/隐藏切换）
    "textarea",   # 多行文本域
    "number",     # 数字输入框
    "switch",     # 开关切换（布尔值）
    "slider",     # 滑块（需配合 min/max）
    "select",     # 下拉选择（需配合 choices）
    "list",       # 动态列表编辑器（支持拖拽排序）
    "color",      # 颜色选择器
    "code",       # 代码编辑器
    "file",       # 文件上传
    "json",       # JSON 编辑器
]


# ==================== 配置字段定义 ====================

@dataclass(slots=True)
class ConfigField:
    """
    配置字段定义
    
    基础属性由主程序使用（生成配置文件、同步配置）。
    UI 属性由 WebUI 使用（渲染配置表单）。
    
    示例：
    ```python
    config_schema = {
        "api": {
            "key": ConfigField(
                type=str,
                default="",
                description="API 密钥",
                input_type="password",
                placeholder="sk-xxxxxxxx",
                hint="从控制台获取"
            ),
        }
    }
    ```
    """
    
    # ========== 基础属性（主程序使用）==========
    type: type                                  # 字段类型
    default: Any                                # 默认值
    description: str                            # 字段描述
    example: str | None = None                  # 示例值
    required: bool = False                      # 是否必需
    choices: list[Any] | None = field(default_factory=list)  # 可选值列表
    
    # ========== UI 显示控制（WebUI 使用）==========
    input_type: InputType | None = None         # 控件类型，不指定则自动推断
    label: str | None = None                    # 显示标签，默认使用 description
    placeholder: str | None = None              # 输入框占位符
    hint: str | None = None                     # 字段下方的提示文字
    icon: str | None = None                     # 字段图标名称 (Lucide Icons)
    hidden: bool = False                        # 是否在 UI 中隐藏
    disabled: bool = False                      # 是否禁用编辑
    order: int = 0                              # 排序权重，数字越小越靠前
    rows: int = 3                               # textarea 行数
    
    # ========== 验证规则 ==========
    min: float | None = None                    # 最小值（数字类型）
    max: float | None = None                    # 最大值（数字类型）
    step: float | None = None                   # 步进值（数字类型）
    pattern: str | None = None                  # 正则验证（字符串类型）
    max_length: int | None = None               # 最大长度（字符串类型）
    
    # ========== 分组与条件显示 ==========
    group: str | None = None                    # 字段分组，在 section 内再细分
    depends_on: str | None = None               # 依赖的字段路径，如 "section.field"
    depends_value: Any = None                   # 依赖字段需要的值
    
    # ========== 列表类型专用 ==========
    item_type: Literal["string", "number", "object"] | None = None  # 数组元素类型
    item_fields: dict[str, Any] | None = None   # 当 item_type="object" 时的字段定义
    min_items: int | None = None                # 数组最小元素数量
    max_items: int | None = None                # 数组最大元素数量


# ==================== 配置节定义 ====================

@dataclass(slots=True)
class ConfigSection:
    """
    配置节元数据
    
    用于为配置节添加标题、图标、是否默认折叠等信息。
    在 config_section_descriptions 中使用。
    
    示例：
    ```python
    config_section_descriptions = {
        "api": ConfigSection(
            title="API 配置",
            description="外部 API 的连接参数",
            icon="cloud",
            order=1
        ),
        "debug": ConfigSection(
            title="调试选项",
            icon="bug",
            collapsed=True,
            order=99
        ),
    }
    ```
    """
    title: str                                  # 显示标题
    description: str | None = None              # 详细描述
    icon: str | None = None                     # 图标名称 (Lucide Icons)
    collapsed: bool = False                     # 默认是否折叠
    order: int = 0                              # 排序权重


def section_meta(
    title: str,
    description: str | None = None,
    icon: str | None = None,
    collapsed: bool = False,
    order: int = 0
) -> ConfigSection:
    """创建 ConfigSection 的便捷函数"""
    return ConfigSection(
        title=title,
        description=description,
        icon=icon,
        collapsed=collapsed,
        order=order
    )


# ==================== 标签页布局 ====================

@dataclass(slots=True)
class ConfigTab:
    """
    标签页定义
    
    用于将多个 section 组织到一个标签页中。
    
    示例：
    ```python
    config_layout = ConfigLayout(
        type="tabs",
        tabs=[
            ConfigTab(id="main", title="主要设置", sections=["api", "model"]),
            ConfigTab(id="advanced", title="高级", sections=["cache", "debug"]),
        ]
    )
    ```
    """
    id: str                                     # 标签页 ID
    title: str                                  # 显示标题
    sections: list[str] = field(default_factory=list)  # 包含的 section 名称
    icon: str | None = None                     # 图标名称
    order: int = 0                              # 排序权重
    badge: str | None = None                    # 角标文字


@dataclass(slots=True)  
class ConfigLayout:
    """
    页面布局定义
    
    支持的布局类型：
    - auto: 自动布局，section 以可折叠面板显示
    - tabs: 标签页布局，顶部标签切换
    - pages: 分页布局，左侧导航 + 右侧内容（规划中）
    """
    type: Literal["auto", "tabs", "pages"] = "auto"
    tabs: list[ConfigTab] = field(default_factory=list)
```

## 兼容性说明

### 现有插件（无需修改）

```python
# 这段代码继续正常工作
config_schema = {
    "api": {
        "key": ConfigField(
            type=str,
            default="",
            description="API 密钥"
        ),
    }
}
```

新增的属性都有默认值：
- `input_type=None` → WebUI 自动推断
- `label=None` → 使用 description
- `placeholder=None` → 不显示占位符
- `hidden=False` → 正常显示
- ...

### 主程序使用的属性

主程序的 `_generate_and_save_default_config()` 等方法只读取：
- `type` - 生成正确的 TOML 值格式
- `default` - 写入默认值
- `description` - 生成注释
- `example` - 生成示例注释
- `required` - 标记必填
- `choices` - 生成可选值注释

**其他属性会被忽略**，不影响主程序功能。
