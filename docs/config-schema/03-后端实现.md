# 03 - åç«¯å®ç°è®¾è®¡

> æœ¬æ–‡æ¡£æè¿°æ’ä»¶é…ç½®è·¯ç”±ç‹¬ç«‹åŒ–çš„åç«¯æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬è·¯ç”±æ‹†åˆ†ã€Schema è§£ææœåŠ¡ç­‰ã€‚å…¨éƒ¨ä¸ºè®¾è®¡è¯´æ˜ï¼Œæ— ä»£ç ã€‚

---

## ğŸ“Š ç°çŠ¶åˆ†æ

### å½“å‰è·¯ç”±åˆ†å¸ƒ

æ’ä»¶é…ç½®åŠŸèƒ½åˆ†æ•£åœ¨ä¸¤ä¸ªè·¯ç”±æ–‡ä»¶ä¸­ï¼š

| è·¯ç”±æ–‡ä»¶ | ä¸»è¦èŒè´£ | é…ç½®ç›¸å…³åŠŸèƒ½ |
|---------|---------|-------------|
| `plugin_router.py` | æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç† | è·å–æ’ä»¶è¯¦æƒ…æ—¶è¿”å›é…ç½®è·¯å¾„ |
| `config_router.py` | é€šç”¨é…ç½®æ–‡ä»¶ç®¡ç† | è¯»å–/ä¿å­˜/å¤‡ä»½æ’ä»¶é…ç½®æ–‡ä»¶ |

### config_router.py ç°æœ‰ç«¯ç‚¹

| API ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | é€‚ç”¨èŒƒå›´ |
|----------|------|------|---------|
| /list | GET | åˆ—å‡ºæ‰€æœ‰é…ç½®æ–‡ä»¶ | ä¸»é…ç½® + æ¨¡å‹é…ç½® + æ’ä»¶é…ç½® |
| /content/{path} | GET | è¯»å–é…ç½®å†…å®¹ | é€šç”¨ |
| /schema/{path} | GET | è·å–é…ç½®ç»“æ„ | é€šç”¨ï¼ˆä» TOML æ³¨é‡Šè§£æï¼‰ |
| /save/{path} | POST | ä¿å­˜åŸå§‹ TOML | é€šç”¨ |
| /update/{path} | POST | å¯è§†åŒ–æ›´æ–°é…ç½® | é€šç”¨ |
| /backups/{path} | GET | è·å–å¤‡ä»½åˆ—è¡¨ | é€šç”¨ |
| /restore/{path} | POST | ä»å¤‡ä»½æ¢å¤ | é€šç”¨ |
| /validate | POST | éªŒè¯ TOML æ ¼å¼ | é€šç”¨ |

### é—®é¢˜

1. æ’ä»¶é…ç½®ä¸é€šç”¨é…ç½®æ··åœ¨ä¸€èµ·ï¼Œæ— æ³•æ”¯æŒ Schema å¢å¼º
2. Schema åªèƒ½ä» TOML æ³¨é‡Šè§£æï¼Œæ— æ³•è·å–æ’ä»¶å®šä¹‰çš„ä¸°å¯Œå…ƒæ•°æ®
3. æ— æ³•å®ç°ç±»å‹æ¨æ–­ã€æ¡ä»¶æ˜¾ç¤ºç­‰é«˜çº§åŠŸèƒ½

---

## ğŸ¯ ç›®æ ‡æ¶æ„

### æ–‡ä»¶ç»“æ„

```
MoFox-Core-Webui/backend/
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ plugin_schema_service.py   # æ–°å¢ï¼šSchema è§£ææœåŠ¡
â””â”€â”€ routers/
    â”œâ”€â”€ plugin_router.py           # ä¿æŒï¼šæ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
    â”œâ”€â”€ config_router.py           # ä¿æŒï¼šä¸»é…ç½®ã€æ¨¡å‹é…ç½®
    â””â”€â”€ plugin_config_router.py    # æ–°å¢ï¼šæ’ä»¶é…ç½®ä¸“ç”¨è·¯ç”±
```

### èŒè´£åˆ’åˆ†

| æ¨¡å— | è´Ÿè´£å†…å®¹ |
|------|---------|
| `plugin_router.py` | æ’ä»¶åŠ è½½/å¸è½½/å¯ç”¨/ç¦ç”¨/é‡è½½ |
| `config_router.py` | bot_config.tomlã€model_config.toml çš„è¯»å†™ |
| `plugin_config_router.py` | æ’ä»¶é…ç½®çš„å¢å¼ºç®¡ç†ï¼ˆSchema é©±åŠ¨ï¼‰ |
| `plugin_schema_service.py` | ä»æ’ä»¶å®ä¾‹è§£æ config_schema |

---

## ğŸ“ æ–°è·¯ç”± API è®¾è®¡

### è·¯ç”±å‰ç¼€

`/plugin-config`

### ç«¯ç‚¹åˆ—è¡¨

#### åˆ—è¡¨ä¸æŸ¥è¯¢

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/list` | GET | è·å–æ‰€æœ‰æ’ä»¶é…ç½®æ–‡ä»¶åˆ—è¡¨ |
| `/{plugin_name}/content` | GET | è·å–æ’ä»¶é…ç½®å†…å®¹ |
| `/{plugin_name}/schema` | GET | è·å–å¢å¼º Schemaï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ |

#### ä¿å­˜ä¸æ›´æ–°

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/{plugin_name}/save` | POST | ä¿å­˜é…ç½®ï¼ˆåŸå§‹ TOMLï¼‰ |
| `/{plugin_name}/update` | POST | æ›´æ–°é…ç½®ï¼ˆé”®å€¼å¯¹ï¼‰ |
| `/{plugin_name}/reset` | POST | é‡ç½®ä¸ºé»˜è®¤é…ç½® |

#### å¤‡ä»½ç®¡ç†

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/{plugin_name}/backups` | GET | è·å–å¤‡ä»½åˆ—è¡¨ |
| `/{plugin_name}/restore` | POST | ä»å¤‡ä»½æ¢å¤ |

#### é«˜çº§åŠŸèƒ½

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/{plugin_name}/validate` | POST | éªŒè¯é…ç½®å€¼ï¼ˆç±»å‹ã€èŒƒå›´ï¼‰ |
| `/{plugin_name}/export` | GET | å¯¼å‡ºé…ç½® |
| `/{plugin_name}/import` | POST | å¯¼å…¥é…ç½® |

---

## ğŸ”§ Schema è§£ææœåŠ¡

### æœåŠ¡èŒè´£

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| è·å– Schema | ä»å·²åŠ è½½çš„æ’ä»¶å®ä¾‹è¯»å– `config_schema` |
| ç±»å‹æ¨æ–­ | æ ¹æ®å­—æ®µç±»å‹å’Œå±æ€§æ¨æ–­æœ€ä½³ UI æ§ä»¶ |
| Schema è½¬æ¢ | å°† `ConfigField` è½¬æ¢ä¸ºå‰ç«¯å¯ç”¨çš„ JSON |
| æ¡ä»¶è§£æ | å¤„ç† `depends_on` ç­‰æ¡ä»¶æ˜¾ç¤ºè§„åˆ™ |
| å¸ƒå±€ç»„ç»‡ | å¤„ç† Section åˆ†ç»„ã€Tab é¡µå¸ƒå±€ |

### ç±»å‹æ¨æ–­è§„åˆ™

| ä¼˜å…ˆçº§ | æ¡ä»¶ | æ¨æ–­ç»“æœ |
|--------|------|---------|
| 1 | æ˜¾å¼æŒ‡å®š `input_type` | ä½¿ç”¨æŒ‡å®šå€¼ |
| 2 | `type == bool` | switchï¼ˆå¼€å…³ï¼‰ |
| 3 | `type in (int, float)` ä¸”æœ‰ min/max | sliderï¼ˆæ»‘å—ï¼‰ |
| 4 | `type in (int, float)` | numberï¼ˆæ•°å­—è¾“å…¥ï¼‰ |
| 5 | æœ‰ `choices` åˆ—è¡¨ | selectï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰ |
| 6 | `type == list` | listï¼ˆåˆ—è¡¨ç¼–è¾‘å™¨ï¼‰ |
| 7 | `type == dict` | jsonï¼ˆJSON ç¼–è¾‘å™¨ï¼‰ |
| 8 | é»˜è®¤ | textï¼ˆæ–‡æœ¬è¾“å…¥ï¼‰ |

---

## ğŸ“¦ Schema è¾“å‡ºç»“æ„

### é¡¶å±‚ç»“æ„

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | bool | è¯·æ±‚æ˜¯å¦æˆåŠŸ |
| plugin_name | string | æ’ä»¶åç§° |
| schema | object | æŒ‰ section ç»„ç»‡çš„å­—æ®µå®šä¹‰ |
| sections | array | section å…ƒæ•°æ®åˆ—è¡¨ |
| layout | object/null | å¸ƒå±€é…ç½®ï¼ˆTab é¡µç­‰ï¼‰ |

### å­—æ®µ Schema - åŸºç¡€å±æ€§

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| key | string | å­—æ®µå |
| section | string | æ‰€å±é…ç½®èŠ‚ |
| type | string | æ•°æ®ç±»å‹åç§° |
| default | any | é»˜è®¤å€¼ |
| description | string | æè¿° |
| required | bool | æ˜¯å¦å¿…éœ€ |
| choices | array/null | å¯é€‰å€¼åˆ—è¡¨ |
| example | string/null | ç¤ºä¾‹å€¼ |

### å­—æ®µ Schema - UI å±æ€§

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| input_type | string | æ§ä»¶ç±»å‹ï¼ˆæ¨æ–­æˆ–æŒ‡å®šï¼‰ |
| label | string/null | æ˜¾ç¤ºæ ‡ç­¾ |
| placeholder | string/null | å ä½ç¬¦æ–‡æœ¬ |
| hint | string/null | å¸®åŠ©æç¤º |
| icon | string/null | å›¾æ ‡åç§° |
| hidden | bool | æ˜¯å¦éšè— |
| disabled | bool | æ˜¯å¦ç¦ç”¨ |
| order | int | æ’åºæƒé‡ |
| rows | int/null | textarea è¡Œæ•° |

### å­—æ®µ Schema - éªŒè¯å±æ€§

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| min | number/null | æœ€å°å€¼ |
| max | number/null | æœ€å¤§å€¼ |
| step | number/null | æ­¥è¿›å€¼ |
| pattern | string/null | æ­£åˆ™éªŒè¯ |
| max_length | int/null | æœ€å¤§é•¿åº¦ |

### å­—æ®µ Schema - æ¡ä»¶æ˜¾ç¤º

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| group | string/null | åˆ†ç»„åç§° |
| depends_on | string/null | ä¾èµ–å­—æ®µ |
| depends_value | any/null | ä¾èµ–å€¼ |

### å­—æ®µ Schema - åˆ—è¡¨ä¸“ç”¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| item_type | string/null | åˆ—è¡¨é¡¹ç±»å‹ |
| item_fields | object/null | å¤æ‚åˆ—è¡¨é¡¹çš„å­—æ®µå®šä¹‰ |
| min_items | int/null | æœ€å°‘é¡¹æ•° |
| max_items | int/null | æœ€å¤šé¡¹æ•° |

### Section å…ƒæ•°æ®

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| name | string | section åç§° |
| title | string | æ˜¾ç¤ºæ ‡é¢˜ |
| description | string/null | æè¿° |
| icon | string/null | å›¾æ ‡ |
| collapsed | bool | é»˜è®¤æ˜¯å¦æŠ˜å  |
| order | int | æ’åºæƒé‡ |

### å¸ƒå±€é…ç½®

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| type | string | å¸ƒå±€ç±»å‹ï¼ˆtabs/sections/flatï¼‰ |
| tabs | array | Tab é¡µåˆ—è¡¨ |

æ¯ä¸ª Tab åŒ…å«ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | string | Tab æ ‡è¯† |
| title | string | Tab æ ‡é¢˜ |
| sections | array | åŒ…å«çš„ section åç§°åˆ—è¡¨ |
| icon | string/null | å›¾æ ‡ |
| order | int | æ’åº |
| badge | string/null | è§’æ ‡ |

---

## ğŸ”— ä¾èµ–å…³ç³»

### æ¨¡å—è°ƒç”¨é“¾

| è°ƒç”¨æ–¹ | è¢«è°ƒç”¨æ–¹ | ç”¨é€” |
|--------|---------|------|
| plugin_config_router | plugin_manager | è·å–å·²åŠ è½½çš„æ’ä»¶å®ä¾‹ |
| plugin_config_router | plugin_schema_service | è§£æ Schema |
| plugin_schema_service | æ’ä»¶å®ä¾‹ | è¯»å– config_schema å±æ€§ |

### é…ç½®æ–‡ä»¶è·¯å¾„çº¦å®š

| ç±»å‹ | è·¯å¾„æ¨¡å¼ |
|------|---------|
| é…ç½®æ–‡ä»¶ | `config/plugins/{plugin_name}/config.toml` |
| å¤‡ä»½ç›®å½• | `config/plugins/{plugin_name}/backups_from_webui/` |

---

## ğŸ“‹ å“åº”æ¨¡å‹è®¾è®¡

### PluginConfigListResponse

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | bool | æ˜¯å¦æˆåŠŸ |
| configs | array | é…ç½®æ–‡ä»¶åˆ—è¡¨ |
| total | int | æ€»æ•° |

### PluginConfigContentResponse

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | bool | æ˜¯å¦æˆåŠŸ |
| plugin_name | string | æ’ä»¶åç§° |
| content | string/null | åŸå§‹ TOML å†…å®¹ |
| parsed | object/null | è§£æåçš„é…ç½® |
| last_modified | string/null | æœ€åä¿®æ”¹æ—¶é—´ |
| error | string/null | é”™è¯¯ä¿¡æ¯ |

### PluginSchemaResponse

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | bool | æ˜¯å¦æˆåŠŸ |
| plugin_name | string | æ’ä»¶åç§° |
| schema | object/null | å­—æ®µå®šä¹‰ |
| sections | array/null | Section å…ƒæ•°æ® |
| layout | object/null | å¸ƒå±€é…ç½® |
| error | string/null | é”™è¯¯ä¿¡æ¯ |

### PluginConfigSaveResponse

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | bool | æ˜¯å¦æˆåŠŸ |
| message | string/null | æˆåŠŸæ¶ˆæ¯ |
| backup_path | string/null | å¤‡ä»½è·¯å¾„ |
| error | string/null | é”™è¯¯ä¿¡æ¯ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å‘åå…¼å®¹

- ç°æœ‰ `config_router.py` ä¿æŒä¸å˜
- å‰ç«¯å¯é€æ­¥è¿ç§»åˆ°æ–° API
- ä¸¤å¥— API å¯å¹¶è¡Œå­˜åœ¨

### æ€§èƒ½ä¼˜åŒ–

- Schema è§£æç»“æœå¯ç¼“å­˜
- ç›‘å¬æ’ä»¶é‡è½½äº‹ä»¶æ¸…é™¤ç¼“å­˜
- å“åº”ä¸­ç§»é™¤ null å€¼å‡å°‘ä¼ è¾“

### é”™è¯¯å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| æ’ä»¶æœªåŠ è½½ | è¿”å› success=falseï¼Œæç¤ºåŠ è½½æ’ä»¶ |
| é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ | è¿”å›ç©º schemaï¼Œæˆ–è‡ªåŠ¨ç”Ÿæˆé»˜è®¤é…ç½® |
| è§£æé”™è¯¯ | è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯å’Œä½ç½® |

---

## ğŸ“ å®æ–½æ­¥éª¤

| é˜¶æ®µ | å†…å®¹ |
|------|------|
| 1 | åˆ›å»º `plugin_schema_service.py`ï¼Œå®ç° Schema è§£æ |
| 2 | åˆ›å»º `plugin_config_router.py`ï¼Œå®ç°åŸºç¡€ç«¯ç‚¹ |
| 3 | æ·»åŠ  Schema ç«¯ç‚¹ï¼Œå¯¹æ¥è§£ææœåŠ¡ |
| 4 | å®ç°å¤‡ä»½ã€é‡ç½®ç­‰é«˜çº§åŠŸèƒ½ |
| 5 | å‰ç«¯å¯¹æ¥æ–° API |
