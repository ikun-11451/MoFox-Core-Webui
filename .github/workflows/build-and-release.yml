name: Build and Release Frontend

on:

  # 每天零点自动触发
  schedule:
    - cron: '0 0 * * *'

  # 允许手动触发
  workflow_dispatch:

  # 工作流文件自身有变动时自动触发
  push:
    paths:
      - '.github/workflows/build-and-release.yml'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for new commits
        id: check_commits
        run: |
          # 获取最新的 release tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No previous release found, will build"
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
          else
            # 检查从上次 release 到现在是否有新提交
            COMMITS_SINCE_LAST=$(git rev-list ${LATEST_TAG}..HEAD --count)
            echo "Commits since last release (${LATEST_TAG}): ${COMMITS_SINCE_LAST}"
            
            if [ "$COMMITS_SINCE_LAST" -gt "0" ]; then
              echo "has_new_commits=true" >> $GITHUB_OUTPUT
              echo "Found ${COMMITS_SINCE_LAST} new commits, will build"
            else
              echo "has_new_commits=false" >> $GITHUB_OUTPUT
              echo "No new commits since last release, skipping build"
            fi
          fi
          
          # 如果是手动触发，总是构建
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
            echo "Manual trigger detected, will build regardless"
          fi
      
      - name: Skip if no new commits
        if: steps.check_commits.outputs.has_new_commits != 'true'
        run: |
          echo "No new commits since last release, exiting workflow"
          exit 0
      
      - name: Setup Node.js
        if: steps.check_commits.outputs.has_new_commits == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: forward/mofox-webui/package-lock.json
      
      - name: Install dependencies
        if: steps.check_commits.outputs.has_new_commits == 'true'
        run: |
          cd forward/mofox-webui
          npm ci
      
      - name: Build frontend
        if: steps.check_commits.outputs.has_new_commits == 'true'
        run: |
          cd forward/mofox-webui
          npm run build
      
      - name: Prepare release package
        if: steps.check_commits.outputs.has_new_commits == 'true'
        run: |
          # 创建backend/static目录
          mkdir -p backend/static
          # 复制编译产物到backend/static
          cp -r forward/mofox-webui/dist/* backend/static/
          # 创建一个标记文件表示构建时间
          echo "Built at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > backend/static/BUILD_INFO.txt
          echo "Commit: ${{ github.sha }}" >> backend/static/BUILD_INFO.txt
          echo "Branch: ${{ github.ref_name }}" >> backend/static/BUILD_INFO.txt
      
      - name: Create ZIP archive
        if: steps.check_commits.outputs.has_new_commits == 'true'
        run: |
          # 打包整个backend目录(包括所有Python文件和编译好的前端)
          zip -r mofox-webui-backend.zip backend/ -x "backend/__pycache__/*" -x "backend/*.pyc"
      
      - name: Generate version tag
        if: steps.check_commits.outputs.has_new_commits == 'true'
        id: version
        run: |
          # 使用日期作为版本号: v年.月日.时分
          VERSION="v$(date -u '+%Y.%m%d.%H%M')"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Create Release
        if: steps.check_commits.outputs.has_new_commits == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: MoFox WebUI Backend ${{ steps.version.outputs.VERSION }}
          body: |
            ## MoFox WebUI 完整后端插件包
            
            **构建时间**: ${{ github.event.repository.updated_at }}
            **构建分支**: ${{ github.ref_name }}
            **Commit**: ${{ github.sha }}
            
            ### 使用说明
            
            1. 下载 `mofox-webui-backend.zip`
            2. 解压到 MoFox-Bot 的插件目录: `<MoFox-Bot>/plugins/`
            3. 将解压出的 `backend` 文件夹重命名为 `webui_backend`
            4. 完整路径应为: `<MoFox-Bot>/plugins/webui_backend/`
            5. 配置 `bot_config.toml` 中的 API Key
            6. 重启 MoFox-Bot，访问 http://localhost:12138 即可使用
            
            ### 包含内容
            
            - **完整后端插件代码** (所有 Python 文件)
              - `plugin.py` - 主插件类
              - `discovery_server.py` - 发现服务器
              - `handlers/` - 事件处理器
              - `routers/` - API 路由
            - **编译好的前端静态文件** (`backend/static/`)
              - `index.html` - 前端入口
              - `assets/` - 静态资源
              - `BUILD_INFO.txt` - 构建信息
            
            ### 目录结构
            
            ```
            webui_backend/
            ├── __init__.py
            ├── plugin.py
            ├── discovery_server.py
            ├── static/              # 前端静态文件
            │   ├── index.html
            │   └── assets/
            ├── handlers/
            │   ├── startup_handler.py
            │   └── shutdown_handler.py
            └── routers/
                ├── auth.py
                ├── config_mgmt.py
                ├── plugin_mgmt.py
                └── ...
            ```
            
            ---
            
            此版本为自动构建发布，包含完整的后端插件和编译好的前端。如有问题请提交 Issue。
          files: |
            mofox-webui-backend.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cleanup old releases
        if: steps.check_commits.outputs.has_new_commits == 'true'
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 7
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
